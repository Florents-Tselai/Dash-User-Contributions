<!DOCTYPE html>

<html class="no-js" data-content_root="./" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="light dark" name="color-scheme"/><meta content="width=device-width, initial-scale=1" name="viewport">
<link href="genindex.html" rel="index" title="Index"/><link href="search.html" rel="search" title="Search"/><link href="plugins.html" rel="next" title="Plugins"/><link href="cli.html" rel="prev" title="sqlite-utils command-line tool"/>
<!-- Generated with Sphinx 7.2.6 and Furo 2023.09.10 -->
<script data-domain="sqlite-utils.datasette.io" defer="" src="https://plausible.io/js/plausible.js"></script>
<title>sqlite_utils Python library - sqlite-utils</title>
<link href="_static/pygments.css?v=fa44fd50" rel="stylesheet" type="text/css"/>
<link href="_static/styles/furo.css?v=135e06be" rel="stylesheet" type="text/css"/>
<link href="_static/copybutton.css?v=76b2166b" rel="stylesheet" type="text/css"/>
<link href="_static/styles/furo-extensions.css?v=36a5483c" rel="stylesheet" type="text/css"/>
<style>
  body {
    --color-code-background: #eeffcc;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></meta></head>
<body>
<script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
<svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
<symbol id="svg-toc" viewbox="0 0 24 24">
<title>Contents</title>
<svg fill="currentColor" stroke="currentColor" stroke-width="0" viewbox="0 0 1024 1024">
<path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"></path>
</svg>
</symbol>
<symbol id="svg-menu" viewbox="0 0 24 24">
<title>Menu</title>
<svg class="feather-menu" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<line x1="3" x2="21" y1="12" y2="12"></line>
<line x1="3" x2="21" y1="6" y2="6"></line>
<line x1="3" x2="21" y1="18" y2="18"></line>
</svg>
</symbol>
<symbol id="svg-arrow-right" viewbox="0 0 24 24">
<title>Expand</title>
<svg class="feather-chevron-right" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<polyline points="9 18 15 12 9 6"></polyline>
</svg>
</symbol>
<symbol id="svg-sun" viewbox="0 0 24 24">
<title>Light mode</title>
<svg class="feather-sun" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<circle cx="12" cy="12" r="5"></circle>
<line x1="12" x2="12" y1="1" y2="3"></line>
<line x1="12" x2="12" y1="21" y2="23"></line>
<line x1="4.22" x2="5.64" y1="4.22" y2="5.64"></line>
<line x1="18.36" x2="19.78" y1="18.36" y2="19.78"></line>
<line x1="1" x2="3" y1="12" y2="12"></line>
<line x1="21" x2="23" y1="12" y2="12"></line>
<line x1="4.22" x2="5.64" y1="19.78" y2="18.36"></line>
<line x1="18.36" x2="19.78" y1="5.64" y2="4.22"></line>
</svg>
</symbol>
<symbol id="svg-moon" viewbox="0 0 24 24">
<title>Dark mode</title>
<svg class="icon-tabler-moon" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M0 0h24v24H0z" fill="none" stroke="none"></path>
<path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
</svg>
</symbol>
<symbol id="svg-sun-half" viewbox="0 0 24 24">
<title>Auto light/dark mode</title>
<svg class="icon-tabler-shadow" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M0 0h24v24H0z" fill="none" stroke="none"></path>
<circle cx="12" cy="12" r="9"></circle>
<path d="M13 12h5"></path>
<path d="M13 15h4"></path>
<path d="M13 18h1"></path>
<path d="M13 9h4"></path>
<path d="M13 6h1"></path>
</svg>
</symbol>
</svg>
<input class="sidebar-toggle" id="__navigation" name="__navigation" type="checkbox"/>
<input class="sidebar-toggle" id="__toc" name="__toc" type="checkbox"/>
<label class="overlay sidebar-overlay" for="__navigation">
<div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
<div class="visually-hidden">Hide table of contents sidebar</div>
</label>
<div class="page">
<header class="mobile-header">
<div class="header-left">
<label class="nav-overlay-icon" for="__navigation">
<div class="visually-hidden">Toggle site navigation sidebar</div>
<i class="icon"><svg><use href="#svg-menu"></use></svg></i>
</label>
</div>
<div class="header-center">
<a href="index.html"><div class="brand">sqlite-utils</div></a>
</div>
<div class="header-right">
<div class="theme-toggle-container theme-toggle-header">
<button class="theme-toggle">
<div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
<svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
<svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
<svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
</button>
</div>
<label class="toc-overlay-icon toc-header-icon" for="__toc">
<div class="visually-hidden">Toggle table of contents sidebar</div>
<i class="icon"><svg><use href="#svg-toc"></use></svg></i>
</label>
</div>
</header>
<aside class="sidebar-drawer">
<div class="sidebar-container">
<div class="sidebar-sticky"><a class="sidebar-brand" href="index.html">
<span class="sidebar-brand-text">sqlite-utils</span>
</a><form action="search.html" class="sidebar-search-container" method="get" role="search">
<input aria-label="Search" class="sidebar-search" name="q" placeholder="Search"/>
<input name="check_keywords" type="hidden" value="yes"/>
<input name="area" type="hidden" value="default"/>
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="cli.html">sqlite-utils command-line tool</a></li>
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">sqlite_utils Python library</a></li>
<li class="toctree-l1"><a class="reference internal" href="plugins.html">Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="reference.html">API reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="cli-reference.html">CLI reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="changelog.html">Changelog</a></li>
</ul>
</div>
</div>
</div>
</div>
</aside>
<div class="main">
<div class="content">
<div class="article-container">
<a class="back-to-top muted-link" href="#">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
</svg>
<span>Back to top</span>
</a>
<div class="content-icon-container">
<div class="theme-toggle-container theme-toggle-content">
<button class="theme-toggle">
<div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
<svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
<svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
<svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
</button>
</div>
<label class="toc-overlay-icon toc-content-icon" for="__toc">
<div class="visually-hidden">Toggle table of contents sidebar</div>
<i class="icon"><svg><use href="#svg-toc"></use></svg></i>
</label>
</div>
<article role="main">
<section id="sqlite-utils-python-library">
<a class="dashAnchor" name="//apple_ref/cpp/Section/sqlite_utils Python library"></a><span id="python-api"></span><h1>sqlite_utils Python library<a class="headerlink" href="#sqlite-utils-python-library" title="Link to this heading">#</a></h1>
<nav class="contents this-will-duplicate-information-and-it-is-still-useful-here local" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#getting-started" id="id1">Getting started</a></p></li>
<li><p><a class="reference internal" href="#connecting-to-or-creating-a-database" id="id2">Connecting to or creating a database</a></p>
<ul>
<li><p><a class="reference internal" href="#attaching-additional-databases" id="id3">Attaching additional databases</a></p></li>
<li><p><a class="reference internal" href="#tracing-queries" id="id4">Tracing queries</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#executing-queries" id="id5">Executing queries</a></p>
<ul>
<li><p><a class="reference internal" href="#db-query-sql-params" id="id6">db.query(sql, params)</a></p></li>
<li><p><a class="reference internal" href="#db-execute-sql-params" id="id7">db.execute(sql, params)</a></p></li>
<li><p><a class="reference internal" href="#passing-parameters" id="id8">Passing parameters</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#accessing-tables" id="id9">Accessing tables</a></p></li>
<li><p><a class="reference internal" href="#listing-tables" id="id10">Listing tables</a></p></li>
<li><p><a class="reference internal" href="#listing-views" id="id11">Listing views</a></p></li>
<li><p><a class="reference internal" href="#listing-rows" id="id12">Listing rows</a></p>
<ul>
<li><p><a class="reference internal" href="#counting-rows" id="id13">Counting rows</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#listing-rows-with-their-primary-keys" id="id14">Listing rows with their primary keys</a></p></li>
<li><p><a class="reference internal" href="#retrieving-a-specific-record" id="id15">Retrieving a specific record</a></p></li>
<li><p><a class="reference internal" href="#showing-the-schema" id="id16">Showing the schema</a></p></li>
<li><p><a class="reference internal" href="#creating-tables" id="id17">Creating tables</a></p>
<ul>
<li><p><a class="reference internal" href="#custom-column-order-and-column-types" id="id18">Custom column order and column types</a></p></li>
<li><p><a class="reference internal" href="#explicitly-creating-a-table" id="id19">Explicitly creating a table</a></p></li>
<li><p><a class="reference internal" href="#compound-primary-keys" id="id20">Compound primary keys</a></p></li>
<li><p><a class="reference internal" href="#specifying-foreign-keys" id="id21">Specifying foreign keys</a></p></li>
<li><p><a class="reference internal" href="#table-configuration-options" id="id22">Table configuration options</a></p></li>
<li><p><a class="reference internal" href="#setting-defaults-and-not-null-constraints" id="id23">Setting defaults and not null constraints</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#renaming-a-table" id="id24">Renaming a table</a></p></li>
<li><p><a class="reference internal" href="#duplicating-tables" id="id25">Duplicating tables</a></p></li>
<li><p><a class="reference internal" href="#bulk-inserts" id="id26">Bulk inserts</a></p></li>
<li><p><a class="reference internal" href="#insert-replacing-data" id="id27">Insert-replacing data</a></p></li>
<li><p><a class="reference internal" href="#updating-a-specific-record" id="id28">Updating a specific record</a></p></li>
<li><p><a class="reference internal" href="#deleting-a-specific-record" id="id29">Deleting a specific record</a></p></li>
<li><p><a class="reference internal" href="#deleting-multiple-records" id="id30">Deleting multiple records</a></p></li>
<li><p><a class="reference internal" href="#upserting-data" id="id31">Upserting data</a></p></li>
<li><p><a class="reference internal" href="#converting-data-in-columns" id="id32">Converting data in columns</a></p></li>
<li><p><a class="reference internal" href="#working-with-lookup-tables" id="id33">Working with lookup tables</a></p>
<ul>
<li><p><a class="reference internal" href="#creating-lookup-tables-explicitly" id="id34">Creating lookup tables explicitly</a></p></li>
<li><p><a class="reference internal" href="#populating-lookup-tables-automatically-during-insert-upsert" id="id35">Populating lookup tables automatically during insert/upsert</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#working-with-many-to-many-relationships" id="id36">Working with many-to-many relationships</a></p>
<ul>
<li><p><a class="reference internal" href="#using-m2m-and-lookup-tables-together" id="id37">Using m2m and lookup tables together</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#analyzing-a-column" id="id38">Analyzing a column</a></p></li>
<li><p><a class="reference internal" href="#adding-columns" id="id39">Adding columns</a></p></li>
<li><p><a class="reference internal" href="#adding-columns-automatically-on-insert-update" id="id40">Adding columns automatically on insert/update</a></p></li>
<li><p><a class="reference internal" href="#adding-foreign-key-constraints" id="id41">Adding foreign key constraints</a></p>
<ul>
<li><p><a class="reference internal" href="#adding-multiple-foreign-key-constraints-at-once" id="id42">Adding multiple foreign key constraints at once</a></p></li>
<li><p><a class="reference internal" href="#adding-indexes-for-all-foreign-keys" id="id43">Adding indexes for all foreign keys</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#dropping-a-table-or-view" id="id44">Dropping a table or view</a></p></li>
<li><p><a class="reference internal" href="#transforming-a-table" id="id45">Transforming a table</a></p>
<ul>
<li><p><a class="reference internal" href="#altering-column-types" id="id46">Altering column types</a></p></li>
<li><p><a class="reference internal" href="#renaming-columns" id="id47">Renaming columns</a></p></li>
<li><p><a class="reference internal" href="#dropping-columns" id="id48">Dropping columns</a></p></li>
<li><p><a class="reference internal" href="#changing-primary-keys" id="id49">Changing primary keys</a></p></li>
<li><p><a class="reference internal" href="#changing-not-null-status" id="id50">Changing not null status</a></p></li>
<li><p><a class="reference internal" href="#altering-column-defaults" id="id51">Altering column defaults</a></p></li>
<li><p><a class="reference internal" href="#changing-column-order" id="id52">Changing column order</a></p></li>
<li><p><a class="reference internal" href="#dropping-foreign-key-constraints" id="id53">Dropping foreign key constraints</a></p></li>
<li><p><a class="reference internal" href="#custom-transformations-with-transform-sql" id="id54">Custom transformations with .transform_sql()</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#extracting-columns-into-a-separate-table" id="id55">Extracting columns into a separate table</a></p></li>
<li><p><a class="reference internal" href="#setting-an-id-based-on-the-hash-of-the-row-contents" id="id56">Setting an ID based on the hash of the row contents</a></p></li>
<li><p><a class="reference internal" href="#creating-views" id="id57">Creating views</a></p></li>
<li><p><a class="reference internal" href="#storing-json" id="id58">Storing JSON</a></p></li>
<li><p><a class="reference internal" href="#converting-column-values-using-sql-functions" id="id59">Converting column values using SQL functions</a></p></li>
<li><p><a class="reference internal" href="#checking-the-sqlite-version" id="id60">Checking the SQLite version</a></p></li>
<li><p><a class="reference internal" href="#dumping-the-database-to-sql" id="id61">Dumping the database to SQL</a></p></li>
<li><p><a class="reference internal" href="#introspecting-tables-and-views" id="id62">Introspecting tables and views</a></p>
<ul>
<li><p><a class="reference internal" href="#exists" id="id63">.exists()</a></p></li>
<li><p><a class="reference internal" href="#count" id="id64">.count</a></p></li>
<li><p><a class="reference internal" href="#columns" id="id65">.columns</a></p></li>
<li><p><a class="reference internal" href="#columns-dict" id="id66">.columns_dict</a></p></li>
<li><p><a class="reference internal" href="#default-values" id="id67">.default_values</a></p></li>
<li><p><a class="reference internal" href="#pks" id="id68">.pks</a></p></li>
<li><p><a class="reference internal" href="#use-rowid" id="id69">.use_rowid</a></p></li>
<li><p><a class="reference internal" href="#foreign-keys" id="id70">.foreign_keys</a></p></li>
<li><p><a class="reference internal" href="#schema" id="id71">.schema</a></p></li>
<li><p><a class="reference internal" href="#strict" id="id72">.strict</a></p></li>
<li><p><a class="reference internal" href="#indexes" id="id73">.indexes</a></p></li>
<li><p><a class="reference internal" href="#xindexes" id="id74">.xindexes</a></p></li>
<li><p><a class="reference internal" href="#triggers" id="id75">.triggers</a></p></li>
<li><p><a class="reference internal" href="#triggers-dict" id="id76">.triggers_dict</a></p></li>
<li><p><a class="reference internal" href="#detect-fts" id="id77">.detect_fts()</a></p></li>
<li><p><a class="reference internal" href="#virtual-table-using" id="id78">.virtual_table_using</a></p></li>
<li><p><a class="reference internal" href="#has-counts-triggers" id="id79">.has_counts_triggers</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#full-text-search" id="id80">Full-text search</a></p>
<ul>
<li><p><a class="reference internal" href="#enabling-full-text-search-for-a-table" id="id81">Enabling full-text search for a table</a></p></li>
<li><p><a class="reference internal" href="#quoting-characters-for-use-in-search" id="id82">Quoting characters for use in search</a></p></li>
<li><p><a class="reference internal" href="#searching-with-table-search" id="id83">Searching with table.search()</a></p></li>
<li><p><a class="reference internal" href="#building-sql-queries-with-table-search-sql" id="id84">Building SQL queries with table.search_sql()</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#rebuilding-a-full-text-search-table" id="id85">Rebuilding a full-text search table</a></p></li>
<li><p><a class="reference internal" href="#optimizing-a-full-text-search-table" id="id86">Optimizing a full-text search table</a></p></li>
<li><p><a class="reference internal" href="#cached-table-counts-using-triggers" id="id87">Cached table counts using triggers</a></p></li>
<li><p><a class="reference internal" href="#creating-indexes" id="id88">Creating indexes</a></p></li>
<li><p><a class="reference internal" href="#optimizing-index-usage-with-analyze" id="id89">Optimizing index usage with ANALYZE</a></p></li>
<li><p><a class="reference internal" href="#vacuum" id="id90">Vacuum</a></p></li>
<li><p><a class="reference internal" href="#wal-mode" id="id91">WAL mode</a></p></li>
<li><p><a class="reference internal" href="#suggesting-column-types" id="id92">Suggesting column types</a></p></li>
<li><p><a class="reference internal" href="#registering-custom-sql-functions" id="id93">Registering custom SQL functions</a></p></li>
<li><p><a class="reference internal" href="#quoting-strings-for-use-in-sql" id="id94">Quoting strings for use in SQL</a></p></li>
<li><p><a class="reference internal" href="#reading-rows-from-a-file" id="id95">Reading rows from a file</a></p></li>
<li><p><a class="reference internal" href="#setting-the-maximum-csv-field-size-limit" id="id96">Setting the maximum CSV field size limit</a></p></li>
<li><p><a class="reference internal" href="#detecting-column-types-using-typetracker" id="id97">Detecting column types using TypeTracker</a></p></li>
<li><p><a class="reference internal" href="#spatialite-helpers" id="id98">SpatiaLite helpers</a></p>
<ul>
<li><p><a class="reference internal" href="#initialize-spatialite" id="id99">Initialize SpatiaLite</a></p></li>
<li><p><a class="reference internal" href="#finding-spatialite" id="id100">Finding SpatiaLite</a></p></li>
<li><p><a class="reference internal" href="#adding-geometry-columns" id="id101">Adding geometry columns</a></p></li>
<li><p><a class="reference internal" href="#creating-a-spatial-index" id="id102">Creating a spatial index</a></p></li>
</ul>
</li>
</ul>
</nav>
<section id="getting-started">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Getting started"></a><span id="python-api-getting-started"></span><h2><a class="toc-backref" href="#id1" role="doc-backlink">Getting started</a><a class="headerlink" href="#getting-started" title="Link to this heading">#</a></h2>
<p>Here’s how to create a new SQLite database file containing a new <code class="docutils literal notranslate"><span class="pre">chickens</span></code> table, populated with four records:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlite_utils</span> <span class="kn">import</span> <span class="n">Database</span>

<span class="n">db</span> <span class="o">=</span> <span class="n">Database</span><span class="p">(</span><span class="s2">"chickens.db"</span><span class="p">)</span>
<span class="n">db</span><span class="p">[</span><span class="s2">"chickens"</span><span class="p">]</span><span class="o">.</span><span class="n">insert_all</span><span class="p">([{</span>
    <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"Azi"</span><span class="p">,</span>
    <span class="s2">"color"</span><span class="p">:</span> <span class="s2">"blue"</span><span class="p">,</span>
<span class="p">},</span> <span class="p">{</span>
    <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"Lila"</span><span class="p">,</span>
    <span class="s2">"color"</span><span class="p">:</span> <span class="s2">"blue"</span><span class="p">,</span>
<span class="p">},</span> <span class="p">{</span>
    <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"Suna"</span><span class="p">,</span>
    <span class="s2">"color"</span><span class="p">:</span> <span class="s2">"gold"</span><span class="p">,</span>
<span class="p">},</span> <span class="p">{</span>
    <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"Cardi"</span><span class="p">,</span>
    <span class="s2">"color"</span><span class="p">:</span> <span class="s2">"black"</span><span class="p">,</span>
<span class="p">}])</span>
</pre></div>
</div>
<p>You can loop through those rows like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">[</span><span class="s2">"chickens"</span><span class="p">]</span><span class="o">.</span><span class="n">rows</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
</pre></div>
</div>
<p>Which outputs the following:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>{'name': 'Azi', 'color': 'blue'}
{'name': 'Lila', 'color': 'blue'}
{'name': 'Suna', 'color': 'gold'}
{'name': 'Cardi', 'color': 'black'}
</pre></div>
</div>
<p>To run a SQL query, use <a class="reference internal" href="#python-api-query"><span class="std std-ref">db.query()</span></a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">"""</span>
<span class="s2">    select color, count(*)</span>
<span class="s2">    from chickens group by color</span>
<span class="s2">    order by count(*) desc</span>
<span class="s2">"""</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
</pre></div>
</div>
<p>Which outputs:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>{'color': 'blue', 'count(*)': 2}
{'color': 'gold', 'count(*)': 1}
{'color': 'black', 'count(*)': 1}
</pre></div>
</div>
</section>
<section id="connecting-to-or-creating-a-database">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Connecting to or creating a database"></a><span id="python-api-connect"></span><h2><a class="toc-backref" href="#id2" role="doc-backlink">Connecting to or creating a database</a><a class="headerlink" href="#connecting-to-or-creating-a-database" title="Link to this heading">#</a></h2>
<p>Database objects are constructed by passing in either a path to a file on disk or an existing SQLite3 database connection:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlite_utils</span> <span class="kn">import</span> <span class="n">Database</span>

<span class="n">db</span> <span class="o">=</span> <span class="n">Database</span><span class="p">(</span><span class="s2">"my_database.db"</span><span class="p">)</span>
</pre></div>
</div>
<p>This will create <code class="docutils literal notranslate"><span class="pre">my_database.db</span></code> if it does not already exist.</p>
<p>If you want to recreate a database from scratch (first removing the existing file from disk if it already exists) you can use the <code class="docutils literal notranslate"><span class="pre">recreate=True</span></code> argument:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">Database</span><span class="p">(</span><span class="s2">"my_database.db"</span><span class="p">,</span> <span class="n">recreate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>Instead of a file path you can pass in an existing SQLite connection:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sqlite3</span>

<span class="n">db</span> <span class="o">=</span> <span class="n">Database</span><span class="p">(</span><span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">"my_database.db"</span><span class="p">))</span>
</pre></div>
</div>
<p>If you want to create an in-memory database, you can do so like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">Database</span><span class="p">(</span><span class="n">memory</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>You can also create a named in-memory database. Unlike regular memory databases these can be accessed by multiple threads, provided at least one reference to the database still exists. <cite>del db</cite> will clear the database from memory.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">Database</span><span class="p">(</span><span class="n">memory_name</span><span class="o">=</span><span class="s2">"my_shared_database"</span><span class="p">)</span>
</pre></div>
</div>
<p>Connections use <code class="docutils literal notranslate"><span class="pre">PRAGMA</span> <span class="pre">recursive_triggers=on</span></code> by default. If you don’t want to use <a class="reference external" href="https://www.sqlite.org/pragma.html#pragma_recursive_triggers">recursive triggers</a> you can turn them off using:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">Database</span><span class="p">(</span><span class="n">memory</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">recursive_triggers</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<section id="attaching-additional-databases">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Attaching additional databases"></a><span id="python-api-attach"></span><h3><a class="toc-backref" href="#id3" role="doc-backlink">Attaching additional databases</a><a class="headerlink" href="#attaching-additional-databases" title="Link to this heading">#</a></h3>
<p>SQLite supports cross-database SQL queries, which can join data from tables in more than one database file.</p>
<p>You can attach an additional database using the <code class="docutils literal notranslate"><span class="pre">.attach()</span></code> method, providing an alias to use for that database and the path to the SQLite file on disk.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">Database</span><span class="p">(</span><span class="s2">"first.db"</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="s2">"second"</span><span class="p">,</span> <span class="s2">"second.db"</span><span class="p">)</span>
<span class="c1"># Now you can run queries like this one:</span>
<span class="nb">print</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">"""</span>
<span class="s2">select * from table_in_first</span>
<span class="s2">    union all</span>
<span class="s2">select * from second.table_in_second</span>
<span class="s2">"""</span><span class="p">))</span>
</pre></div>
</div>
<p>You can reference tables in the attached database using the alias value you passed to <code class="docutils literal notranslate"><span class="pre">db.attach(alias,</span> <span class="pre">filepath)</span></code> as a prefix, for example the <code class="docutils literal notranslate"><span class="pre">second.table_in_second</span></code> reference in the SQL query above.</p>
</section>
<section id="tracing-queries">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Tracing queries"></a><span id="python-api-tracing"></span><h3><a class="toc-backref" href="#id4" role="doc-backlink">Tracing queries</a><a class="headerlink" href="#tracing-queries" title="Link to this heading">#</a></h3>
<p>You can use the <code class="docutils literal notranslate"><span class="pre">tracer</span></code> mechanism to see SQL queries that are being executed by SQLite. A tracer is a function that you provide which will be called with <code class="docutils literal notranslate"><span class="pre">sql</span></code> and <code class="docutils literal notranslate"><span class="pre">params</span></code> arguments every time SQL is executed, for example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">tracer</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"SQL: </span><span class="si">{}</span><span class="s2"> - params: </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">params</span><span class="p">))</span>
</pre></div>
</div>
<p>You can pass this function to the <code class="docutils literal notranslate"><span class="pre">Database()</span></code> constructor like so:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">Database</span><span class="p">(</span><span class="n">memory</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">tracer</span><span class="o">=</span><span class="n">tracer</span><span class="p">)</span>
</pre></div>
</div>
<p>You can also turn on a tracer function temporarily for a block of code using the <code class="docutils literal notranslate"><span class="pre">with</span> <span class="pre">db.tracer(...)</span></code> context manager:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">Database</span><span class="p">(</span><span class="n">memory</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1"># ... later</span>
<span class="k">with</span> <span class="n">db</span><span class="o">.</span><span class="n">tracer</span><span class="p">(</span><span class="nb">print</span><span class="p">):</span>
    <span class="n">db</span><span class="p">[</span><span class="s2">"dogs"</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">({</span><span class="s2">"name"</span><span class="p">:</span> <span class="s2">"Cleo"</span><span class="p">})</span>
</pre></div>
</div>
<p>This example will print queries only for the duration of the <code class="docutils literal notranslate"><span class="pre">with</span></code> block.</p>
</section>
</section>
<section id="executing-queries">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Executing queries"></a><span id="python-api-executing-queries"></span><h2><a class="toc-backref" href="#id5" role="doc-backlink">Executing queries</a><a class="headerlink" href="#executing-queries" title="Link to this heading">#</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">Database</span></code> class offers several methods for directly executing SQL queries.</p>
<section id="db-query-sql-params">
<a class="dashAnchor" name="//apple_ref/cpp/Section/db.query(sql, params)"></a><span id="python-api-query"></span><h3><a class="toc-backref" href="#id6" role="doc-backlink">db.query(sql, params)</a><a class="headerlink" href="#db-query-sql-params" title="Link to this heading">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">db.query(sql)</span></code> function executes a SQL query and returns an iterator over Python dictionaries representing the resulting rows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">Database</span><span class="p">(</span><span class="n">memory</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">db</span><span class="p">[</span><span class="s2">"dogs"</span><span class="p">]</span><span class="o">.</span><span class="n">insert_all</span><span class="p">([{</span><span class="s2">"name"</span><span class="p">:</span> <span class="s2">"Cleo"</span><span class="p">},</span> <span class="p">{</span><span class="s2">"name"</span><span class="p">:</span> <span class="s2">"Pancakes"</span><span class="p">}])</span>
<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">"select * from dogs"</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
<span class="c1"># Outputs:</span>
<span class="c1"># {'name': 'Cleo'}</span>
<span class="c1"># {'name': 'Pancakes'}</span>
</pre></div>
</div>
</section>
<section id="db-execute-sql-params">
<a class="dashAnchor" name="//apple_ref/cpp/Section/db.execute(sql, params)"></a><span id="python-api-execute"></span><h3><a class="toc-backref" href="#id7" role="doc-backlink">db.execute(sql, params)</a><a class="headerlink" href="#db-execute-sql-params" title="Link to this heading">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">db.execute()</span></code> and <code class="docutils literal notranslate"><span class="pre">db.executescript()</span></code> methods provide wrappers around <code class="docutils literal notranslate"><span class="pre">.execute()</span></code> and <code class="docutils literal notranslate"><span class="pre">.executescript()</span></code> on the underlying SQLite connection. These wrappers log to the <a class="reference internal" href="#python-api-tracing"><span class="std std-ref">tracer function</span></a> if one has been registered.</p>
<p><code class="docutils literal notranslate"><span class="pre">db.execute(sql)</span></code> returns a <a class="reference external" href="https://docs.python.org/3/library/sqlite3.html#sqlite3.Cursor">sqlite3.Cursor</a> that was used to execute the SQL.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">Database</span><span class="p">(</span><span class="n">memory</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">db</span><span class="p">[</span><span class="s2">"dogs"</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">({</span><span class="s2">"name"</span><span class="p">:</span> <span class="s2">"Cleo"</span><span class="p">})</span>
<span class="n">cursor</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">"update dogs set name = 'Cleopaws'"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">cursor</span><span class="o">.</span><span class="n">rowcount</span><span class="p">)</span>
<span class="c1"># Outputs the number of rows affected by the update</span>
<span class="c1"># In this case 2</span>
</pre></div>
</div>
<p>Other cursor methods such as <code class="docutils literal notranslate"><span class="pre">.fetchone()</span></code> and <code class="docutils literal notranslate"><span class="pre">.fetchall()</span></code> are also available, see the <a class="reference external" href="https://docs.python.org/3/library/sqlite3.html#sqlite3.Cursor">standard library documentation</a>.</p>
</section>
<section id="passing-parameters">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Passing parameters"></a><span id="python-api-parameters"></span><h3><a class="toc-backref" href="#id8" role="doc-backlink">Passing parameters</a><a class="headerlink" href="#passing-parameters" title="Link to this heading">#</a></h3>
<p>Both <code class="docutils literal notranslate"><span class="pre">db.query()</span></code> and <code class="docutils literal notranslate"><span class="pre">db.execute()</span></code> accept an optional second argument for parameters to be passed to the SQL query.</p>
<p>This can take the form of either a tuple/list or a dictionary, depending on the type of parameters used in the query. Values passed in this way will be correctly quoted and escaped, helping avoid SQL injection vulnerabilities.</p>
<p><code class="docutils literal notranslate"><span class="pre">?</span></code> parameters in the SQL query can be filled in using a list:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">"update dogs set name = ?"</span><span class="p">,</span> <span class="p">[</span><span class="s2">"Cleopaws"</span><span class="p">])</span>
<span class="c1"># This will rename ALL dogs to be called "Cleopaws"</span>
</pre></div>
</div>
<p>Named parameters using <code class="docutils literal notranslate"><span class="pre">:name</span></code> can be filled using a dictionary:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">dog</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
    <span class="s2">"select rowid, name from dogs where name = :name"</span><span class="p">,</span>
    <span class="p">{</span><span class="s2">"name"</span><span class="p">:</span> <span class="s2">"Cleopaws"</span><span class="p">}</span>
<span class="p">))</span>
<span class="c1"># dog is now {'rowid': 1, 'name': 'Cleopaws'}</span>
</pre></div>
</div>
<p>In this example <code class="docutils literal notranslate"><span class="pre">next()</span></code> is used to retrieve the first result in the iterator returned by the <code class="docutils literal notranslate"><span class="pre">db.query()</span></code> method.</p>
</section>
</section>
<section id="accessing-tables">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Accessing tables"></a><span id="python-api-table"></span><h2><a class="toc-backref" href="#id9" role="doc-backlink">Accessing tables</a><a class="headerlink" href="#accessing-tables" title="Link to this heading">#</a></h2>
<p>Tables are accessed using the indexing operator, like so:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">table</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="s2">"my_table"</span><span class="p">]</span>
</pre></div>
</div>
<p>If the table does not yet exist, it will be created the first time you attempt to insert or upsert data into it.</p>
<p>You can also access tables using the <code class="docutils literal notranslate"><span class="pre">.table()</span></code> method like so:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">table</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s2">"my_table"</span><span class="p">)</span>
</pre></div>
</div>
<p>Using this factory function allows you to set <a class="reference internal" href="#python-api-table-configuration"><span class="std std-ref">Table configuration options</span></a>.</p>
</section>
<section id="listing-tables">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Listing tables"></a><span id="python-api-tables"></span><h2><a class="toc-backref" href="#id10" role="doc-backlink">Listing tables</a><a class="headerlink" href="#listing-tables" title="Link to this heading">#</a></h2>
<p>You can list the names of tables in a database using the <code class="docutils literal notranslate"><span class="pre">.table_names()</span></code> method:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt; db.table_names()
['dogs']
</pre></div>
</div>
<p>To see just the FTS4 tables, use <code class="docutils literal notranslate"><span class="pre">.table_names(fts4=True)</span></code>. For FTS5, use <code class="docutils literal notranslate"><span class="pre">.table_names(fts5=True)</span></code>.</p>
<p>You can also iterate through the table objects themselves using the <code class="docutils literal notranslate"><span class="pre">.tables</span></code> property:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt; db.tables
[&lt;Table dogs&gt;]
</pre></div>
</div>
</section>
<section id="listing-views">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Listing views"></a><span id="python-api-views"></span><h2><a class="toc-backref" href="#id11" role="doc-backlink">Listing views</a><a class="headerlink" href="#listing-views" title="Link to this heading">#</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">.view_names()</span></code> shows you a list of views in the database:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt; db.view_names()
['good_dogs']
</pre></div>
</div>
<p>You can iterate through view objects using the <code class="docutils literal notranslate"><span class="pre">.views</span></code> property:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt; db.views
[&lt;View good_dogs&gt;]
</pre></div>
</div>
<p>View objects are similar to Table objects, except that any attempts to insert or update data will throw an error. The full list of methods and properties available on a view object is as follows:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">columns</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">columns_dict</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">count</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">schema</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">rows</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">rows_where(where,</span> <span class="pre">where_args,</span> <span class="pre">order_by,</span> <span class="pre">select)</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">drop()</span></code></p></li>
</ul>
</section>
<section id="listing-rows">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Listing rows"></a><span id="python-api-rows"></span><h2><a class="toc-backref" href="#id12" role="doc-backlink">Listing rows</a><a class="headerlink" href="#listing-rows" title="Link to this heading">#</a></h2>
<p>To iterate through dictionaries for each of the rows in a table, use <code class="docutils literal notranslate"><span class="pre">.rows</span></code>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt; db = sqlite_utils.Database("dogs.db")
&gt;&gt;&gt; for row in db["dogs"].rows:
...     print(row)
{'id': 1, 'age': 4, 'name': 'Cleo'}
{'id': 2, 'age': 2, 'name': 'Pancakes'}
</pre></div>
</div>
<p>You can filter rows by a WHERE clause using <code class="docutils literal notranslate"><span class="pre">.rows_where(where,</span> <span class="pre">where_args)</span></code>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt; db = sqlite_utils.Database("dogs.db")
&gt;&gt;&gt; for row in db["dogs"].rows_where("age &gt; ?", [3]):
...     print(row)
{'id': 1, 'age': 4, 'name': 'Cleo'}
</pre></div>
</div>
<p>The first argument is a fragment of SQL. The second, optional argument is values to be passed to that fragment - you can use <code class="docutils literal notranslate"><span class="pre">?</span></code> placeholders and pass an array, or you can use <code class="docutils literal notranslate"><span class="pre">:named</span></code> parameters and pass a dictionary, like this:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt; for row in db["dogs"].rows_where("age &gt; :age", {"age": 3}):
...     print(row)
{'id': 1, 'age': 4, 'name': 'Cleo'}
</pre></div>
</div>
<p>To return custom columns (instead of the default that uses <code class="docutils literal notranslate"><span class="pre">select</span> <span class="pre">*</span></code>) pass <code class="docutils literal notranslate"><span class="pre">select="column1,</span> <span class="pre">column2"</span></code>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt; db = sqlite_utils.Database("dogs.db")
&gt;&gt;&gt; for row in db["dogs"].rows_where(select='name, age'):
...     print(row)
{'name': 'Cleo', 'age': 4}
</pre></div>
</div>
<p>To specify an order, use the <code class="docutils literal notranslate"><span class="pre">order_by=</span></code> argument:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt; for row in db["dogs"].rows_where("age &gt; 1", order_by="age"):
...     print(row)
{'id': 2, 'age': 2, 'name': 'Pancakes'}
{'id': 1, 'age': 4, 'name': 'Cleo'}
</pre></div>
</div>
<p>You can use <code class="docutils literal notranslate"><span class="pre">order_by="age</span> <span class="pre">desc"</span></code> for descending order.</p>
<p>You can order all records in the table by excluding the <code class="docutils literal notranslate"><span class="pre">where</span></code> argument:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt; for row in db["dogs"].rows_where(order_by="age desc"):
...     print(row)
{'id': 1, 'age': 4, 'name': 'Cleo'}
{'id': 2, 'age': 2, 'name': 'Pancakes'}
</pre></div>
</div>
<p>This method also accepts <code class="docutils literal notranslate"><span class="pre">offset=</span></code> and <code class="docutils literal notranslate"><span class="pre">limit=</span></code> arguments, for specifying an OFFSET and a LIMIT for the SQL query:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt; for row in db["dogs"].rows_where(order_by="age desc", limit=1):
...     print(row)
{'id': 1, 'age': 4, 'name': 'Cleo'}
</pre></div>
</div>
<section id="counting-rows">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Counting rows"></a><span id="python-api-rows-count-where"></span><h3><a class="toc-backref" href="#id13" role="doc-backlink">Counting rows</a><a class="headerlink" href="#counting-rows" title="Link to this heading">#</a></h3>
<p>To count the number of rows that would be returned by a where filter, use <code class="docutils literal notranslate"><span class="pre">.count_where(where,</span> <span class="pre">where_args)</span></code>:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="p">[</span><span class="s2">"dogs"</span><span class="p">]</span><span class="o">.</span><span class="n">count_where</span><span class="p">(</span><span class="s2">"age &gt; ?"</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="go">2</span>
</pre></div>
</div>
</section>
</section>
<section id="listing-rows-with-their-primary-keys">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Listing rows with their primary keys"></a><span id="python-api-pks-and-rows-where"></span><h2><a class="toc-backref" href="#id14" role="doc-backlink">Listing rows with their primary keys</a><a class="headerlink" href="#listing-rows-with-their-primary-keys" title="Link to this heading">#</a></h2>
<p>Sometimes it can be useful to retrieve the primary key along with each row, in order to pass that key (or primary key tuple) to the <code class="docutils literal notranslate"><span class="pre">.get()</span></code> or <code class="docutils literal notranslate"><span class="pre">.update()</span></code> methods.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">.pks_and_rows_where()</span></code> method takes the same signature as <code class="docutils literal notranslate"><span class="pre">.rows_where()</span></code> (with the exception of the <code class="docutils literal notranslate"><span class="pre">select=</span></code> parameter) but returns a generator that yields pairs of <code class="docutils literal notranslate"><span class="pre">(primary</span> <span class="pre">key,</span> <span class="pre">row</span> <span class="pre">dictionary)</span></code>.</p>
<p>The primary key value will usually be a single value but can also be a tuple if the table has a compound primary key.</p>
<p>If the table is a <code class="docutils literal notranslate"><span class="pre">rowid</span></code> table (with no explicit primary key column) then that ID will be returned.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt; db = sqlite_utils.Database(memory=True)
&gt;&gt;&gt; db["dogs"].insert({"name": "Cleo"})
&gt;&gt;&gt; for pk, row in db["dogs"].pks_and_rows_where():
...     print(pk, row)
1 {'rowid': 1, 'name': 'Cleo'}

&gt;&gt;&gt; db["dogs_with_pk"].insert({"id": 5, "name": "Cleo"}, pk="id")
&gt;&gt;&gt; for pk, row in db["dogs_with_pk"].pks_and_rows_where():
...     print(pk, row)
5 {'id': 5, 'name': 'Cleo'}

&gt;&gt;&gt; db["dogs_with_compound_pk"].insert(
...     {"species": "dog", "id": 3, "name": "Cleo"},
...     pk=("species", "id")
... )
&gt;&gt;&gt; for pk, row in db["dogs_with_compound_pk"].pks_and_rows_where():
...     print(pk, row)
('dog', 3) {'species': 'dog', 'id': 3, 'name': 'Cleo'}
</pre></div>
</div>
</section>
<section id="retrieving-a-specific-record">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Retrieving a specific record"></a><span id="python-api-get"></span><h2><a class="toc-backref" href="#id15" role="doc-backlink">Retrieving a specific record</a><a class="headerlink" href="#retrieving-a-specific-record" title="Link to this heading">#</a></h2>
<p>You can retrieve a record by its primary key using <code class="docutils literal notranslate"><span class="pre">table.get()</span></code>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt; db = sqlite_utils.Database("dogs.db")
&gt;&gt;&gt; print(db["dogs"].get(1))
{'id': 1, 'age': 4, 'name': 'Cleo'}
</pre></div>
</div>
<p>If the table has a compound primary key you can pass in the primary key values as a tuple:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt; db["compound_dogs"].get(("mixed", 3))
</pre></div>
</div>
<p>If the record does not exist a <code class="docutils literal notranslate"><span class="pre">NotFoundError</span></code> will be raised:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlite_utils.db</span> <span class="kn">import</span> <span class="n">NotFoundError</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">row</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="s2">"dogs"</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="k">except</span> <span class="n">NotFoundError</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Dog not found"</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="showing-the-schema">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Showing the schema"></a><span id="python-api-schema"></span><h2><a class="toc-backref" href="#id16" role="doc-backlink">Showing the schema</a><a class="headerlink" href="#showing-the-schema" title="Link to this heading">#</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">db.schema</span></code> property returns the full SQL schema for the database as a string:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt; db = sqlite_utils.Database("dogs.db")
&gt;&gt;&gt; print(db.schema)
CREATE TABLE "dogs" (
    [id] INTEGER PRIMARY KEY,
    [name] TEXT
);
</pre></div>
</div>
</section>
<section id="creating-tables">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Creating tables"></a><span id="python-api-creating-tables"></span><h2><a class="toc-backref" href="#id17" role="doc-backlink">Creating tables</a><a class="headerlink" href="#creating-tables" title="Link to this heading">#</a></h2>
<p>The easiest way to create a new table is to insert a record into it:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlite_utils</span> <span class="kn">import</span> <span class="n">Database</span>
<span class="kn">import</span> <span class="nn">sqlite3</span>

<span class="n">db</span> <span class="o">=</span> <span class="n">Database</span><span class="p">(</span><span class="s2">"dogs.db"</span><span class="p">)</span>
<span class="n">dogs</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="s2">"dogs"</span><span class="p">]</span>
<span class="n">dogs</span><span class="o">.</span><span class="n">insert</span><span class="p">({</span>
    <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"Cleo"</span><span class="p">,</span>
    <span class="s2">"twitter"</span><span class="p">:</span> <span class="s2">"cleopaws"</span><span class="p">,</span>
    <span class="s2">"age"</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="s2">"is_good_dog"</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">})</span>
</pre></div>
</div>
<p>This will automatically create a new table called “dogs” with the following schema:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>CREATE TABLE dogs (
    name TEXT,
    twitter TEXT,
    age INTEGER,
    is_good_dog INTEGER
)
</pre></div>
</div>
<p>You can also specify a primary key by passing the <code class="docutils literal notranslate"><span class="pre">pk=</span></code> parameter to the <code class="docutils literal notranslate"><span class="pre">.insert()</span></code> call. This will only be obeyed if the record being inserted causes the table to be created:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">dogs</span><span class="o">.</span><span class="n">insert</span><span class="p">({</span>
    <span class="s2">"id"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"Cleo"</span><span class="p">,</span>
    <span class="s2">"twitter"</span><span class="p">:</span> <span class="s2">"cleopaws"</span><span class="p">,</span>
    <span class="s2">"age"</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="s2">"is_good_dog"</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">},</span> <span class="n">pk</span><span class="o">=</span><span class="s2">"id"</span><span class="p">)</span>
</pre></div>
</div>
<p>After inserting a row like this, the <code class="docutils literal notranslate"><span class="pre">dogs.last_rowid</span></code> property will return the SQLite <code class="docutils literal notranslate"><span class="pre">rowid</span></code> assigned to the most recently inserted record.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">dogs.last_pk</span></code> property will return the last inserted primary key value, if you specified one. This can be very useful when writing code that creates foreign keys or many-to-many relationships.</p>
<section id="custom-column-order-and-column-types">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Custom column order and column types"></a><span id="python-api-custom-columns"></span><h3><a class="toc-backref" href="#id18" role="doc-backlink">Custom column order and column types</a><a class="headerlink" href="#custom-column-order-and-column-types" title="Link to this heading">#</a></h3>
<p>The order of the columns in the table will be derived from the order of the keys in the dictionary, provided you are using Python 3.6 or later.</p>
<p>If you want to explicitly set the order of the columns you can do so using the <code class="docutils literal notranslate"><span class="pre">column_order=</span></code> parameter:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">[</span><span class="s2">"dogs"</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">({</span>
    <span class="s2">"id"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"Cleo"</span><span class="p">,</span>
    <span class="s2">"twitter"</span><span class="p">:</span> <span class="s2">"cleopaws"</span><span class="p">,</span>
    <span class="s2">"age"</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="s2">"is_good_dog"</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">},</span> <span class="n">pk</span><span class="o">=</span><span class="s2">"id"</span><span class="p">,</span> <span class="n">column_order</span><span class="o">=</span><span class="p">(</span><span class="s2">"id"</span><span class="p">,</span> <span class="s2">"twitter"</span><span class="p">,</span> <span class="s2">"name"</span><span class="p">))</span>
</pre></div>
</div>
<p>You don’t need to pass all of the columns to the <code class="docutils literal notranslate"><span class="pre">column_order</span></code> parameter. If you only pass a subset of the columns the remaining columns will be ordered based on the key order of the dictionary.</p>
<p>Column types are detected based on the example data provided. Sometimes you may find you need to over-ride these detected types - to create an integer column for data that was provided as a string for example, or to ensure that a table where the first example was <code class="docutils literal notranslate"><span class="pre">None</span></code> is created as an <code class="docutils literal notranslate"><span class="pre">INTEGER</span></code> rather than a <code class="docutils literal notranslate"><span class="pre">TEXT</span></code> column. You can do this using the <code class="docutils literal notranslate"><span class="pre">columns=</span></code> parameter:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">[</span><span class="s2">"dogs"</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">({</span>
    <span class="s2">"id"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"Cleo"</span><span class="p">,</span>
    <span class="s2">"age"</span><span class="p">:</span> <span class="s2">"5"</span><span class="p">,</span>
<span class="p">},</span> <span class="n">pk</span><span class="o">=</span><span class="s2">"id"</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">"age"</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s2">"weight"</span><span class="p">:</span> <span class="nb">float</span><span class="p">})</span>
</pre></div>
</div>
<p>This will create a table with the following schema:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="p">[</span><span class="n">dogs</span><span class="p">]</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">[</span><span class="n">id</span><span class="p">]</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<span class="w">    </span><span class="p">[</span><span class="n">age</span><span class="p">]</span><span class="w"> </span><span class="nb">INTEGER</span><span class="p">,</span>
<span class="w">    </span><span class="p">[</span><span class="n">weight</span><span class="p">]</span><span class="w"> </span><span class="nb">FLOAT</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="explicitly-creating-a-table">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Explicitly creating a table"></a><span id="python-api-explicit-create"></span><h3><a class="toc-backref" href="#id19" role="doc-backlink">Explicitly creating a table</a><a class="headerlink" href="#explicitly-creating-a-table" title="Link to this heading">#</a></h3>
<p>You can directly create a new table without inserting any data into it using the <code class="docutils literal notranslate"><span class="pre">.create()</span></code> method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">[</span><span class="s2">"cats"</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
    <span class="s2">"id"</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="s2">"name"</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s2">"weight"</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<span class="p">},</span> <span class="n">pk</span><span class="o">=</span><span class="s2">"id"</span><span class="p">)</span>
</pre></div>
</div>
<p>The first argument here is a dictionary specifying the columns you would like to create. Each column is paired with a Python type indicating the type of column. See <a class="reference internal" href="#python-api-add-column"><span class="std std-ref">Adding columns</span></a> for full details on how these types work.</p>
<p>This method takes optional arguments <code class="docutils literal notranslate"><span class="pre">pk=</span></code>, <code class="docutils literal notranslate"><span class="pre">column_order=</span></code>, <code class="docutils literal notranslate"><span class="pre">foreign_keys=</span></code>, <code class="docutils literal notranslate"><span class="pre">not_null=set()</span></code> and <code class="docutils literal notranslate"><span class="pre">defaults=dict()</span></code> - explained below.</p>
<p>A <code class="docutils literal notranslate"><span class="pre">sqlite_utils.utils.sqlite3.OperationalError</span></code> will be raised if a table of that name already exists.</p>
<p>You can pass <code class="docutils literal notranslate"><span class="pre">ignore=True</span></code> to ignore that error. You can also use <code class="docutils literal notranslate"><span class="pre">if_not_exists=True</span></code> to use the SQL <code class="docutils literal notranslate"><span class="pre">CREATE</span> <span class="pre">TABLE</span> <span class="pre">IF</span> <span class="pre">NOT</span> <span class="pre">EXISTS</span></code> pattern to achieve the same effect:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">[</span><span class="s2">"cats"</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
    <span class="s2">"id"</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="s2">"name"</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">},</span> <span class="n">pk</span><span class="o">=</span><span class="s2">"id"</span><span class="p">,</span> <span class="n">if_not_exists</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>To drop and replace any existing table of that name, pass <code class="docutils literal notranslate"><span class="pre">replace=True</span></code>. This is a <strong>dangerous operation</strong> that will result in loss of existing data in the table.</p>
<p>You can also pass <code class="docutils literal notranslate"><span class="pre">transform=True</span></code> to have any existing tables <a class="reference internal" href="#python-api-transform"><span class="std std-ref">transformed</span></a> to match your new table specification. This is a <strong>dangerous operation</strong> as it will drop columns that are no longer listed in your call to <code class="docutils literal notranslate"><span class="pre">.create()</span></code>, so be careful when running this.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">[</span><span class="s2">"cats"</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
    <span class="s2">"id"</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="s2">"name"</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s2">"weight"</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<span class="p">},</span> <span class="n">pk</span><span class="o">=</span><span class="s2">"id"</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">transform=True</span></code> option will update the table schema if any of the following have changed:</p>
<ul class="simple">
<li><p>The specified columns or their types</p></li>
<li><p>The specified primary key</p></li>
<li><p>The order of the columns, defined using <code class="docutils literal notranslate"><span class="pre">column_order=</span></code></p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">not_null=</span></code> or <code class="docutils literal notranslate"><span class="pre">defaults=</span></code> arguments</p></li>
</ul>
<p>Changes to <code class="docutils literal notranslate"><span class="pre">foreign_keys=</span></code> are not currently detected and applied by <code class="docutils literal notranslate"><span class="pre">transform=True</span></code>.</p>
</section>
<section id="compound-primary-keys">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Compound primary keys"></a><span id="python-api-compound-primary-keys"></span><h3><a class="toc-backref" href="#id20" role="doc-backlink">Compound primary keys</a><a class="headerlink" href="#compound-primary-keys" title="Link to this heading">#</a></h3>
<p>If you want to create a table with a compound primary key that spans multiple columns, you can do so by passing a tuple of column names to any of the methods that accept a <code class="docutils literal notranslate"><span class="pre">pk=</span></code> parameter. For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">[</span><span class="s2">"cats"</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
    <span class="s2">"id"</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="s2">"breed"</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s2">"name"</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s2">"weight"</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<span class="p">},</span> <span class="n">pk</span><span class="o">=</span><span class="p">(</span><span class="s2">"breed"</span><span class="p">,</span> <span class="s2">"id"</span><span class="p">))</span>
</pre></div>
</div>
<p>This also works for the <code class="docutils literal notranslate"><span class="pre">.insert()</span></code>, <code class="docutils literal notranslate"><span class="pre">.insert_all()</span></code>, <code class="docutils literal notranslate"><span class="pre">.upsert()</span></code> and <code class="docutils literal notranslate"><span class="pre">.upsert_all()</span></code> methods.</p>
</section>
<section id="specifying-foreign-keys">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Specifying foreign keys"></a><span id="python-api-foreign-keys"></span><h3><a class="toc-backref" href="#id21" role="doc-backlink">Specifying foreign keys</a><a class="headerlink" href="#specifying-foreign-keys" title="Link to this heading">#</a></h3>
<p>Any operation that can create a table (<code class="docutils literal notranslate"><span class="pre">.create()</span></code>, <code class="docutils literal notranslate"><span class="pre">.insert()</span></code>, <code class="docutils literal notranslate"><span class="pre">.insert_all()</span></code>, <code class="docutils literal notranslate"><span class="pre">.upsert()</span></code> and <code class="docutils literal notranslate"><span class="pre">.upsert_all()</span></code>) accepts an optional <code class="docutils literal notranslate"><span class="pre">foreign_keys=</span></code> argument which can be used to set up foreign key constraints for the table that is being created.</p>
<p>If you are using your database with <a class="reference external" href="https://datasette.io/">Datasette</a>, Datasette will detect these constraints and use them to generate hyperlinks to associated records.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">foreign_keys</span></code> argument takes a list that indicates which foreign keys should be created. The list can take several forms. The simplest is a list of columns:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">foreign_keys</span><span class="o">=</span><span class="p">[</span><span class="s2">"author_id"</span><span class="p">]</span>
</pre></div>
</div>
<p>The library will guess which tables you wish to reference based on the column names using the rules described in <a class="reference internal" href="#python-api-add-foreign-key"><span class="std std-ref">Adding foreign key constraints</span></a>.</p>
<p>You can also be more explicit, by passing in a list of tuples:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">foreign_keys</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s2">"author_id"</span><span class="p">,</span> <span class="s2">"authors"</span><span class="p">,</span> <span class="s2">"id"</span><span class="p">)</span>
<span class="p">]</span>
</pre></div>
</div>
<p>This means that the <code class="docutils literal notranslate"><span class="pre">author_id</span></code> column should be a foreign key that references the <code class="docutils literal notranslate"><span class="pre">id</span></code> column in the <code class="docutils literal notranslate"><span class="pre">authors</span></code> table.</p>
<p>You can leave off the third item in the tuple to have the referenced column automatically set to the primary key of that table. A full example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">[</span><span class="s2">"authors"</span><span class="p">]</span><span class="o">.</span><span class="n">insert_all</span><span class="p">([</span>
    <span class="p">{</span><span class="s2">"id"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"Sally"</span><span class="p">},</span>
    <span class="p">{</span><span class="s2">"id"</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"Asheesh"</span><span class="p">}</span>
<span class="p">],</span> <span class="n">pk</span><span class="o">=</span><span class="s2">"id"</span><span class="p">)</span>
<span class="n">db</span><span class="p">[</span><span class="s2">"books"</span><span class="p">]</span><span class="o">.</span><span class="n">insert_all</span><span class="p">([</span>
    <span class="p">{</span><span class="s2">"title"</span><span class="p">:</span> <span class="s2">"Hedgehogs of the world"</span><span class="p">,</span> <span class="s2">"author_id"</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
    <span class="p">{</span><span class="s2">"title"</span><span class="p">:</span> <span class="s2">"How to train your wolf"</span><span class="p">,</span> <span class="s2">"author_id"</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span>
<span class="p">],</span> <span class="n">foreign_keys</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s2">"author_id"</span><span class="p">,</span> <span class="s2">"authors"</span><span class="p">)</span>
<span class="p">])</span>
</pre></div>
</div>
</section>
<section id="table-configuration-options">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Table configuration options"></a><span id="python-api-table-configuration"></span><h3><a class="toc-backref" href="#id22" role="doc-backlink">Table configuration options</a><a class="headerlink" href="#table-configuration-options" title="Link to this heading">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">.insert()</span></code>, <code class="docutils literal notranslate"><span class="pre">.upsert()</span></code>, <code class="docutils literal notranslate"><span class="pre">.insert_all()</span></code> and <code class="docutils literal notranslate"><span class="pre">.upsert_all()</span></code> methods each take a number of keyword arguments, some of which influence what happens should they cause a table to be created and some of which affect the behavior of those methods.</p>
<p>You can set default values for these methods by accessing the table through the <code class="docutils literal notranslate"><span class="pre">db.table(...)</span></code> method (instead of using <code class="docutils literal notranslate"><span class="pre">db["table_name"]</span></code>), like so:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">table</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">table</span><span class="p">(</span>
    <span class="s2">"authors"</span><span class="p">,</span>
    <span class="n">pk</span><span class="o">=</span><span class="s2">"id"</span><span class="p">,</span>
    <span class="n">not_null</span><span class="o">=</span><span class="p">{</span><span class="s2">"name"</span><span class="p">,</span> <span class="s2">"score"</span><span class="p">},</span>
    <span class="n">column_order</span><span class="o">=</span><span class="p">(</span><span class="s2">"id"</span><span class="p">,</span> <span class="s2">"name"</span><span class="p">,</span> <span class="s2">"score"</span><span class="p">,</span> <span class="s2">"url"</span><span class="p">)</span>
<span class="p">)</span>
<span class="c1"># Now you can call .insert() like so:</span>
<span class="n">table</span><span class="o">.</span><span class="n">insert</span><span class="p">({</span><span class="s2">"id"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"Tracy"</span><span class="p">,</span> <span class="s2">"score"</span><span class="p">:</span> <span class="mi">5</span><span class="p">})</span>
</pre></div>
</div>
<p>The configuration options that can be specified in this way are <code class="docutils literal notranslate"><span class="pre">pk</span></code>, <code class="docutils literal notranslate"><span class="pre">foreign_keys</span></code>, <code class="docutils literal notranslate"><span class="pre">column_order</span></code>, <code class="docutils literal notranslate"><span class="pre">not_null</span></code>, <code class="docutils literal notranslate"><span class="pre">defaults</span></code>, <code class="docutils literal notranslate"><span class="pre">batch_size</span></code>, <code class="docutils literal notranslate"><span class="pre">hash_id</span></code>, <code class="docutils literal notranslate"><span class="pre">hash_id_columns</span></code>, <code class="docutils literal notranslate"><span class="pre">alter</span></code>, <code class="docutils literal notranslate"><span class="pre">ignore</span></code>, <code class="docutils literal notranslate"><span class="pre">replace</span></code>, <code class="docutils literal notranslate"><span class="pre">extracts</span></code>, <code class="docutils literal notranslate"><span class="pre">conversions</span></code>, <code class="docutils literal notranslate"><span class="pre">columns</span></code>. These are all documented below.</p>
</section>
<section id="setting-defaults-and-not-null-constraints">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Setting defaults and not null constraints"></a><span id="python-api-defaults-not-null"></span><h3><a class="toc-backref" href="#id23" role="doc-backlink">Setting defaults and not null constraints</a><a class="headerlink" href="#setting-defaults-and-not-null-constraints" title="Link to this heading">#</a></h3>
<p>Each of the methods that can cause a table to be created take optional arguments <code class="docutils literal notranslate"><span class="pre">not_null=set()</span></code> and <code class="docutils literal notranslate"><span class="pre">defaults=dict()</span></code>. The methods that take these optional arguments are:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">db.create_table(...)</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">table.create(...)</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">table.insert(...)</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">table.insert_all(...)</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">table.upsert(...)</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">table.upsert_all(...)</span></code></p></li>
</ul>
<p>You can use <code class="docutils literal notranslate"><span class="pre">not_null=</span></code> to pass a set of column names that should have a <code class="docutils literal notranslate"><span class="pre">NOT</span> <span class="pre">NULL</span></code> constraint set on them when they are created.</p>
<p>You can use <code class="docutils literal notranslate"><span class="pre">defaults=</span></code> to pass a dictionary mapping columns to the default value that should be specified in the <code class="docutils literal notranslate"><span class="pre">CREATE</span> <span class="pre">TABLE</span></code> statement.</p>
<p>Here’s an example that uses these features:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">[</span><span class="s2">"authors"</span><span class="p">]</span><span class="o">.</span><span class="n">insert_all</span><span class="p">(</span>
    <span class="p">[{</span><span class="s2">"id"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"Sally"</span><span class="p">,</span> <span class="s2">"score"</span><span class="p">:</span> <span class="mi">2</span><span class="p">}],</span>
    <span class="n">pk</span><span class="o">=</span><span class="s2">"id"</span><span class="p">,</span>
    <span class="n">not_null</span><span class="o">=</span><span class="p">{</span><span class="s2">"name"</span><span class="p">,</span> <span class="s2">"score"</span><span class="p">},</span>
    <span class="n">defaults</span><span class="o">=</span><span class="p">{</span><span class="s2">"score"</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
<span class="p">)</span>
<span class="n">db</span><span class="p">[</span><span class="s2">"authors"</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">({</span><span class="s2">"name"</span><span class="p">:</span> <span class="s2">"Dharma"</span><span class="p">})</span>

<span class="nb">list</span><span class="p">(</span><span class="n">db</span><span class="p">[</span><span class="s2">"authors"</span><span class="p">]</span><span class="o">.</span><span class="n">rows</span><span class="p">)</span>
<span class="c1"># Outputs:</span>
<span class="c1"># [{'id': 1, 'name': 'Sally', 'score': 2},</span>
<span class="c1">#  {'id': 3, 'name': 'Dharma', 'score': 1}]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">db</span><span class="p">[</span><span class="s2">"authors"</span><span class="p">]</span><span class="o">.</span><span class="n">schema</span><span class="p">)</span>
<span class="c1"># Outputs:</span>
<span class="c1"># CREATE TABLE [authors] (</span>
<span class="c1">#     [id] INTEGER PRIMARY KEY,</span>
<span class="c1">#     [name] TEXT NOT NULL,</span>
<span class="c1">#     [score] INTEGER NOT NULL DEFAULT 1</span>
<span class="c1"># )</span>
</pre></div>
</div>
</section>
</section>
<section id="renaming-a-table">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Renaming a table"></a><span id="python-api-rename-table"></span><h2><a class="toc-backref" href="#id24" role="doc-backlink">Renaming a table</a><a class="headerlink" href="#renaming-a-table" title="Link to this heading">#</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">db.rename_table(old_name,</span> <span class="pre">new_name)</span></code> method can be used to rename a table:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">rename_table</span><span class="p">(</span><span class="s2">"my_table"</span><span class="p">,</span> <span class="s2">"new_name_for_my_table"</span><span class="p">)</span>
</pre></div>
</div>
<p>This executes the following SQL:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="p">[</span><span class="n">my_table</span><span class="p">]</span><span class="w"> </span><span class="k">RENAME</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="p">[</span><span class="n">new_name_for_my_table</span><span class="p">]</span>
</pre></div>
</div>
</section>
<section id="duplicating-tables">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Duplicating tables"></a><span id="python-api-duplicate"></span><h2><a class="toc-backref" href="#id25" role="doc-backlink">Duplicating tables</a><a class="headerlink" href="#duplicating-tables" title="Link to this heading">#</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">table.duplicate()</span></code> method creates a copy of the table, copying both the table schema and all of the rows in that table:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">[</span><span class="s2">"authors"</span><span class="p">]</span><span class="o">.</span><span class="n">duplicate</span><span class="p">(</span><span class="s2">"authors_copy"</span><span class="p">)</span>
</pre></div>
</div>
<p>The new <code class="docutils literal notranslate"><span class="pre">authors_copy</span></code> table will now contain a duplicate copy of the data from <code class="docutils literal notranslate"><span class="pre">authors</span></code>.</p>
<p>This method raises <code class="docutils literal notranslate"><span class="pre">sqlite_utils.db.NoTable</span></code> if the table does not exist.</p>
</section>
<section id="bulk-inserts">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Bulk inserts"></a><span id="python-api-bulk-inserts"></span><h2><a class="toc-backref" href="#id26" role="doc-backlink">Bulk inserts</a><a class="headerlink" href="#bulk-inserts" title="Link to this heading">#</a></h2>
<p>If you have more than one record to insert, the <code class="docutils literal notranslate"><span class="pre">insert_all()</span></code> method is a much more efficient way of inserting them. Just like <code class="docutils literal notranslate"><span class="pre">insert()</span></code> it will automatically detect the columns that should be created, but it will inspect the first batch of 100 items to help decide what those column types should be.</p>
<p>Use it like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">[</span><span class="s2">"dogs"</span><span class="p">]</span><span class="o">.</span><span class="n">insert_all</span><span class="p">([{</span>
    <span class="s2">"id"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"Cleo"</span><span class="p">,</span>
    <span class="s2">"twitter"</span><span class="p">:</span> <span class="s2">"cleopaws"</span><span class="p">,</span>
    <span class="s2">"age"</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="s2">"is_good_dog"</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">},</span> <span class="p">{</span>
    <span class="s2">"id"</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"Marnie"</span><span class="p">,</span>
    <span class="s2">"twitter"</span><span class="p">:</span> <span class="s2">"MarnieTheDog"</span><span class="p">,</span>
    <span class="s2">"age"</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span>
    <span class="s2">"is_good_dog"</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">}],</span> <span class="n">pk</span><span class="o">=</span><span class="s2">"id"</span><span class="p">,</span> <span class="n">column_order</span><span class="o">=</span><span class="p">(</span><span class="s2">"id"</span><span class="p">,</span> <span class="s2">"twitter"</span><span class="p">,</span> <span class="s2">"name"</span><span class="p">))</span>
</pre></div>
</div>
<p>The column types used in the <code class="docutils literal notranslate"><span class="pre">CREATE</span> <span class="pre">TABLE</span></code> statement are automatically derived from the types of data in that first batch of rows. Any additional columns in subsequent batches will cause a <code class="docutils literal notranslate"><span class="pre">sqlite3.OperationalError</span></code> exception to be raised unless the <code class="docutils literal notranslate"><span class="pre">alter=True</span></code> argument is supplied, in which case the new columns will be created.</p>
<p>The function can accept an iterator or generator of rows and will commit them according to the batch size. The default batch size is 100, but you can specify a different size using the <code class="docutils literal notranslate"><span class="pre">batch_size</span></code> parameter:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">[</span><span class="s2">"big_table"</span><span class="p">]</span><span class="o">.</span><span class="n">insert_all</span><span class="p">(({</span>
    <span class="s2">"id"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"Name </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">),</span>
<span class="p">}</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10000</span><span class="p">)),</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
<p>You can skip inserting any records that have a primary key that already exists using <code class="docutils literal notranslate"><span class="pre">ignore=True</span></code>. This works with both <code class="docutils literal notranslate"><span class="pre">.insert({...},</span> <span class="pre">ignore=True)</span></code> and <code class="docutils literal notranslate"><span class="pre">.insert_all([...],</span> <span class="pre">ignore=True)</span></code>.</p>
<p>You can delete all the existing rows in the table before inserting the new records using <code class="docutils literal notranslate"><span class="pre">truncate=True</span></code>. This is useful if you want to replace the data in the table.</p>
<p>Pass <code class="docutils literal notranslate"><span class="pre">analyze=True</span></code> to run <code class="docutils literal notranslate"><span class="pre">ANALYZE</span></code> against the table after inserting the new records.</p>
</section>
<section id="insert-replacing-data">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Insert-replacing data"></a><span id="python-api-insert-replace"></span><h2><a class="toc-backref" href="#id27" role="doc-backlink">Insert-replacing data</a><a class="headerlink" href="#insert-replacing-data" title="Link to this heading">#</a></h2>
<p>If you try to insert data using a primary key that already exists, the <code class="docutils literal notranslate"><span class="pre">.insert()</span></code> or <code class="docutils literal notranslate"><span class="pre">.insert_all()</span></code> method will raise a <code class="docutils literal notranslate"><span class="pre">sqlite3.IntegrityError</span></code> exception.</p>
<p>This example that catches that exception:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlite_utils.utils</span> <span class="kn">import</span> <span class="n">sqlite3</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">db</span><span class="p">[</span><span class="s2">"dogs"</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">({</span><span class="s2">"id"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"Cleo"</span><span class="p">},</span> <span class="n">pk</span><span class="o">=</span><span class="s2">"id"</span><span class="p">)</span>
<span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">IntegrityError</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Record already exists with that primary key"</span><span class="p">)</span>
</pre></div>
</div>
<p>Importing from <code class="docutils literal notranslate"><span class="pre">sqlite_utils.utils.sqlite3</span></code> ensures your code continues to work even if you are using the <code class="docutils literal notranslate"><span class="pre">pysqlite3</span></code> library instead of the Python standard library <code class="docutils literal notranslate"><span class="pre">sqlite3</span></code> module.</p>
<p>Use the <code class="docutils literal notranslate"><span class="pre">ignore=True</span></code> parameter to ignore this error:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># This fails silently if a record with id=1 already exists</span>
<span class="n">db</span><span class="p">[</span><span class="s2">"dogs"</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">({</span><span class="s2">"id"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"Cleo"</span><span class="p">},</span> <span class="n">pk</span><span class="o">=</span><span class="s2">"id"</span><span class="p">,</span> <span class="n">ignore</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>To replace any existing records that have a matching primary key, use the <code class="docutils literal notranslate"><span class="pre">replace=True</span></code> parameter to <code class="docutils literal notranslate"><span class="pre">.insert()</span></code> or <code class="docutils literal notranslate"><span class="pre">.insert_all()</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">[</span><span class="s2">"dogs"</span><span class="p">]</span><span class="o">.</span><span class="n">insert_all</span><span class="p">([{</span>
    <span class="s2">"id"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"Cleo"</span><span class="p">,</span>
    <span class="s2">"twitter"</span><span class="p">:</span> <span class="s2">"cleopaws"</span><span class="p">,</span>
    <span class="s2">"age"</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="s2">"is_good_dog"</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">},</span> <span class="p">{</span>
    <span class="s2">"id"</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"Marnie"</span><span class="p">,</span>
    <span class="s2">"twitter"</span><span class="p">:</span> <span class="s2">"MarnieTheDog"</span><span class="p">,</span>
    <span class="s2">"age"</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span>
    <span class="s2">"is_good_dog"</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">}],</span> <span class="n">pk</span><span class="o">=</span><span class="s2">"id"</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Prior to sqlite-utils 2.0 the <code class="docutils literal notranslate"><span class="pre">.upsert()</span></code> and <code class="docutils literal notranslate"><span class="pre">.upsert_all()</span></code> methods worked the same way as <code class="docutils literal notranslate"><span class="pre">.insert(replace=True)</span></code> does today. See <a class="reference internal" href="#python-api-upsert"><span class="std std-ref">Upserting data</span></a> for the new behaviour of those methods introduced in 2.0.</p>
</div>
</section>
<section id="updating-a-specific-record">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Updating a specific record"></a><span id="python-api-update"></span><h2><a class="toc-backref" href="#id28" role="doc-backlink">Updating a specific record</a><a class="headerlink" href="#updating-a-specific-record" title="Link to this heading">#</a></h2>
<p>You can update a record by its primary key using <code class="docutils literal notranslate"><span class="pre">table.update()</span></code>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt; db = sqlite_utils.Database("dogs.db")
&gt;&gt;&gt; print(db["dogs"].get(1))
{'id': 1, 'age': 4, 'name': 'Cleo'}
&gt;&gt;&gt; db["dogs"].update(1, {"age": 5})
&gt;&gt;&gt; print(db["dogs"].get(1))
{'id': 1, 'age': 5, 'name': 'Cleo'}
</pre></div>
</div>
<p>The first argument to <code class="docutils literal notranslate"><span class="pre">update()</span></code> is the primary key. This can be a single value, or a tuple if that table has a compound primary key:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt; db["compound_dogs"].update((5, 3), {"name": "Updated"})
</pre></div>
</div>
<p>The second argument is a dictionary of columns that should be updated, along with their new values.</p>
<p>You can cause any missing columns to be added automatically using <code class="docutils literal notranslate"><span class="pre">alter=True</span></code>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt; db["dogs"].update(1, {"breed": "Mutt"}, alter=True)
</pre></div>
</div>
</section>
<section id="deleting-a-specific-record">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Deleting a specific record"></a><span id="python-api-delete"></span><h2><a class="toc-backref" href="#id29" role="doc-backlink">Deleting a specific record</a><a class="headerlink" href="#deleting-a-specific-record" title="Link to this heading">#</a></h2>
<p>You can delete a record using <code class="docutils literal notranslate"><span class="pre">table.delete()</span></code>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt; db = sqlite_utils.Database("dogs.db")
&gt;&gt;&gt; db["dogs"].delete(1)
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">delete()</span></code> method takes the primary key of the record. This can be a tuple of values if the row has a compound primary key:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt; db["compound_dogs"].delete((5, 3))
</pre></div>
</div>
</section>
<section id="deleting-multiple-records">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Deleting multiple records"></a><span id="python-api-delete-where"></span><h2><a class="toc-backref" href="#id30" role="doc-backlink">Deleting multiple records</a><a class="headerlink" href="#deleting-multiple-records" title="Link to this heading">#</a></h2>
<p>You can delete all records in a table that match a specific WHERE statement using <code class="docutils literal notranslate"><span class="pre">table.delete_where()</span></code>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt; db = sqlite_utils.Database("dogs.db")
&gt;&gt;&gt; # Delete every dog with age less than 3
&gt;&gt;&gt; db["dogs"].delete_where("age &lt; ?", [3])
</pre></div>
</div>
<p>Calling <code class="docutils literal notranslate"><span class="pre">table.delete_where()</span></code> with no other arguments will delete every row in the table.</p>
<p>Pass <code class="docutils literal notranslate"><span class="pre">analyze=True</span></code> to run <code class="docutils literal notranslate"><span class="pre">ANALYZE</span></code> against the table after deleting the rows.</p>
</section>
<section id="upserting-data">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Upserting data"></a><span id="python-api-upsert"></span><h2><a class="toc-backref" href="#id31" role="doc-backlink">Upserting data</a><a class="headerlink" href="#upserting-data" title="Link to this heading">#</a></h2>
<p>Upserting allows you to insert records if they do not exist and update them if they DO exist, based on matching against their primary key.</p>
<p>For example, given the dogs database you could upsert the record for Cleo like so:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">[</span><span class="s2">"dogs"</span><span class="p">]</span><span class="o">.</span><span class="n">upsert</span><span class="p">({</span>
    <span class="s2">"id"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"Cleo"</span><span class="p">,</span>
    <span class="s2">"twitter"</span><span class="p">:</span> <span class="s2">"cleopaws"</span><span class="p">,</span>
    <span class="s2">"age"</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
    <span class="s2">"is_good_dog"</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">},</span> <span class="n">pk</span><span class="o">=</span><span class="s2">"id"</span><span class="p">,</span> <span class="n">column_order</span><span class="o">=</span><span class="p">(</span><span class="s2">"id"</span><span class="p">,</span> <span class="s2">"twitter"</span><span class="p">,</span> <span class="s2">"name"</span><span class="p">))</span>
</pre></div>
</div>
<p>If a record exists with id=1, it will be updated to match those fields. If it does not exist it will be created.</p>
<p>Any existing columns that are not referenced in the dictionary passed to <code class="docutils literal notranslate"><span class="pre">.upsert()</span></code> will be unchanged. If you want to replace a record entirely, use <code class="docutils literal notranslate"><span class="pre">.insert(doc,</span> <span class="pre">replace=True)</span></code> instead.</p>
<p>Note that the <code class="docutils literal notranslate"><span class="pre">pk</span></code> and <code class="docutils literal notranslate"><span class="pre">column_order</span></code> parameters here are optional if you are certain that the table has already been created. You should pass them if the table may not exist at the time the first upsert is performed.</p>
<p>An <code class="docutils literal notranslate"><span class="pre">upsert_all()</span></code> method is also available, which behaves like <code class="docutils literal notranslate"><span class="pre">insert_all()</span></code> but performs upserts instead.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">.upsert()</span></code> and <code class="docutils literal notranslate"><span class="pre">.upsert_all()</span></code> in sqlite-utils 1.x worked like <code class="docutils literal notranslate"><span class="pre">.insert(...,</span> <span class="pre">replace=True)</span></code> and <code class="docutils literal notranslate"><span class="pre">.insert_all(...,</span> <span class="pre">replace=True)</span></code> do in 2.x. See <a class="reference external" href="https://github.com/simonw/sqlite-utils/issues/66">issue #66</a> for details of this change.</p>
</div>
</section>
<section id="converting-data-in-columns">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Converting data in columns"></a><span id="python-api-convert"></span><h2><a class="toc-backref" href="#id32" role="doc-backlink">Converting data in columns</a><a class="headerlink" href="#converting-data-in-columns" title="Link to this heading">#</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">table.convert(...)</span></code> method can be used to apply a conversion function to the values in a column, either to update that column or to populate new columns. It is the Python library equivalent of the <a class="reference internal" href="cli.html#cli-convert"><span class="std std-ref">sqlite-utils convert</span></a> command.</p>
<p>This feature works by registering a custom SQLite function that applies a Python transformation, then running a SQL query equivalent to <code class="docutils literal notranslate"><span class="pre">UPDATE</span> <span class="pre">table</span> <span class="pre">SET</span> <span class="pre">column</span> <span class="pre">=</span> <span class="pre">convert_value(column);</span></code></p>
<p>To transform a specific column to uppercase, you would use the following:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">[</span><span class="s2">"dogs"</span><span class="p">]</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s2">"name"</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">value</span><span class="p">:</span> <span class="n">value</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
</pre></div>
</div>
<p>You can pass a list of columns, in which case the transformation will be applied to each one:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">[</span><span class="s2">"dogs"</span><span class="p">]</span><span class="o">.</span><span class="n">convert</span><span class="p">([</span><span class="s2">"name"</span><span class="p">,</span> <span class="s2">"twitter"</span><span class="p">],</span> <span class="k">lambda</span> <span class="n">value</span><span class="p">:</span> <span class="n">value</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
</pre></div>
</div>
<p>To save the output to of the transformation to a different column, use the <code class="docutils literal notranslate"><span class="pre">output=</span></code> parameter:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">[</span><span class="s2">"dogs"</span><span class="p">]</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s2">"name"</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">value</span><span class="p">:</span> <span class="n">value</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">output</span><span class="o">=</span><span class="s2">"name_upper"</span><span class="p">)</span>
</pre></div>
</div>
<p>This will add the new column, if it does not already exist. You can pass <code class="docutils literal notranslate"><span class="pre">output_type=int</span></code> or some other type to control the type of the new column - otherwise it will default to text.</p>
<p>If you want to drop the original column after saving the results in a separate output column, pass <code class="docutils literal notranslate"><span class="pre">drop=True</span></code>.</p>
<p>By default any rows with a falsey value for the column - such as <code class="docutils literal notranslate"><span class="pre">0</span></code> or <code class="docutils literal notranslate"><span class="pre">None</span></code> - will be skipped. Pass <code class="docutils literal notranslate"><span class="pre">skip_false=False</span></code> to disable this behaviour.</p>
<p>You can create multiple new columns from a single input column by passing <code class="docutils literal notranslate"><span class="pre">multi=True</span></code> and a conversion function that returns a Python dictionary. This example creates new <code class="docutils literal notranslate"><span class="pre">upper</span></code> and <code class="docutils literal notranslate"><span class="pre">lower</span></code> columns populated from the single <code class="docutils literal notranslate"><span class="pre">title</span></code> column:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">table</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span>
    <span class="s2">"title"</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="p">{</span><span class="s2">"upper"</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="s2">"lower"</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">lower</span><span class="p">()},</span> <span class="n">multi</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">.convert()</span></code> method accepts optional <code class="docutils literal notranslate"><span class="pre">where=</span></code> and <code class="docutils literal notranslate"><span class="pre">where_args=</span></code> parameters which can be used to apply the conversion to a subset of rows specified by a where clause. Here’s how to apply the conversion only to rows with an <code class="docutils literal notranslate"><span class="pre">id</span></code> that is higher than 20:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">table</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s2">"title"</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">where</span><span class="o">=</span><span class="s2">"id &gt; :id"</span><span class="p">,</span> <span class="n">where_args</span><span class="o">=</span><span class="p">{</span><span class="s2">"id"</span><span class="p">:</span> <span class="mi">20</span><span class="p">})</span>
</pre></div>
</div>
<p>These behave the same as the corresponding parameters to the <a class="reference internal" href="#python-api-rows"><span class="std std-ref">.rows_where()</span></a> method, so you can use <code class="docutils literal notranslate"><span class="pre">?</span></code> placeholders and a list of values instead of <code class="docutils literal notranslate"><span class="pre">:named</span></code> placeholders with a dictionary.</p>
</section>
<section id="working-with-lookup-tables">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Working with lookup tables"></a><span id="python-api-lookup-tables"></span><h2><a class="toc-backref" href="#id33" role="doc-backlink">Working with lookup tables</a><a class="headerlink" href="#working-with-lookup-tables" title="Link to this heading">#</a></h2>
<p>A useful pattern when populating large tables in to break common values out into lookup tables. Consider a table of <code class="docutils literal notranslate"><span class="pre">Trees</span></code>, where each tree has a species. Ideally these species would be split out into a separate <code class="docutils literal notranslate"><span class="pre">Species</span></code> table, with each one assigned an integer primary key that can be referenced from the <code class="docutils literal notranslate"><span class="pre">Trees</span></code> table <code class="docutils literal notranslate"><span class="pre">species_id</span></code> column.</p>
<section id="creating-lookup-tables-explicitly">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Creating lookup tables explicitly"></a><span id="python-api-explicit-lookup-tables"></span><h3><a class="toc-backref" href="#id34" role="doc-backlink">Creating lookup tables explicitly</a><a class="headerlink" href="#creating-lookup-tables-explicitly" title="Link to this heading">#</a></h3>
<p>Calling <code class="docutils literal notranslate"><span class="pre">db["Species"].lookup({"name":</span> <span class="pre">"Palm"})</span></code> creates a table called <code class="docutils literal notranslate"><span class="pre">Species</span></code> (if one does not already exist) with two columns: <code class="docutils literal notranslate"><span class="pre">id</span></code> and <code class="docutils literal notranslate"><span class="pre">name</span></code>. It sets up a unique constraint on the <code class="docutils literal notranslate"><span class="pre">name</span></code> column to guarantee it will not contain duplicate rows. It then inserts a new row with the <code class="docutils literal notranslate"><span class="pre">name</span></code> set to <code class="docutils literal notranslate"><span class="pre">Palm</span></code> and returns the new integer primary key value.</p>
<p>If the <code class="docutils literal notranslate"><span class="pre">Species</span></code> table already exists, it will insert the new row and return the primary key. If a row with that <code class="docutils literal notranslate"><span class="pre">name</span></code> already exists, it will return the corresponding primary key value directly.</p>
<p>If you call <code class="docutils literal notranslate"><span class="pre">.lookup()</span></code> against an existing table without the unique constraint it will attempt to add the constraint, raising an <code class="docutils literal notranslate"><span class="pre">IntegrityError</span></code> if the constraint cannot be created.</p>
<p>If you pass in a dictionary with multiple values, both values will be used to insert or retrieve the corresponding ID and any unique constraint that is created will cover all of those columns, for example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">[</span><span class="s2">"Trees"</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">({</span>
    <span class="s2">"latitude"</span><span class="p">:</span> <span class="mf">49.1265976</span><span class="p">,</span>
    <span class="s2">"longitude"</span><span class="p">:</span> <span class="mf">2.5496218</span><span class="p">,</span>
    <span class="s2">"species"</span><span class="p">:</span> <span class="n">db</span><span class="p">[</span><span class="s2">"Species"</span><span class="p">]</span><span class="o">.</span><span class="n">lookup</span><span class="p">({</span>
        <span class="s2">"common_name"</span><span class="p">:</span> <span class="s2">"Common Juniper"</span><span class="p">,</span>
        <span class="s2">"latin_name"</span><span class="p">:</span> <span class="s2">"Juniperus communis"</span>
    <span class="p">})</span>
<span class="p">})</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">.lookup()</span></code> method has an optional second argument which can be used to populate other columns in the table but only if the row does not exist yet. These columns will not be included in the unique index.</p>
<p>To create a species record with a note on when it was first seen, you can use this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">[</span><span class="s2">"Species"</span><span class="p">]</span><span class="o">.</span><span class="n">lookup</span><span class="p">({</span><span class="s2">"name"</span><span class="p">:</span> <span class="s2">"Palm"</span><span class="p">},</span> <span class="p">{</span><span class="s2">"first_seen"</span><span class="p">:</span> <span class="s2">"2021-03-04"</span><span class="p">})</span>
</pre></div>
</div>
<p>The first time this is called the record will be created for <code class="docutils literal notranslate"><span class="pre">name="Palm"</span></code>. Any subsequent calls with that name will ignore the second argument, even if it includes different values.</p>
<p><code class="docutils literal notranslate"><span class="pre">.lookup()</span></code> also accepts keyword arguments, which are passed through to the <a class="reference internal" href="#python-api-creating-tables"><span class="std std-ref">insert() method</span></a> and can be used to influence the shape of the created table. Supported parameters are:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">pk</span></code> - which defaults to <code class="docutils literal notranslate"><span class="pre">id</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">foreign_keys</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">column_order</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">not_null</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">defaults</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">extracts</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">conversions</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">columns</span></code></p></li>
</ul>
</section>
<section id="populating-lookup-tables-automatically-during-insert-upsert">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Populating lookup tables automatically during insert/upsert"></a><span id="python-api-extracts"></span><h3><a class="toc-backref" href="#id35" role="doc-backlink">Populating lookup tables automatically during insert/upsert</a><a class="headerlink" href="#populating-lookup-tables-automatically-during-insert-upsert" title="Link to this heading">#</a></h3>
<p>A more efficient way to work with lookup tables is to define them using the <code class="docutils literal notranslate"><span class="pre">extracts=</span></code> parameter, which is accepted by <code class="docutils literal notranslate"><span class="pre">.insert()</span></code>, <code class="docutils literal notranslate"><span class="pre">.upsert()</span></code>, <code class="docutils literal notranslate"><span class="pre">.insert_all()</span></code>, <code class="docutils literal notranslate"><span class="pre">.upsert_all()</span></code> and by the <code class="docutils literal notranslate"><span class="pre">.table(...)</span></code> factory function.</p>
<p><code class="docutils literal notranslate"><span class="pre">extracts=</span></code> specifies columns which should be “extracted” out into a separate lookup table during the data insertion.</p>
<p>It can be either a list of column names, in which case the extracted table names will match the column names exactly, or it can be a dictionary mapping column names to the desired name of the extracted table.</p>
<p>To extract the <code class="docutils literal notranslate"><span class="pre">species</span></code> column out to a separate <code class="docutils literal notranslate"><span class="pre">Species</span></code> table, you can do this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Using the table factory</span>
<span class="n">trees</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s2">"Trees"</span><span class="p">,</span> <span class="n">extracts</span><span class="o">=</span><span class="p">{</span><span class="s2">"species"</span><span class="p">:</span> <span class="s2">"Species"</span><span class="p">})</span>
<span class="n">trees</span><span class="o">.</span><span class="n">insert</span><span class="p">({</span>
    <span class="s2">"latitude"</span><span class="p">:</span> <span class="mf">49.1265976</span><span class="p">,</span>
    <span class="s2">"longitude"</span><span class="p">:</span> <span class="mf">2.5496218</span><span class="p">,</span>
    <span class="s2">"species"</span><span class="p">:</span> <span class="s2">"Common Juniper"</span>
<span class="p">})</span>

<span class="c1"># If you want the table to be called 'species', you can do this:</span>
<span class="n">trees</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s2">"Trees"</span><span class="p">,</span> <span class="n">extracts</span><span class="o">=</span><span class="p">[</span><span class="s2">"species"</span><span class="p">])</span>

<span class="c1"># Using .insert() directly</span>
<span class="n">db</span><span class="p">[</span><span class="s2">"Trees"</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">({</span>
    <span class="s2">"latitude"</span><span class="p">:</span> <span class="mf">49.1265976</span><span class="p">,</span>
    <span class="s2">"longitude"</span><span class="p">:</span> <span class="mf">2.5496218</span><span class="p">,</span>
    <span class="s2">"species"</span><span class="p">:</span> <span class="s2">"Common Juniper"</span>
<span class="p">},</span> <span class="n">extracts</span><span class="o">=</span><span class="p">{</span><span class="s2">"species"</span><span class="p">:</span> <span class="s2">"Species"</span><span class="p">})</span>
</pre></div>
</div>
</section>
</section>
<section id="working-with-many-to-many-relationships">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Working with many-to-many relationships"></a><span id="python-api-m2m"></span><h2><a class="toc-backref" href="#id36" role="doc-backlink">Working with many-to-many relationships</a><a class="headerlink" href="#working-with-many-to-many-relationships" title="Link to this heading">#</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">sqlite-utils</span></code> includes a shortcut for creating records using many-to-many relationships in the form of the <code class="docutils literal notranslate"><span class="pre">table.m2m(...)</span></code> method.</p>
<p>Here’s how to create two new records and connect them via a many-to-many table in a single line of code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">[</span><span class="s2">"dogs"</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">({</span><span class="s2">"id"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"Cleo"</span><span class="p">},</span> <span class="n">pk</span><span class="o">=</span><span class="s2">"id"</span><span class="p">)</span><span class="o">.</span><span class="n">m2m</span><span class="p">(</span>
    <span class="s2">"humans"</span><span class="p">,</span> <span class="p">{</span><span class="s2">"id"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"Natalie"</span><span class="p">},</span> <span class="n">pk</span><span class="o">=</span><span class="s2">"id"</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Running this example actually creates three tables: <code class="docutils literal notranslate"><span class="pre">dogs</span></code>, <code class="docutils literal notranslate"><span class="pre">humans</span></code> and a many-to-many <code class="docutils literal notranslate"><span class="pre">dogs_humans</span></code> table. It will insert a record into each of those tables.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">.m2m()</span></code> method executes against the last record that was affected by <code class="docutils literal notranslate"><span class="pre">.insert()</span></code> or <code class="docutils literal notranslate"><span class="pre">.update()</span></code> - the record identified by the <code class="docutils literal notranslate"><span class="pre">table.last_pk</span></code> property. To execute <code class="docutils literal notranslate"><span class="pre">.m2m()</span></code> against a specific record you can first select it by passing its primary key to <code class="docutils literal notranslate"><span class="pre">.update()</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">[</span><span class="s2">"dogs"</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">m2m</span><span class="p">(</span>
    <span class="s2">"humans"</span><span class="p">,</span> <span class="p">{</span><span class="s2">"id"</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"Simon"</span><span class="p">},</span> <span class="n">pk</span><span class="o">=</span><span class="s2">"id"</span>
<span class="p">)</span>
</pre></div>
</div>
<p>The first argument to <code class="docutils literal notranslate"><span class="pre">.m2m()</span></code> can be either the name of a table as a string or it can be the table object itself.</p>
<p>The second argument can be a single dictionary record or a list of dictionaries. These dictionaries will be passed to <code class="docutils literal notranslate"><span class="pre">.upsert()</span></code> against the specified table.</p>
<p>Here’s alternative code that creates the dog record and adds two people to it:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">Database</span><span class="p">(</span><span class="n">memory</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">dogs</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s2">"dogs"</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="s2">"id"</span><span class="p">)</span>
<span class="n">humans</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s2">"humans"</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="s2">"id"</span><span class="p">)</span>
<span class="n">dogs</span><span class="o">.</span><span class="n">insert</span><span class="p">({</span><span class="s2">"id"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"Cleo"</span><span class="p">})</span><span class="o">.</span><span class="n">m2m</span><span class="p">(</span>
    <span class="n">humans</span><span class="p">,</span> <span class="p">[</span>
        <span class="p">{</span><span class="s2">"id"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"Natalie"</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">"id"</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"Simon"</span><span class="p">}</span>
    <span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
<p>The method will attempt to find an existing many-to-many table by looking for a table that has foreign key relationships against both of the tables in the relationship.</p>
<p>If it cannot find such a table, it will create a new one using the names of the two tables - <code class="docutils literal notranslate"><span class="pre">dogs_humans</span></code> in this example. You can customize the name of this table using the <code class="docutils literal notranslate"><span class="pre">m2m_table=</span></code> argument to <code class="docutils literal notranslate"><span class="pre">.m2m()</span></code>.</p>
<p>It it finds multiple candidate tables with foreign keys to both of the specified tables it will raise a <code class="docutils literal notranslate"><span class="pre">sqlite_utils.db.NoObviousTable</span></code> exception. You can avoid this error by specifying the correct table using <code class="docutils literal notranslate"><span class="pre">m2m_table=</span></code>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">.m2m()</span></code> method also takes an optional <code class="docutils literal notranslate"><span class="pre">pk=</span></code> argument to specify the primary key that should be used if the table is created, and an optional <code class="docutils literal notranslate"><span class="pre">alter=True</span></code> argument to specify that any missing columns of an existing table should be added if they are needed.</p>
<section id="using-m2m-and-lookup-tables-together">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Using m2m and lookup tables together"></a><span id="python-api-m2m-lookup"></span><h3><a class="toc-backref" href="#id37" role="doc-backlink">Using m2m and lookup tables together</a><a class="headerlink" href="#using-m2m-and-lookup-tables-together" title="Link to this heading">#</a></h3>
<p>You can work with (or create) lookup tables as part of a call to <code class="docutils literal notranslate"><span class="pre">.m2m()</span></code> using the <code class="docutils literal notranslate"><span class="pre">lookup=</span></code> parameter. This accepts the same argument as <code class="docutils literal notranslate"><span class="pre">table.lookup()</span></code> does - a dictionary of values that should be used to lookup or create a row in the lookup table.</p>
<p>This example creates a dogs table, populates it, creates a characteristics table, populates that and sets up a many-to-many relationship between the two. It chains <code class="docutils literal notranslate"><span class="pre">.m2m()</span></code> twice to create two associated characteristics:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">Database</span><span class="p">(</span><span class="n">memory</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">dogs</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s2">"dogs"</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="s2">"id"</span><span class="p">)</span>
<span class="n">dogs</span><span class="o">.</span><span class="n">insert</span><span class="p">({</span><span class="s2">"id"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"Cleo"</span><span class="p">})</span><span class="o">.</span><span class="n">m2m</span><span class="p">(</span>
    <span class="s2">"characteristics"</span><span class="p">,</span> <span class="n">lookup</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"Playful"</span>
    <span class="p">}</span>
<span class="p">)</span><span class="o">.</span><span class="n">m2m</span><span class="p">(</span>
    <span class="s2">"characteristics"</span><span class="p">,</span> <span class="n">lookup</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"Opinionated"</span>
    <span class="p">}</span>
<span class="p">)</span>
</pre></div>
</div>
<p>You can inspect the database to see the results like this:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt; db.table_names()
['dogs', 'characteristics', 'characteristics_dogs']
&gt;&gt;&gt; list(db["dogs"].rows)
[{'id': 1, 'name': 'Cleo'}]
&gt;&gt;&gt; list(db["characteristics"].rows)
[{'id': 1, 'name': 'Playful'}, {'id': 2, 'name': 'Opinionated'}]
&gt;&gt;&gt; list(db["characteristics_dogs"].rows)
[{'characteristics_id': 1, 'dogs_id': 1}, {'characteristics_id': 2, 'dogs_id': 1}]
&gt;&gt;&gt; print(db["characteristics_dogs"].schema)
CREATE TABLE [characteristics_dogs] (
    [characteristics_id] INTEGER REFERENCES [characteristics]([id]),
    [dogs_id] INTEGER REFERENCES [dogs]([id]),
    PRIMARY KEY ([characteristics_id], [dogs_id])
)
</pre></div>
</div>
</section>
</section>
<section id="analyzing-a-column">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Analyzing a column"></a><span id="python-api-analyze-column"></span><h2><a class="toc-backref" href="#id38" role="doc-backlink">Analyzing a column</a><a class="headerlink" href="#analyzing-a-column" title="Link to this heading">#</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">table.analyze_column(column)</span></code> method is used by the <a class="reference internal" href="cli.html#cli-analyze-tables"><span class="std std-ref">analyze-tables</span></a> CLI command.</p>
<p>It takes the following arguments and options:</p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">column</span></code> - required</dt><dd><p>The name of the column to analyze</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">common_limit</span></code></dt><dd><p>The number of most common values to return. Defaults to 10.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">value_truncate</span></code></dt><dd><p>If set to an integer, values longer than this will be truncated to this length. Defaults to None.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">most_common</span></code></dt><dd><p>If set to False, the <code class="docutils literal notranslate"><span class="pre">most_common</span></code> field of the returned <code class="docutils literal notranslate"><span class="pre">ColumnDetails</span></code> will be set to None. Defaults to True.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">least_common</span></code></dt><dd><p>If set to False, the <code class="docutils literal notranslate"><span class="pre">least_common</span></code> field of the returned <code class="docutils literal notranslate"><span class="pre">ColumnDetails</span></code> will be set to None. Defaults to True.</p>
</dd>
</dl>
<p>And returns a <code class="docutils literal notranslate"><span class="pre">ColumnDetails</span></code> named tuple with the following fields:</p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">table</span></code></dt><dd><p>The name of the table</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">column</span></code></dt><dd><p>The name of the column</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">total_rows</span></code></dt><dd><p>The total number of rows in the table</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">num_null</span></code></dt><dd><p>The number of rows for which this column is null</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">num_blank</span></code></dt><dd><p>The number of rows for which this column is blank (the empty string)</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">num_distinct</span></code></dt><dd><p>The number of distinct values in this column</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">most_common</span></code></dt><dd><p>The <code class="docutils literal notranslate"><span class="pre">N</span></code> most common values as a list of <code class="docutils literal notranslate"><span class="pre">(value,</span> <span class="pre">count)</span></code> tuples`, or <code class="docutils literal notranslate"><span class="pre">None</span></code> if the table consists entirely of distinct values</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">least_common</span></code></dt><dd><p>The <code class="docutils literal notranslate"><span class="pre">N</span></code> least common values as a list of <code class="docutils literal notranslate"><span class="pre">(value,</span> <span class="pre">count)</span></code> tuples`, or <code class="docutils literal notranslate"><span class="pre">None</span></code> if the table is entirely distinct or if the number of distinct values is less than N (since they will already have been returned in <code class="docutils literal notranslate"><span class="pre">most_common</span></code>)</p>
</dd>
</dl>
</section>
<section id="adding-columns">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Adding columns"></a><span id="python-api-add-column"></span><h2><a class="toc-backref" href="#id39" role="doc-backlink">Adding columns</a><a class="headerlink" href="#adding-columns" title="Link to this heading">#</a></h2>
<p>You can add a new column to a table using the <code class="docutils literal notranslate"><span class="pre">.add_column(col_name,</span> <span class="pre">col_type)</span></code> method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">[</span><span class="s2">"dogs"</span><span class="p">]</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">"instagram"</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
<span class="n">db</span><span class="p">[</span><span class="s2">"dogs"</span><span class="p">]</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">"weight"</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
<span class="n">db</span><span class="p">[</span><span class="s2">"dogs"</span><span class="p">]</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">"dob"</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
<span class="n">db</span><span class="p">[</span><span class="s2">"dogs"</span><span class="p">]</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">"image"</span><span class="p">,</span> <span class="s2">"BLOB"</span><span class="p">)</span>
<span class="n">db</span><span class="p">[</span><span class="s2">"dogs"</span><span class="p">]</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">"website"</span><span class="p">)</span> <span class="c1"># str by default</span>
</pre></div>
</div>
<p>You can specify the <code class="docutils literal notranslate"><span class="pre">col_type</span></code> argument either using a SQLite type as a string, or by directly passing a Python type e.g. <code class="docutils literal notranslate"><span class="pre">str</span></code> or <code class="docutils literal notranslate"><span class="pre">float</span></code>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">col_type</span></code> is optional - if you omit it the type of <code class="docutils literal notranslate"><span class="pre">TEXT</span></code> will be used.</p>
<p>SQLite types you can specify are <code class="docutils literal notranslate"><span class="pre">"TEXT"</span></code>, <code class="docutils literal notranslate"><span class="pre">"INTEGER"</span></code>, <code class="docutils literal notranslate"><span class="pre">"FLOAT"</span></code> or <code class="docutils literal notranslate"><span class="pre">"BLOB"</span></code>.</p>
<p>If you pass a Python type, it will be mapped to SQLite types as shown here:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>float: "FLOAT"
int: "INTEGER"
bool: "INTEGER"
str: "TEXT"
bytes: "BLOB"
datetime.datetime: "TEXT"
datetime.date: "TEXT"
datetime.time: "TEXT"

# If numpy is installed
np.int8: "INTEGER"
np.int16: "INTEGER"
np.int32: "INTEGER"
np.int64: "INTEGER"
np.uint8: "INTEGER"
np.uint16: "INTEGER"
np.uint32: "INTEGER"
np.uint64: "INTEGER"
np.float16: "FLOAT"
np.float32: "FLOAT"
np.float64: "FLOAT"
</pre></div>
</div>
<p>You can also add a column that is a foreign key reference to another table using the <code class="docutils literal notranslate"><span class="pre">fk</span></code> parameter:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">[</span><span class="s2">"dogs"</span><span class="p">]</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">"species_id"</span><span class="p">,</span> <span class="n">fk</span><span class="o">=</span><span class="s2">"species"</span><span class="p">)</span>
</pre></div>
</div>
<p>This will automatically detect the name of the primary key on the species table and use that (and its type) for the new column.</p>
<p>You can explicitly specify the column you wish to reference using <code class="docutils literal notranslate"><span class="pre">fk_col</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">[</span><span class="s2">"dogs"</span><span class="p">]</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">"species_id"</span><span class="p">,</span> <span class="n">fk</span><span class="o">=</span><span class="s2">"species"</span><span class="p">,</span> <span class="n">fk_col</span><span class="o">=</span><span class="s2">"ref"</span><span class="p">)</span>
</pre></div>
</div>
<p>You can set a <code class="docutils literal notranslate"><span class="pre">NOT</span> <span class="pre">NULL</span> <span class="pre">DEFAULT</span> <span class="pre">'x'</span></code> constraint on the new column using <code class="docutils literal notranslate"><span class="pre">not_null_default</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">[</span><span class="s2">"dogs"</span><span class="p">]</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">"friends_count"</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">not_null_default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="adding-columns-automatically-on-insert-update">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Adding columns automatically on insert/update"></a><span id="python-api-add-column-alter"></span><h2><a class="toc-backref" href="#id40" role="doc-backlink">Adding columns automatically on insert/update</a><a class="headerlink" href="#adding-columns-automatically-on-insert-update" title="Link to this heading">#</a></h2>
<p>You can insert or update data that includes new columns and have the table automatically altered to fit the new schema using the <code class="docutils literal notranslate"><span class="pre">alter=True</span></code> argument. This can be passed to all four of <code class="docutils literal notranslate"><span class="pre">.insert()</span></code>, <code class="docutils literal notranslate"><span class="pre">.upsert()</span></code>, <code class="docutils literal notranslate"><span class="pre">.insert_all()</span></code> and <code class="docutils literal notranslate"><span class="pre">.upsert_all()</span></code>, or it can be passed to <code class="docutils literal notranslate"><span class="pre">db.table(table_name,</span> <span class="pre">alter=True)</span></code> to enable it by default for all method calls against that table instance.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">[</span><span class="s2">"new_table"</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">({</span><span class="s2">"name"</span><span class="p">:</span> <span class="s2">"Gareth"</span><span class="p">})</span>
<span class="c1"># This will throw an exception:</span>
<span class="n">db</span><span class="p">[</span><span class="s2">"new_table"</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">({</span><span class="s2">"name"</span><span class="p">:</span> <span class="s2">"Gareth"</span><span class="p">,</span> <span class="s2">"age"</span><span class="p">:</span> <span class="mi">32</span><span class="p">})</span>
<span class="c1"># This will succeed and add a new "age" integer column:</span>
<span class="n">db</span><span class="p">[</span><span class="s2">"new_table"</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">({</span><span class="s2">"name"</span><span class="p">:</span> <span class="s2">"Gareth"</span><span class="p">,</span> <span class="s2">"age"</span><span class="p">:</span> <span class="mi">32</span><span class="p">},</span> <span class="n">alter</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1"># You can see confirm the new column like so:</span>
<span class="nb">print</span><span class="p">(</span><span class="n">db</span><span class="p">[</span><span class="s2">"new_table"</span><span class="p">]</span><span class="o">.</span><span class="n">columns_dict</span><span class="p">)</span>
<span class="c1"># Outputs this:</span>
<span class="c1"># {'name': &lt;class 'str'&gt;, 'age': &lt;class 'int'&gt;}</span>

<span class="c1"># This works too:</span>
<span class="n">new_table</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s2">"new_table"</span><span class="p">,</span> <span class="n">alter</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">new_table</span><span class="o">.</span><span class="n">insert</span><span class="p">({</span><span class="s2">"name"</span><span class="p">:</span> <span class="s2">"Gareth"</span><span class="p">,</span> <span class="s2">"age"</span><span class="p">:</span> <span class="mi">32</span><span class="p">,</span> <span class="s2">"shoe_size"</span><span class="p">:</span> <span class="mi">11</span><span class="p">})</span>
</pre></div>
</div>
</section>
<section id="adding-foreign-key-constraints">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Adding foreign key constraints"></a><span id="python-api-add-foreign-key"></span><h2><a class="toc-backref" href="#id41" role="doc-backlink">Adding foreign key constraints</a><a class="headerlink" href="#adding-foreign-key-constraints" title="Link to this heading">#</a></h2>
<p>The SQLite <code class="docutils literal notranslate"><span class="pre">ALTER</span> <span class="pre">TABLE</span></code> statement doesn’t have the ability to add foreign key references to an existing column.</p>
<p>It’s possible to add these references through very careful manipulation of SQLite’s <code class="docutils literal notranslate"><span class="pre">sqlite_master</span></code> table, using <code class="docutils literal notranslate"><span class="pre">PRAGMA</span> <span class="pre">writable_schema</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">sqlite-utils</span></code> can do this for you, though there is a significant risk of data corruption if something goes wrong so it is advisable to create a fresh copy of your database file before attempting this.</p>
<p>Here’s an example of this mechanism in action:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">[</span><span class="s2">"authors"</span><span class="p">]</span><span class="o">.</span><span class="n">insert_all</span><span class="p">([</span>
    <span class="p">{</span><span class="s2">"id"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"Sally"</span><span class="p">},</span>
    <span class="p">{</span><span class="s2">"id"</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"Asheesh"</span><span class="p">}</span>
<span class="p">],</span> <span class="n">pk</span><span class="o">=</span><span class="s2">"id"</span><span class="p">)</span>
<span class="n">db</span><span class="p">[</span><span class="s2">"books"</span><span class="p">]</span><span class="o">.</span><span class="n">insert_all</span><span class="p">([</span>
    <span class="p">{</span><span class="s2">"title"</span><span class="p">:</span> <span class="s2">"Hedgehogs of the world"</span><span class="p">,</span> <span class="s2">"author_id"</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
    <span class="p">{</span><span class="s2">"title"</span><span class="p">:</span> <span class="s2">"How to train your wolf"</span><span class="p">,</span> <span class="s2">"author_id"</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span>
<span class="p">])</span>
<span class="n">db</span><span class="p">[</span><span class="s2">"books"</span><span class="p">]</span><span class="o">.</span><span class="n">add_foreign_key</span><span class="p">(</span><span class="s2">"author_id"</span><span class="p">,</span> <span class="s2">"authors"</span><span class="p">,</span> <span class="s2">"id"</span><span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">table.add_foreign_key(column,</span> <span class="pre">other_table,</span> <span class="pre">other_column)</span></code> method takes the name of the column, the table that is being referenced and the key column within that other table. If you omit the <code class="docutils literal notranslate"><span class="pre">other_column</span></code> argument the primary key from that table will be used automatically. If you omit the <code class="docutils literal notranslate"><span class="pre">other_table</span></code> argument the table will be guessed based on some simple rules:</p>
<ul class="simple">
<li><p>If the column is of format <code class="docutils literal notranslate"><span class="pre">author_id</span></code>, look for tables called <code class="docutils literal notranslate"><span class="pre">author</span></code> or <code class="docutils literal notranslate"><span class="pre">authors</span></code></p></li>
<li><p>If the column does not end in <code class="docutils literal notranslate"><span class="pre">_id</span></code>, try looking for a table with the exact name of the column or that name with an added <code class="docutils literal notranslate"><span class="pre">s</span></code></p></li>
</ul>
<p>This method first checks that the specified foreign key references tables and columns that exist and does not clash with an existing foreign key. It will raise a <code class="docutils literal notranslate"><span class="pre">sqlite_utils.db.AlterError</span></code> exception if these checks fail.</p>
<p>To ignore the case where the key already exists, use <code class="docutils literal notranslate"><span class="pre">ignore=True</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">[</span><span class="s2">"books"</span><span class="p">]</span><span class="o">.</span><span class="n">add_foreign_key</span><span class="p">(</span><span class="s2">"author_id"</span><span class="p">,</span> <span class="s2">"authors"</span><span class="p">,</span> <span class="s2">"id"</span><span class="p">,</span> <span class="n">ignore</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<section id="adding-multiple-foreign-key-constraints-at-once">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Adding multiple foreign key constraints at once"></a><span id="python-api-add-foreign-keys"></span><h3><a class="toc-backref" href="#id42" role="doc-backlink">Adding multiple foreign key constraints at once</a><a class="headerlink" href="#adding-multiple-foreign-key-constraints-at-once" title="Link to this heading">#</a></h3>
<p>The final step in adding a new foreign key to a SQLite database is to run <code class="docutils literal notranslate"><span class="pre">VACUUM</span></code>, to ensure the new foreign key is available in future introspection queries.</p>
<p><code class="docutils literal notranslate"><span class="pre">VACUUM</span></code> against a large (multi-GB) database can take several minutes or longer. If you are adding multiple foreign keys using <code class="docutils literal notranslate"><span class="pre">table.add_foreign_key(...)</span></code> these can quickly add up.</p>
<p>Instead, you can use <code class="docutils literal notranslate"><span class="pre">db.add_foreign_keys(...)</span></code> to add multiple foreign keys within a single transaction. This method takes a list of four-tuples, each one specifying a <code class="docutils literal notranslate"><span class="pre">table</span></code>, <code class="docutils literal notranslate"><span class="pre">column</span></code>, <code class="docutils literal notranslate"><span class="pre">other_table</span></code> and <code class="docutils literal notranslate"><span class="pre">other_column</span></code>.</p>
<p>Here’s an example adding two foreign keys at once:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">add_foreign_keys</span><span class="p">([</span>
    <span class="p">(</span><span class="s2">"dogs"</span><span class="p">,</span> <span class="s2">"breed_id"</span><span class="p">,</span> <span class="s2">"breeds"</span><span class="p">,</span> <span class="s2">"id"</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">"dogs"</span><span class="p">,</span> <span class="s2">"home_town_id"</span><span class="p">,</span> <span class="s2">"towns"</span><span class="p">,</span> <span class="s2">"id"</span><span class="p">)</span>
<span class="p">])</span>
</pre></div>
</div>
<p>This method runs the same checks as <code class="docutils literal notranslate"><span class="pre">.add_foreign_keys()</span></code> and will raise <code class="docutils literal notranslate"><span class="pre">sqlite_utils.db.AlterError</span></code> if those checks fail.</p>
</section>
<section id="adding-indexes-for-all-foreign-keys">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Adding indexes for all foreign keys"></a><span id="python-api-index-foreign-keys"></span><h3><a class="toc-backref" href="#id43" role="doc-backlink">Adding indexes for all foreign keys</a><a class="headerlink" href="#adding-indexes-for-all-foreign-keys" title="Link to this heading">#</a></h3>
<p>If you want to ensure that every foreign key column in your database has a corresponding index, you can do so like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">index_foreign_keys</span><span class="p">()</span>
</pre></div>
</div>
</section>
</section>
<section id="dropping-a-table-or-view">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Dropping a table or view"></a><span id="python-api-drop"></span><h2><a class="toc-backref" href="#id44" role="doc-backlink">Dropping a table or view</a><a class="headerlink" href="#dropping-a-table-or-view" title="Link to this heading">#</a></h2>
<p>You can drop a table or view using the <code class="docutils literal notranslate"><span class="pre">.drop()</span></code> method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">[</span><span class="s2">"my_table"</span><span class="p">]</span><span class="o">.</span><span class="n">drop</span><span class="p">()</span>
</pre></div>
</div>
<p>Pass <code class="docutils literal notranslate"><span class="pre">ignore=True</span></code> if you want to ignore the error caused by the table or view not existing.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">[</span><span class="s2">"my_table"</span><span class="p">]</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">ignore</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="transforming-a-table">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Transforming a table"></a><span id="python-api-transform"></span><h2><a class="toc-backref" href="#id45" role="doc-backlink">Transforming a table</a><a class="headerlink" href="#transforming-a-table" title="Link to this heading">#</a></h2>
<p>The SQLite <code class="docutils literal notranslate"><span class="pre">ALTER</span> <span class="pre">TABLE</span></code> statement is limited. It can add and drop columns and rename tables, but it cannot change column types, change <code class="docutils literal notranslate"><span class="pre">NOT</span> <span class="pre">NULL</span></code> status or change the primary key for a table.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">table.transform()</span></code> method can do all of these things, by implementing a multi-step pattern <a class="reference external" href="https://www.sqlite.org/lang_altertable.html#otheralter">described in the SQLite documentation</a>:</p>
<ol class="arabic simple">
<li><p>Start a transaction</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">CREATE</span> <span class="pre">TABLE</span> <span class="pre">tablename_new_x123</span></code> with the required changes</p></li>
<li><p>Copy the old data into the new table using <code class="docutils literal notranslate"><span class="pre">INSERT</span> <span class="pre">INTO</span> <span class="pre">tablename_new_x123</span> <span class="pre">SELECT</span> <span class="pre">*</span> <span class="pre">FROM</span> <span class="pre">tablename;</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">DROP</span> <span class="pre">TABLE</span> <span class="pre">tablename;</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ALTER</span> <span class="pre">TABLE</span> <span class="pre">tablename_new_x123</span> <span class="pre">RENAME</span> <span class="pre">TO</span> <span class="pre">tablename;</span></code></p></li>
<li><p>Commit the transaction</p></li>
</ol>
<p>The <code class="docutils literal notranslate"><span class="pre">.transform()</span></code> method takes a number of parameters, all of which are optional.</p>
<p>As a bonus, calling <code class="docutils literal notranslate"><span class="pre">.transform()</span></code> will reformat the schema for the table that is stored in SQLite to make it more readable. This works even if you call it without any arguments.</p>
<p>To keep the original table around instead of dropping it, pass the <code class="docutils literal notranslate"><span class="pre">keep_table=</span></code> option and specify the name of the table you would like it to be renamed to:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">table</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">types</span><span class="o">=</span><span class="p">{</span><span class="s2">"age"</span><span class="p">:</span> <span class="nb">int</span><span class="p">},</span> <span class="n">keep_table</span><span class="o">=</span><span class="s2">"original_table"</span><span class="p">)</span>
</pre></div>
</div>
<section id="altering-column-types">
<h3><a class="toc-backref" href="#id46" role="doc-backlink">Altering column types</a><a class="headerlink" href="#altering-column-types" title="Link to this heading">#</a></h3>
<p>To alter the type of a column, use the <code class="docutils literal notranslate"><span class="pre">types=</span></code> argument:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Convert the 'age' column to an integer, and 'weight' to a float</span>
<span class="n">table</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">types</span><span class="o">=</span><span class="p">{</span><span class="s2">"age"</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s2">"weight"</span><span class="p">:</span> <span class="nb">float</span><span class="p">})</span>
</pre></div>
</div>
<p>See <a class="reference internal" href="#python-api-add-column"><span class="std std-ref">Adding columns</span></a> for a list of available types.</p>
</section>
<section id="renaming-columns">
<h3><a class="toc-backref" href="#id47" role="doc-backlink">Renaming columns</a><a class="headerlink" href="#renaming-columns" title="Link to this heading">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">rename=</span></code> parameter can rename columns:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Rename 'age' to 'initial_age':</span>
<span class="n">table</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">rename</span><span class="o">=</span><span class="p">{</span><span class="s2">"age"</span><span class="p">:</span> <span class="s2">"initial_age"</span><span class="p">})</span>
</pre></div>
</div>
</section>
<section id="dropping-columns">
<h3><a class="toc-backref" href="#id48" role="doc-backlink">Dropping columns</a><a class="headerlink" href="#dropping-columns" title="Link to this heading">#</a></h3>
<p>To drop columns, pass them in the <code class="docutils literal notranslate"><span class="pre">drop=</span></code> set:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Drop the 'age' column:</span>
<span class="n">table</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="p">{</span><span class="s2">"age"</span><span class="p">})</span>
</pre></div>
</div>
</section>
<section id="changing-primary-keys">
<h3><a class="toc-backref" href="#id49" role="doc-backlink">Changing primary keys</a><a class="headerlink" href="#changing-primary-keys" title="Link to this heading">#</a></h3>
<p>To change the primary key for a table, use <code class="docutils literal notranslate"><span class="pre">pk=</span></code>. This can be passed a single column for a regular primary key, or a tuple of columns to create a compound primary key. Passing <code class="docutils literal notranslate"><span class="pre">pk=None</span></code> will remove the primary key and convert the table into a <code class="docutils literal notranslate"><span class="pre">rowid</span></code> table.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Make `user_id` the new primary key</span>
<span class="n">table</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="s2">"user_id"</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="changing-not-null-status">
<h3><a class="toc-backref" href="#id50" role="doc-backlink">Changing not null status</a><a class="headerlink" href="#changing-not-null-status" title="Link to this heading">#</a></h3>
<p>You can change the <code class="docutils literal notranslate"><span class="pre">NOT</span> <span class="pre">NULL</span></code> status of columns by using <code class="docutils literal notranslate"><span class="pre">not_null=</span></code>. You can pass this a set of columns to make those columns <code class="docutils literal notranslate"><span class="pre">NOT</span> <span class="pre">NULL</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Make the 'age' and 'weight' columns NOT NULL</span>
<span class="n">table</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">not_null</span><span class="o">=</span><span class="p">{</span><span class="s2">"age"</span><span class="p">,</span> <span class="s2">"weight"</span><span class="p">})</span>
</pre></div>
</div>
<p>If you want to take existing <code class="docutils literal notranslate"><span class="pre">NOT</span> <span class="pre">NULL</span></code> columns and change them to allow null values, you can do so by passing a dictionary of true/false values instead:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 'age' is NOT NULL but we want to allow NULL:</span>
<span class="n">table</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">not_null</span><span class="o">=</span><span class="p">{</span><span class="s2">"age"</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>

<span class="c1"># Make age allow NULL and switch weight to being NOT NULL:</span>
<span class="n">table</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">not_null</span><span class="o">=</span><span class="p">{</span><span class="s2">"age"</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">"weight"</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
</pre></div>
</div>
</section>
<section id="altering-column-defaults">
<h3><a class="toc-backref" href="#id51" role="doc-backlink">Altering column defaults</a><a class="headerlink" href="#altering-column-defaults" title="Link to this heading">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">defaults=</span></code> parameter can be used to set or change the defaults for different columns:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set default age to 1:</span>
<span class="n">table</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">defaults</span><span class="o">=</span><span class="p">{</span><span class="s2">"age"</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>

<span class="c1"># Now remove the default from that column:</span>
<span class="n">table</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">defaults</span><span class="o">=</span><span class="p">{</span><span class="s2">"age"</span><span class="p">:</span> <span class="kc">None</span><span class="p">})</span>
</pre></div>
</div>
</section>
<section id="changing-column-order">
<h3><a class="toc-backref" href="#id52" role="doc-backlink">Changing column order</a><a class="headerlink" href="#changing-column-order" title="Link to this heading">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">column_order=</span></code> parameter can be used to change the order of the columns. If you pass the names of a subset of the columns those will go first and columns you omitted will appear in their existing order after them.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Change column order</span>
<span class="n">table</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">column_order</span><span class="o">=</span><span class="p">(</span><span class="s2">"name"</span><span class="p">,</span> <span class="s2">"age"</span><span class="p">,</span> <span class="s2">"id"</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="dropping-foreign-key-constraints">
<h3><a class="toc-backref" href="#id53" role="doc-backlink">Dropping foreign key constraints</a><a class="headerlink" href="#dropping-foreign-key-constraints" title="Link to this heading">#</a></h3>
<p>You can use <code class="docutils literal notranslate"><span class="pre">.transform()</span></code> to remove foreign key constraints from a table.</p>
<p>This example drops two foreign keys - the one from <code class="docutils literal notranslate"><span class="pre">places.country</span></code> to <code class="docutils literal notranslate"><span class="pre">country.id</span></code> and the one from <code class="docutils literal notranslate"><span class="pre">places.continent</span></code> to <code class="docutils literal notranslate"><span class="pre">continent.id</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">[</span><span class="s2">"places"</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
    <span class="n">drop_foreign_keys</span><span class="o">=</span><span class="p">(</span><span class="s2">"country"</span><span class="p">,</span> <span class="s2">"continent"</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="custom-transformations-with-transform-sql">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Custom transformations with .transform_sql()"></a><span id="python-api-transform-sql"></span><h3><a class="toc-backref" href="#id54" role="doc-backlink">Custom transformations with .transform_sql()</a><a class="headerlink" href="#custom-transformations-with-transform-sql" title="Link to this heading">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">.transform()</span></code> method can handle most cases, but it does not automatically upgrade indexes, views or triggers associated with the table that is being transformed.</p>
<p>If you want to do something more advanced, you can call the <code class="docutils literal notranslate"><span class="pre">table.transform_sql(...)</span></code> method with the same arguments that you would have passed to <code class="docutils literal notranslate"><span class="pre">table.transform(...)</span></code>.</p>
<p>This method will return a list of SQL statements that should be executed to implement the change. You can then make modifications to that SQL - or add additional SQL statements - before executing it yourself.</p>
</section>
</section>
<section id="extracting-columns-into-a-separate-table">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Extracting columns into a separate table"></a><span id="python-api-extract"></span><h2><a class="toc-backref" href="#id55" role="doc-backlink">Extracting columns into a separate table</a><a class="headerlink" href="#extracting-columns-into-a-separate-table" title="Link to this heading">#</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">table.extract()</span></code> method can be used to extract specified columns into a separate table.</p>
<p>Imagine a <code class="docutils literal notranslate"><span class="pre">Trees</span></code> table that looks like this:</p>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>id</p></th>
<th class="head"><p>TreeAddress</p></th>
<th class="head"><p>Species</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>1</p></td>
<td><p>52 Vine St</p></td>
<td><p>Palm</p></td>
</tr>
<tr class="row-odd"><td><p>2</p></td>
<td><p>12 Draft St</p></td>
<td><p>Oak</p></td>
</tr>
<tr class="row-even"><td><p>3</p></td>
<td><p>51 Dark Ave</p></td>
<td><p>Palm</p></td>
</tr>
<tr class="row-odd"><td><p>4</p></td>
<td><p>1252 Left St</p></td>
<td><p>Palm</p></td>
</tr>
</tbody>
</table>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">Species</span></code> column contains duplicate values. This database could be improved by extracting that column out into a separate <code class="docutils literal notranslate"><span class="pre">Species</span></code> table and pointing to it using a foreign key column.</p>
<p>The schema of the above table is:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="p">[</span><span class="n">Trees</span><span class="p">]</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">[</span><span class="n">id</span><span class="p">]</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="p">[</span><span class="n">TreeAddress</span><span class="p">]</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<span class="w">    </span><span class="p">[</span><span class="n">Species</span><span class="p">]</span><span class="w"> </span><span class="nb">TEXT</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Here’s how to extract the <code class="docutils literal notranslate"><span class="pre">Species</span></code> column using <code class="docutils literal notranslate"><span class="pre">.extract()</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">[</span><span class="s2">"Trees"</span><span class="p">]</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="s2">"Species"</span><span class="p">)</span>
</pre></div>
</div>
<p>After running this code the table schema now looks like this:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="ss">"Trees"</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">[</span><span class="n">id</span><span class="p">]</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="p">[</span><span class="n">TreeAddress</span><span class="p">]</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<span class="w">    </span><span class="p">[</span><span class="n">Species_id</span><span class="p">]</span><span class="w"> </span><span class="nb">INTEGER</span><span class="p">,</span>
<span class="w">    </span><span class="k">FOREIGN</span><span class="w"> </span><span class="k">KEY</span><span class="p">(</span><span class="n">Species_id</span><span class="p">)</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">Species</span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
<p>A new <code class="docutils literal notranslate"><span class="pre">Species</span></code> table will have been created with the following schema:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="p">[</span><span class="n">Species</span><span class="p">]</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">[</span><span class="n">id</span><span class="p">]</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="p">[</span><span class="n">Species</span><span class="p">]</span><span class="w"> </span><span class="nb">TEXT</span>
<span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">.extract()</span></code> method defaults to creating a table with the same name as the column that was extracted, and adding a foreign key column called <code class="docutils literal notranslate"><span class="pre">tablename_id</span></code>.</p>
<p>You can specify a custom table name using <code class="docutils literal notranslate"><span class="pre">table=</span></code>, and a custom foreign key name using <code class="docutils literal notranslate"><span class="pre">fk_column=</span></code>. This example creates a table called <code class="docutils literal notranslate"><span class="pre">tree_species</span></code> and a foreign key column called <code class="docutils literal notranslate"><span class="pre">tree_species_id</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">[</span><span class="s2">"Trees"</span><span class="p">]</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="s2">"Species"</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="s2">"tree_species"</span><span class="p">,</span> <span class="n">fk_column</span><span class="o">=</span><span class="s2">"tree_species_id"</span><span class="p">)</span>
</pre></div>
</div>
<p>The resulting schema looks like this:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="ss">"Trees"</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">[</span><span class="n">id</span><span class="p">]</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="p">[</span><span class="n">TreeAddress</span><span class="p">]</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<span class="w">    </span><span class="p">[</span><span class="n">tree_species_id</span><span class="p">]</span><span class="w"> </span><span class="nb">INTEGER</span><span class="p">,</span>
<span class="w">    </span><span class="k">FOREIGN</span><span class="w"> </span><span class="k">KEY</span><span class="p">(</span><span class="n">tree_species_id</span><span class="p">)</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">tree_species</span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
<span class="p">)</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="p">[</span><span class="n">tree_species</span><span class="p">]</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">[</span><span class="n">id</span><span class="p">]</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="p">[</span><span class="n">Species</span><span class="p">]</span><span class="w"> </span><span class="nb">TEXT</span>
<span class="p">)</span>
</pre></div>
</div>
<p>You can also extract multiple columns into the same external table. Say for example you have a table like this:</p>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>id</p></th>
<th class="head"><p>TreeAddress</p></th>
<th class="head"><p>CommonName</p></th>
<th class="head"><p>LatinName</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>1</p></td>
<td><p>52 Vine St</p></td>
<td><p>Palm</p></td>
<td><p>Arecaceae</p></td>
</tr>
<tr class="row-odd"><td><p>2</p></td>
<td><p>12 Draft St</p></td>
<td><p>Oak</p></td>
<td><p>Quercus</p></td>
</tr>
<tr class="row-even"><td><p>3</p></td>
<td><p>51 Dark Ave</p></td>
<td><p>Palm</p></td>
<td><p>Arecaceae</p></td>
</tr>
<tr class="row-odd"><td><p>4</p></td>
<td><p>1252 Left St</p></td>
<td><p>Palm</p></td>
<td><p>Arecaceae</p></td>
</tr>
</tbody>
</table>
</div>
<p>You can pass <code class="docutils literal notranslate"><span class="pre">["CommonName",</span> <span class="pre">"LatinName"]</span></code> to <code class="docutils literal notranslate"><span class="pre">.extract()</span></code> to extract both of those columns:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">[</span><span class="s2">"Trees"</span><span class="p">]</span><span class="o">.</span><span class="n">extract</span><span class="p">([</span><span class="s2">"CommonName"</span><span class="p">,</span> <span class="s2">"LatinName"</span><span class="p">])</span>
</pre></div>
</div>
<p>This produces the following schema:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="ss">"Trees"</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">[</span><span class="n">id</span><span class="p">]</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="p">[</span><span class="n">TreeAddress</span><span class="p">]</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<span class="w">    </span><span class="p">[</span><span class="n">CommonName_LatinName_id</span><span class="p">]</span><span class="w"> </span><span class="nb">INTEGER</span><span class="p">,</span>
<span class="w">    </span><span class="k">FOREIGN</span><span class="w"> </span><span class="k">KEY</span><span class="p">(</span><span class="n">CommonName_LatinName_id</span><span class="p">)</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">CommonName_LatinName</span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
<span class="p">)</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="p">[</span><span class="n">CommonName_LatinName</span><span class="p">]</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">[</span><span class="n">id</span><span class="p">]</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="p">[</span><span class="n">CommonName</span><span class="p">]</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<span class="w">    </span><span class="p">[</span><span class="n">LatinName</span><span class="p">]</span><span class="w"> </span><span class="nb">TEXT</span>
<span class="p">)</span>
</pre></div>
</div>
<p>The table name <code class="docutils literal notranslate"><span class="pre">CommonName_LatinName</span></code> is derived from the extract columns. You can use <code class="docutils literal notranslate"><span class="pre">table=</span></code> and <code class="docutils literal notranslate"><span class="pre">fk_column=</span></code> to specify custom names like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">[</span><span class="s2">"Trees"</span><span class="p">]</span><span class="o">.</span><span class="n">extract</span><span class="p">([</span><span class="s2">"CommonName"</span><span class="p">,</span> <span class="s2">"LatinName"</span><span class="p">],</span> <span class="n">table</span><span class="o">=</span><span class="s2">"Species"</span><span class="p">,</span> <span class="n">fk_column</span><span class="o">=</span><span class="s2">"species_id"</span><span class="p">)</span>
</pre></div>
</div>
<p>This produces the following schema:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="ss">"Trees"</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">[</span><span class="n">id</span><span class="p">]</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="p">[</span><span class="n">TreeAddress</span><span class="p">]</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<span class="w">    </span><span class="p">[</span><span class="n">species_id</span><span class="p">]</span><span class="w"> </span><span class="nb">INTEGER</span><span class="p">,</span>
<span class="w">    </span><span class="k">FOREIGN</span><span class="w"> </span><span class="k">KEY</span><span class="p">(</span><span class="n">species_id</span><span class="p">)</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">Species</span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
<span class="p">)</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="p">[</span><span class="n">Species</span><span class="p">]</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">[</span><span class="n">id</span><span class="p">]</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="p">[</span><span class="n">CommonName</span><span class="p">]</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<span class="w">    </span><span class="p">[</span><span class="n">LatinName</span><span class="p">]</span><span class="w"> </span><span class="nb">TEXT</span>
<span class="p">)</span>
</pre></div>
</div>
<p>You can use the <code class="docutils literal notranslate"><span class="pre">rename=</span></code> argument to rename columns in the lookup table. To create a <code class="docutils literal notranslate"><span class="pre">Species</span></code> table with columns called <code class="docutils literal notranslate"><span class="pre">name</span></code> and <code class="docutils literal notranslate"><span class="pre">latin</span></code> you can do this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">[</span><span class="s2">"Trees"</span><span class="p">]</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span>
    <span class="p">[</span><span class="s2">"CommonName"</span><span class="p">,</span> <span class="s2">"LatinName"</span><span class="p">],</span>
    <span class="n">table</span><span class="o">=</span><span class="s2">"Species"</span><span class="p">,</span>
    <span class="n">fk_column</span><span class="o">=</span><span class="s2">"species_id"</span><span class="p">,</span>
    <span class="n">rename</span><span class="o">=</span><span class="p">{</span><span class="s2">"CommonName"</span><span class="p">:</span> <span class="s2">"name"</span><span class="p">,</span> <span class="s2">"LatinName"</span><span class="p">:</span> <span class="s2">"latin"</span><span class="p">}</span>
<span class="p">)</span>
</pre></div>
</div>
<p>This produces a lookup table like so:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="p">[</span><span class="n">Species</span><span class="p">]</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">[</span><span class="n">id</span><span class="p">]</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<span class="w">    </span><span class="p">[</span><span class="n">latin</span><span class="p">]</span><span class="w"> </span><span class="nb">TEXT</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="setting-an-id-based-on-the-hash-of-the-row-contents">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Setting an ID based on the hash of the row contents"></a><span id="python-api-hash"></span><h2><a class="toc-backref" href="#id56" role="doc-backlink">Setting an ID based on the hash of the row contents</a><a class="headerlink" href="#setting-an-id-based-on-the-hash-of-the-row-contents" title="Link to this heading">#</a></h2>
<p>Sometimes you will find yourself working with a dataset that includes rows that do not have a provided obvious ID, but where you would like to assign one so that you can later upsert into that table without creating duplicate records.</p>
<p>In these cases, a useful technique is to create an ID that is derived from the sha1 hash of the row contents.</p>
<p><code class="docutils literal notranslate"><span class="pre">sqlite-utils</span></code> can do this for you using the <code class="docutils literal notranslate"><span class="pre">hash_id=</span></code> option. For example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>db = sqlite_utils.Database("dogs.db")
db["dogs"].upsert({"name": "Cleo", "twitter": "cleopaws"}, hash_id="id")
print(list(db["dogs]))
</pre></div>
</div>
<p>Outputs:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[{'id': 'f501265970505d9825d8d9f590bfab3519fb20b1', 'name': 'Cleo', 'twitter': 'cleopaws'}]
</pre></div>
</div>
<p>If you are going to use that ID straight away, you can access it using <code class="docutils literal notranslate"><span class="pre">last_pk</span></code>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>dog_id = db["dogs"].upsert({
    "name": "Cleo",
    "twitter": "cleopaws"
}, hash_id="id").last_pk
# dog_id is now "f501265970505d9825d8d9f590bfab3519fb20b1"
</pre></div>
</div>
<p>The hash will be created using all of the column values. To create a hash using a subset of the columns, pass the <code class="docutils literal notranslate"><span class="pre">hash_id_columns=</span></code> parameter:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>db["dogs"].upsert(
    {"name": "Cleo", "twitter": "cleopaws", "age": 7},
    hash_id_columns=("name", "twitter")
)
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">hash_id=</span></code> parameter is optional if you specify <code class="docutils literal notranslate"><span class="pre">hash_id_columns=</span></code> - it will default to putting the hash in a column called <code class="docutils literal notranslate"><span class="pre">id</span></code>.</p>
<p>You can manually calculate these hashes using the <a class="reference internal" href="reference.html#reference-utils-hash-record"><span class="std std-ref">hash_record(record, keys=…)</span></a> utility function.</p>
</section>
<section id="creating-views">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Creating views"></a><span id="python-api-create-view"></span><h2><a class="toc-backref" href="#id57" role="doc-backlink">Creating views</a><a class="headerlink" href="#creating-views" title="Link to this heading">#</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">.create_view()</span></code> method on the database class can be used to create a view:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">create_view</span><span class="p">(</span><span class="s2">"good_dogs"</span><span class="p">,</span> <span class="s2">"""</span>
<span class="s2">    select * from dogs where is_good_dog = 1</span>
<span class="s2">"""</span><span class="p">)</span>
</pre></div>
</div>
<p>This will raise a <code class="docutils literal notranslate"><span class="pre">sqlite_utils.utils.OperationalError</span></code> if a view with that name already exists.</p>
<p>You can pass <code class="docutils literal notranslate"><span class="pre">ignore=True</span></code> to silently ignore an existing view and do nothing, or <code class="docutils literal notranslate"><span class="pre">replace=True</span></code> to replace an existing view with a new definition if your select statement differs from the current view:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">create_view</span><span class="p">(</span><span class="s2">"good_dogs"</span><span class="p">,</span> <span class="s2">"""</span>
<span class="s2">    select * from dogs where is_good_dog = 1</span>
<span class="s2">"""</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="storing-json">
<h2><a class="toc-backref" href="#id58" role="doc-backlink">Storing JSON</a><a class="headerlink" href="#storing-json" title="Link to this heading">#</a></h2>
<p>SQLite has <a class="reference external" href="https://www.sqlite.org/json1.html">excellent JSON support</a>, and <code class="docutils literal notranslate"><span class="pre">sqlite-utils</span></code> can help you take advantage of this: if you attempt to insert a value that can be represented as a JSON list or dictionary, <code class="docutils literal notranslate"><span class="pre">sqlite-utils</span></code> will create TEXT column and store your data as serialized JSON. This means you can quickly store even complex data structures in SQLite and query them using JSON features.</p>
<p>For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">[</span><span class="s2">"niche_museums"</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">({</span>
    <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"The Bigfoot Discovery Museum"</span><span class="p">,</span>
    <span class="s2">"url"</span><span class="p">:</span> <span class="s2">"http://bigfootdiscoveryproject.com/"</span>
    <span class="s2">"hours"</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">"Monday"</span><span class="p">:</span> <span class="p">[</span><span class="mi">11</span><span class="p">,</span> <span class="mi">18</span><span class="p">],</span>
        <span class="s2">"Wednesday"</span><span class="p">:</span> <span class="p">[</span><span class="mi">11</span><span class="p">,</span> <span class="mi">18</span><span class="p">],</span>
        <span class="s2">"Thursday"</span><span class="p">:</span> <span class="p">[</span><span class="mi">11</span><span class="p">,</span> <span class="mi">18</span><span class="p">],</span>
        <span class="s2">"Friday"</span><span class="p">:</span> <span class="p">[</span><span class="mi">11</span><span class="p">,</span> <span class="mi">18</span><span class="p">],</span>
        <span class="s2">"Saturday"</span><span class="p">:</span> <span class="p">[</span><span class="mi">11</span><span class="p">,</span> <span class="mi">18</span><span class="p">],</span>
        <span class="s2">"Sunday"</span><span class="p">:</span> <span class="p">[</span><span class="mi">11</span><span class="p">,</span> <span class="mi">18</span><span class="p">]</span>
    <span class="p">},</span>
    <span class="s2">"address"</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">"streetAddress"</span><span class="p">:</span> <span class="s2">"5497 Highway 9"</span><span class="p">,</span>
        <span class="s2">"addressLocality"</span><span class="p">:</span> <span class="s2">"Felton, CA"</span><span class="p">,</span>
        <span class="s2">"postalCode"</span><span class="p">:</span> <span class="s2">"95018"</span>
    <span class="p">}</span>
<span class="p">})</span>
<span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">"""</span>
<span class="s2">    select json_extract(address, '$.addressLocality')</span>
<span class="s2">    from niche_museums</span>
<span class="s2">"""</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="c1"># Returns [('Felton, CA',)]</span>
</pre></div>
</div>
</section>
<section id="converting-column-values-using-sql-functions">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Converting column values using SQL functions"></a><span id="python-api-conversions"></span><h2><a class="toc-backref" href="#id59" role="doc-backlink">Converting column values using SQL functions</a><a class="headerlink" href="#converting-column-values-using-sql-functions" title="Link to this heading">#</a></h2>
<p>Sometimes it can be useful to run values through a SQL function prior to inserting them. A simple example might be converting a value to upper case while it is being inserted.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">conversions={...}</span></code> parameter can be used to specify custom SQL to be used as part of a <code class="docutils literal notranslate"><span class="pre">INSERT</span></code> or <code class="docutils literal notranslate"><span class="pre">UPDATE</span></code> SQL statement.</p>
<p>You can specify an upper case conversion for a specific column like so:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">[</span><span class="s2">"example"</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">({</span>
    <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"The Bigfoot Discovery Museum"</span>
<span class="p">},</span> <span class="n">conversions</span><span class="o">=</span><span class="p">{</span><span class="s2">"name"</span><span class="p">:</span> <span class="s2">"upper(?)"</span><span class="p">})</span>

<span class="c1"># list(db["example"].rows) now returns:</span>
<span class="c1"># [{'name': 'THE BIGFOOT DISCOVERY MUSEUM'}]</span>
</pre></div>
</div>
<p>The dictionary key is the column name to be converted. The value is the SQL fragment to use, with a <code class="docutils literal notranslate"><span class="pre">?</span></code> placeholder for the original value.</p>
<p>A more useful example: if you are working with <a class="reference external" href="https://www.gaia-gis.it/fossil/libspatialite/index">SpatiaLite</a> you may find yourself wanting to create geometry values from a WKT value. Code to do that could look like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="kn">import</span> <span class="nn">sqlite_utils</span>
<span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="kn">import</span> <span class="n">shape</span>
<span class="kn">import</span> <span class="nn">httpx</span>

<span class="n">db</span> <span class="o">=</span> <span class="n">sqlite_utils</span><span class="o">.</span><span class="n">Database</span><span class="p">(</span><span class="s2">"places.db"</span><span class="p">)</span>
<span class="c1"># Initialize SpatiaLite</span>
<span class="n">db</span><span class="o">.</span><span class="n">init_spatialite</span><span class="p">()</span>
<span class="c1"># Use sqlite-utils to create a places table</span>
<span class="n">places</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="s2">"places"</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s2">"id"</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s2">"name"</span><span class="p">:</span> <span class="nb">str</span><span class="p">})</span>

<span class="c1"># Add a SpatiaLite 'geometry' column</span>
<span class="n">places</span><span class="o">.</span><span class="n">add_geometry_column</span><span class="p">(</span><span class="s2">"geometry"</span><span class="p">,</span> <span class="s2">"MULTIPOLYGON"</span><span class="p">)</span>

<span class="c1"># Fetch some GeoJSON from Who's On First:</span>
<span class="n">geojson</span> <span class="o">=</span> <span class="n">httpx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
    <span class="s2">"https://raw.githubusercontent.com/whosonfirst-data/"</span>
    <span class="s2">"whosonfirst-data-admin-gb/master/data/404/227/475/404227475.geojson"</span>
<span class="p">)</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

<span class="c1"># Convert to "Well Known Text" format using shapely</span>
<span class="n">wkt</span> <span class="o">=</span> <span class="n">shape</span><span class="p">(</span><span class="n">geojson</span><span class="p">[</span><span class="s2">"geometry"</span><span class="p">])</span><span class="o">.</span><span class="n">wkt</span>

<span class="c1"># Insert the record, converting the WKT to a SpatiaLite geometry:</span>
<span class="n">db</span><span class="p">[</span><span class="s2">"places"</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
    <span class="p">{</span><span class="s2">"name"</span><span class="p">:</span> <span class="s2">"Wales"</span><span class="p">,</span> <span class="s2">"geometry"</span><span class="p">:</span> <span class="n">wkt</span><span class="p">},</span>
    <span class="n">conversions</span><span class="o">=</span><span class="p">{</span><span class="s2">"geometry"</span><span class="p">:</span> <span class="s2">"GeomFromText(?, 4326)"</span><span class="p">},</span>
<span class="p">)</span>
</pre></div>
</div>
<p>This example uses gographical data from [Who’s On First](<a class="reference external" href="https://whosonfirst.org/">https://whosonfirst.org/</a>) and depends on the [Shapely](<a class="reference external" href="https://shapely.readthedocs.io/en/stable/manual.html">https://shapely.readthedocs.io/en/stable/manual.html</a>) and [HTTPX](<a class="reference external" href="https://www.python-httpx.org/">https://www.python-httpx.org/</a>) Python libraries.</p>
</section>
<section id="checking-the-sqlite-version">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Checking the SQLite version"></a><span id="python-api-sqlite-version"></span><h2><a class="toc-backref" href="#id60" role="doc-backlink">Checking the SQLite version</a><a class="headerlink" href="#checking-the-sqlite-version" title="Link to this heading">#</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">db.sqlite_version</span></code> property returns a tuple of integers representing the version of SQLite used for that database object:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt; db.sqlite_version
(3, 36, 0)
</pre></div>
</div>
</section>
<section id="dumping-the-database-to-sql">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Dumping the database to SQL"></a><span id="python-api-itedump"></span><h2><a class="toc-backref" href="#id61" role="doc-backlink">Dumping the database to SQL</a><a class="headerlink" href="#dumping-the-database-to-sql" title="Link to this heading">#</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">db.iterdump()</span></code> method returns a sequence of SQL strings representing a complete dump of the database. Use it like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">full_sql</span> <span class="o">=</span> <span class="s2">""</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">iterdump</span><span class="p">())</span>
</pre></div>
</div>
<p>This uses the <a class="reference external" href="https://docs.python.org/3/library/sqlite3.html#sqlite3.Connection.iterdump">sqlite3.Connection.iterdump()</a> method.</p>
<p>If you are using <code class="docutils literal notranslate"><span class="pre">pysqlite3</span></code> or <code class="docutils literal notranslate"><span class="pre">sqlean.py</span></code> the underlying method may be missing. If you install the <a class="reference external" href="https://pypi.org/project/sqlite-dump/">sqlite-dump</a> package then the <code class="docutils literal notranslate"><span class="pre">db.iterdump()</span></code> method will use that implementation instead:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pip<span class="w"> </span>install<span class="w"> </span>sqlite-dump
</pre></div>
</div>
</section>
<section id="introspecting-tables-and-views">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Introspecting tables and views"></a><span id="python-api-introspection"></span><h2><a class="toc-backref" href="#id62" role="doc-backlink">Introspecting tables and views</a><a class="headerlink" href="#introspecting-tables-and-views" title="Link to this heading">#</a></h2>
<p>If you have loaded an existing table or view, you can use introspection to find out more about it:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt; db["PlantType"]
&lt;Table PlantType (id, value)&gt;
</pre></div>
</div>
<section id="exists">
<a class="dashAnchor" name="//apple_ref/cpp/Section/.exists()"></a><span id="python-api-introspection-exists"></span><h3><a class="toc-backref" href="#id63" role="doc-backlink">.exists()</a><a class="headerlink" href="#exists" title="Link to this heading">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">.exists()</span></code> method can be used to find out if a table exists or not:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt; db["PlantType"].exists()
True
&gt;&gt;&gt; db["PlantType2"].exists()
False
</pre></div>
</div>
</section>
<section id="count">
<a class="dashAnchor" name="//apple_ref/cpp/Section/.count"></a><span id="python-api-introspection-count"></span><h3><a class="toc-backref" href="#id64" role="doc-backlink">.count</a><a class="headerlink" href="#count" title="Link to this heading">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">.count</span></code> property shows the current number of rows (<code class="docutils literal notranslate"><span class="pre">select</span> <span class="pre">count(*)</span> <span class="pre">from</span> <span class="pre">table</span></code>):</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt; db["PlantType"].count
3
&gt;&gt;&gt; db["Street_Tree_List"].count
189144
</pre></div>
</div>
<p>This property will take advantage of <a class="reference internal" href="#python-api-cached-table-counts"><span class="std std-ref">Cached table counts using triggers</span></a> if the <code class="docutils literal notranslate"><span class="pre">use_counts_table</span></code> property is set on the database. You can avoid that optimization entirely by calling <code class="docutils literal notranslate"><span class="pre">table.count_where()</span></code> instead of accessing the property.</p>
</section>
<section id="columns">
<a class="dashAnchor" name="//apple_ref/cpp/Section/.columns"></a><span id="python-api-introspection-columns"></span><h3><a class="toc-backref" href="#id65" role="doc-backlink">.columns</a><a class="headerlink" href="#columns" title="Link to this heading">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">.columns</span></code> property shows the columns in the table or view. It returns a list of <code class="docutils literal notranslate"><span class="pre">Column(cid,</span> <span class="pre">name,</span> <span class="pre">type,</span> <span class="pre">notnull,</span> <span class="pre">default_value,</span> <span class="pre">is_pk)</span></code> named tuples.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt; db["PlantType"].columns
[Column(cid=0, name='id', type='INTEGER', notnull=0, default_value=None, is_pk=1),
 Column(cid=1, name='value', type='TEXT', notnull=0, default_value=None, is_pk=0)]
</pre></div>
</div>
</section>
<section id="columns-dict">
<a class="dashAnchor" name="//apple_ref/cpp/Section/.columns_dict"></a><span id="python-api-introspection-columns-dict"></span><h3><a class="toc-backref" href="#id66" role="doc-backlink">.columns_dict</a><a class="headerlink" href="#columns-dict" title="Link to this heading">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">.columns_dict</span></code> property returns a dictionary version of the columns with just the names and Python types:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt; db["PlantType"].columns_dict
{'id': &lt;class 'int'&gt;, 'value': &lt;class 'str'&gt;}
</pre></div>
</div>
</section>
<section id="default-values">
<a class="dashAnchor" name="//apple_ref/cpp/Section/.default_values"></a><span id="python-api-introspection-default-values"></span><h3><a class="toc-backref" href="#id67" role="doc-backlink">.default_values</a><a class="headerlink" href="#default-values" title="Link to this heading">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">.default_values</span></code> property returns a dictionary of default values for each column that has a default:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt; db["table_with_defaults"].default_values
{'score': 5}
</pre></div>
</div>
</section>
<section id="pks">
<a class="dashAnchor" name="//apple_ref/cpp/Section/.pks"></a><span id="python-api-introspection-pks"></span><h3><a class="toc-backref" href="#id68" role="doc-backlink">.pks</a><a class="headerlink" href="#pks" title="Link to this heading">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">.pks</span></code> property returns a list of strings naming the primary key columns for the table:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt; db["PlantType"].pks
['id']
</pre></div>
</div>
<p>If a table has no primary keys but is a <a class="reference external" href="https://www.sqlite.org/rowidtable.html">rowid table</a>, this property will return <code class="docutils literal notranslate"><span class="pre">['rowid']</span></code>.</p>
</section>
<section id="use-rowid">
<a class="dashAnchor" name="//apple_ref/cpp/Section/.use_rowid"></a><span id="python-api-introspection-use-rowid"></span><h3><a class="toc-backref" href="#id69" role="doc-backlink">.use_rowid</a><a class="headerlink" href="#use-rowid" title="Link to this heading">#</a></h3>
<p>Almost all SQLite tables have a <code class="docutils literal notranslate"><span class="pre">rowid</span></code> column, but a table with no explicitly defined primary keys must use that <code class="docutils literal notranslate"><span class="pre">rowid</span></code> as the primary key for identifying individual rows. The <code class="docutils literal notranslate"><span class="pre">.use_rowid</span></code> property checks to see if a table needs to use the <code class="docutils literal notranslate"><span class="pre">rowid</span></code> in this way - it returns <code class="docutils literal notranslate"><span class="pre">True</span></code> if the table has no explicitly defined primary keys and <code class="docutils literal notranslate"><span class="pre">False</span></code> otherwise.</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="p">[</span><span class="s2">"PlantType"</span><span class="p">]</span><span class="o">.</span><span class="n">use_rowid</span>
<span class="go">False</span>
</pre></div>
</div>
</section>
<section id="foreign-keys">
<a class="dashAnchor" name="//apple_ref/cpp/Section/.foreign_keys"></a><span id="python-api-introspection-foreign-keys"></span><h3><a class="toc-backref" href="#id70" role="doc-backlink">.foreign_keys</a><a class="headerlink" href="#foreign-keys" title="Link to this heading">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">.foreign_keys</span></code> property returns any foreign key relationships for the table, as a list of <code class="docutils literal notranslate"><span class="pre">ForeignKey(table,</span> <span class="pre">column,</span> <span class="pre">other_table,</span> <span class="pre">other_column)</span></code> named tuples. It is not available on views.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt; db["Street_Tree_List"].foreign_keys
[ForeignKey(table='Street_Tree_List', column='qLegalStatus', other_table='qLegalStatus', other_column='id'),
 ForeignKey(table='Street_Tree_List', column='qCareAssistant', other_table='qCareAssistant', other_column='id'),
 ForeignKey(table='Street_Tree_List', column='qSiteInfo', other_table='qSiteInfo', other_column='id'),
 ForeignKey(table='Street_Tree_List', column='qSpecies', other_table='qSpecies', other_column='id'),
 ForeignKey(table='Street_Tree_List', column='qCaretaker', other_table='qCaretaker', other_column='id'),
 ForeignKey(table='Street_Tree_List', column='PlantType', other_table='PlantType', other_column='id')]
</pre></div>
</div>
</section>
<section id="schema">
<a class="dashAnchor" name="//apple_ref/cpp/Section/.schema"></a><span id="python-api-introspection-schema"></span><h3><a class="toc-backref" href="#id71" role="doc-backlink">.schema</a><a class="headerlink" href="#schema" title="Link to this heading">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">.schema</span></code> property outputs the table’s schema as a SQL string:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt; print(db["Street_Tree_List"].schema)
CREATE TABLE "Street_Tree_List" (
"TreeID" INTEGER,
  "qLegalStatus" INTEGER,
  "qSpecies" INTEGER,
  "qAddress" TEXT,
  "SiteOrder" INTEGER,
  "qSiteInfo" INTEGER,
  "PlantType" INTEGER,
  "qCaretaker" INTEGER,
  "qCareAssistant" INTEGER,
  "PlantDate" TEXT,
  "DBH" INTEGER,
  "PlotSize" TEXT,
  "PermitNotes" TEXT,
  "XCoord" REAL,
  "YCoord" REAL,
  "Latitude" REAL,
  "Longitude" REAL,
  "Location" TEXT
,
FOREIGN KEY ("PlantType") REFERENCES [PlantType](id),
    FOREIGN KEY ("qCaretaker") REFERENCES [qCaretaker](id),
    FOREIGN KEY ("qSpecies") REFERENCES [qSpecies](id),
    FOREIGN KEY ("qSiteInfo") REFERENCES [qSiteInfo](id),
    FOREIGN KEY ("qCareAssistant") REFERENCES [qCareAssistant](id),
    FOREIGN KEY ("qLegalStatus") REFERENCES [qLegalStatus](id))
</pre></div>
</div>
</section>
<section id="strict">
<a class="dashAnchor" name="//apple_ref/cpp/Section/.strict"></a><span id="python-api-introspection-strict"></span><h3><a class="toc-backref" href="#id72" role="doc-backlink">.strict</a><a class="headerlink" href="#strict" title="Link to this heading">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">.strict</span></code> property identifies if the table is a <a class="reference external" href="https://www.sqlite.org/stricttables.html">SQLite STRICT table</a>.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt; db["ny_times_us_counties"].strict
False
</pre></div>
</div>
</section>
<section id="indexes">
<a class="dashAnchor" name="//apple_ref/cpp/Section/.indexes"></a><span id="python-api-introspection-indexes"></span><h3><a class="toc-backref" href="#id73" role="doc-backlink">.indexes</a><a class="headerlink" href="#indexes" title="Link to this heading">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">.indexes</span></code> property returns all indexes created for a table, as a list of <code class="docutils literal notranslate"><span class="pre">Index(seq,</span> <span class="pre">name,</span> <span class="pre">unique,</span> <span class="pre">origin,</span> <span class="pre">partial,</span> <span class="pre">columns)</span></code> named tuples. It is not available on views.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt; db["Street_Tree_List"].indexes
[Index(seq=0, name='"Street_Tree_List_qLegalStatus"', unique=0, origin='c', partial=0, columns=['qLegalStatus']),
 Index(seq=1, name='"Street_Tree_List_qCareAssistant"', unique=0, origin='c', partial=0, columns=['qCareAssistant']),
 Index(seq=2, name='"Street_Tree_List_qSiteInfo"', unique=0, origin='c', partial=0, columns=['qSiteInfo']),
 Index(seq=3, name='"Street_Tree_List_qSpecies"', unique=0, origin='c', partial=0, columns=['qSpecies']),
 Index(seq=4, name='"Street_Tree_List_qCaretaker"', unique=0, origin='c', partial=0, columns=['qCaretaker']),
 Index(seq=5, name='"Street_Tree_List_PlantType"', unique=0, origin='c', partial=0, columns=['PlantType'])]
</pre></div>
</div>
</section>
<section id="xindexes">
<a class="dashAnchor" name="//apple_ref/cpp/Section/.xindexes"></a><span id="python-api-introspection-xindexes"></span><h3><a class="toc-backref" href="#id74" role="doc-backlink">.xindexes</a><a class="headerlink" href="#xindexes" title="Link to this heading">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">.xindexes</span></code> property returns more detailed information about the indexes on the table, using the SQLite <a class="reference external" href="https://sqlite.org/pragma.html#pragma_index_xinfo">PRAGMA index_xinfo()</a> mechanism. It returns a list of <code class="docutils literal notranslate"><span class="pre">XIndex(name,</span> <span class="pre">columns)</span></code> named tuples, where <code class="docutils literal notranslate"><span class="pre">columns</span></code> is a list of <code class="docutils literal notranslate"><span class="pre">XIndexColumn(seqno,</span> <span class="pre">cid,</span> <span class="pre">name,</span> <span class="pre">desc,</span> <span class="pre">coll,</span> <span class="pre">key)</span></code> named tuples.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt; db["ny_times_us_counties"].xindexes
[
    XIndex(
        name='idx_ny_times_us_counties_date',
        columns=[
            XIndexColumn(seqno=0, cid=0, name='date', desc=1, coll='BINARY', key=1),
            XIndexColumn(seqno=1, cid=-1, name=None, desc=0, coll='BINARY', key=0)
        ]
    ),
    XIndex(
        name='idx_ny_times_us_counties_fips',
        columns=[
            XIndexColumn(seqno=0, cid=3, name='fips', desc=0, coll='BINARY', key=1),
            XIndexColumn(seqno=1, cid=-1, name=None, desc=0, coll='BINARY', key=0)
        ]
    )
]
</pre></div>
</div>
</section>
<section id="triggers">
<a class="dashAnchor" name="//apple_ref/cpp/Section/.triggers"></a><span id="python-api-introspection-triggers"></span><h3><a class="toc-backref" href="#id75" role="doc-backlink">.triggers</a><a class="headerlink" href="#triggers" title="Link to this heading">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">.triggers</span></code> property lists database triggers. It can be used on both database and table objects. It returns a list of <code class="docutils literal notranslate"><span class="pre">Trigger(name,</span> <span class="pre">table,</span> <span class="pre">sql)</span></code> named tuples.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt; db["authors"].triggers
[Trigger(name='authors_ai', table='authors', sql='CREATE TRIGGER [authors_ai] AFTER INSERT...'),
 Trigger(name='authors_ad', table='authors', sql="CREATE TRIGGER [authors_ad] AFTER DELETE..."),
 Trigger(name='authors_au', table='authors', sql="CREATE TRIGGER [authors_au] AFTER UPDATE")]
&gt;&gt;&gt; db.triggers
... similar output to db["authors"].triggers
</pre></div>
</div>
</section>
<section id="triggers-dict">
<a class="dashAnchor" name="//apple_ref/cpp/Section/.triggers_dict"></a><span id="python-api-introspection-triggers-dict"></span><h3><a class="toc-backref" href="#id76" role="doc-backlink">.triggers_dict</a><a class="headerlink" href="#triggers-dict" title="Link to this heading">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">.triggers_dict</span></code> property returns the triggers for that table as a dictionary mapping their names to their SQL definitions.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt; db["authors"].triggers_dict
{'authors_ai': 'CREATE TRIGGER [authors_ai] AFTER INSERT...',
 'authors_ad': 'CREATE TRIGGER [authors_ad] AFTER DELETE...',
 'authors_au': 'CREATE TRIGGER [authors_au] AFTER UPDATE'}
</pre></div>
</div>
<p>The same property exists on the database, and will return all triggers across all tables:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt; db.triggers_dict
{'authors_ai': 'CREATE TRIGGER [authors_ai] AFTER INSERT...',
 'authors_ad': 'CREATE TRIGGER [authors_ad] AFTER DELETE...',
 'authors_au': 'CREATE TRIGGER [authors_au] AFTER UPDATE'}
</pre></div>
</div>
</section>
<section id="detect-fts">
<a class="dashAnchor" name="//apple_ref/cpp/Section/.detect_fts()"></a><span id="python-api-introspection-detect-fts"></span><h3><a class="toc-backref" href="#id77" role="doc-backlink">.detect_fts()</a><a class="headerlink" href="#detect-fts" title="Link to this heading">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">detect_fts()</span></code> method returns the associated SQLite FTS table name, if one exists for this table. If the table has not been configured for full-text search it returns <code class="docutils literal notranslate"><span class="pre">None</span></code>.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt; db["authors"].detect_fts()
"authors_fts"
</pre></div>
</div>
</section>
<section id="virtual-table-using">
<a class="dashAnchor" name="//apple_ref/cpp/Section/.virtual_table_using"></a><span id="python-api-introspection-virtual-table-using"></span><h3><a class="toc-backref" href="#id78" role="doc-backlink">.virtual_table_using</a><a class="headerlink" href="#virtual-table-using" title="Link to this heading">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">.virtual_table_using</span></code> property reveals if a table is a virtual table. It returns <code class="docutils literal notranslate"><span class="pre">None</span></code> for regular tables and the upper case version of the type of virtual table otherwise. For example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt; db["authors"].enable_fts(["name"])
&gt;&gt;&gt; db["authors_fts"].virtual_table_using
"FTS5"
</pre></div>
</div>
</section>
<section id="has-counts-triggers">
<a class="dashAnchor" name="//apple_ref/cpp/Section/.has_counts_triggers"></a><span id="python-api-introspection-has-counts-triggers"></span><h3><a class="toc-backref" href="#id79" role="doc-backlink">.has_counts_triggers</a><a class="headerlink" href="#has-counts-triggers" title="Link to this heading">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">.has_counts_triggers</span></code> property shows if a table has been configured with triggers for updating a <code class="docutils literal notranslate"><span class="pre">_counts</span></code> table, as described in <a class="reference internal" href="#python-api-cached-table-counts"><span class="std std-ref">Cached table counts using triggers</span></a>.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt; db["authors"].has_counts_triggers
False
&gt;&gt;&gt; db["authors"].enable_counts()
&gt;&gt;&gt; db["authors"].has_counts_triggers
True
</pre></div>
</div>
</section>
</section>
<section id="full-text-search">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Full-text search"></a><span id="python-api-fts"></span><h2><a class="toc-backref" href="#id80" role="doc-backlink">Full-text search</a><a class="headerlink" href="#full-text-search" title="Link to this heading">#</a></h2>
<p>SQLite includes bundled extensions that implement <a class="reference external" href="https://www.sqlite.org/fts5.html">powerful full-text search</a>.</p>
<section id="enabling-full-text-search-for-a-table">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Enabling full-text search for a table"></a><span id="python-api-fts-enable"></span><h3><a class="toc-backref" href="#id81" role="doc-backlink">Enabling full-text search for a table</a><a class="headerlink" href="#enabling-full-text-search-for-a-table" title="Link to this heading">#</a></h3>
<p>You can enable full-text search on a table using <code class="docutils literal notranslate"><span class="pre">.enable_fts(columns)</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">[</span><span class="s2">"dogs"</span><span class="p">]</span><span class="o">.</span><span class="n">enable_fts</span><span class="p">([</span><span class="s2">"name"</span><span class="p">,</span> <span class="s2">"twitter"</span><span class="p">])</span>
</pre></div>
</div>
<p>You can then run searches using the <code class="docutils literal notranslate"><span class="pre">.search()</span></code> method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rows</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">db</span><span class="p">[</span><span class="s2">"dogs"</span><span class="p">]</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">"cleo"</span><span class="p">))</span>
</pre></div>
</div>
<p>This method returns a generator that can be looped over to get dictionaries for each row, similar to <a class="reference internal" href="#python-api-rows"><span class="std std-ref">Listing rows</span></a>.</p>
<p>If you insert additional records into the table you will need to refresh the search index using <code class="docutils literal notranslate"><span class="pre">populate_fts()</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">[</span><span class="s2">"dogs"</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">({</span>
    <span class="s2">"id"</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"Marnie"</span><span class="p">,</span>
    <span class="s2">"twitter"</span><span class="p">:</span> <span class="s2">"MarnieTheDog"</span><span class="p">,</span>
    <span class="s2">"age"</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span>
    <span class="s2">"is_good_dog"</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">},</span> <span class="n">pk</span><span class="o">=</span><span class="s2">"id"</span><span class="p">)</span>
<span class="n">db</span><span class="p">[</span><span class="s2">"dogs"</span><span class="p">]</span><span class="o">.</span><span class="n">populate_fts</span><span class="p">([</span><span class="s2">"name"</span><span class="p">,</span> <span class="s2">"twitter"</span><span class="p">])</span>
</pre></div>
</div>
<p>A better solution is to use database triggers. You can set up database triggers to automatically update the full-text index using <code class="docutils literal notranslate"><span class="pre">create_triggers=True</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">[</span><span class="s2">"dogs"</span><span class="p">]</span><span class="o">.</span><span class="n">enable_fts</span><span class="p">([</span><span class="s2">"name"</span><span class="p">,</span> <span class="s2">"twitter"</span><span class="p">],</span> <span class="n">create_triggers</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">.enable_fts()</span></code> defaults to using <a class="reference external" href="https://www.sqlite.org/fts5.html">FTS5</a>. If you wish to use <a class="reference external" href="https://www.sqlite.org/fts3.html">FTS4</a> instead, use the following:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">[</span><span class="s2">"dogs"</span><span class="p">]</span><span class="o">.</span><span class="n">enable_fts</span><span class="p">([</span><span class="s2">"name"</span><span class="p">,</span> <span class="s2">"twitter"</span><span class="p">],</span> <span class="n">fts_version</span><span class="o">=</span><span class="s2">"FTS4"</span><span class="p">)</span>
</pre></div>
</div>
<p>You can customize the tokenizer configured for the table using the <code class="docutils literal notranslate"><span class="pre">tokenize=</span></code> parameter. For example, to enable Porter stemming, where English words like “running” will match stemmed alternatives such as “run”, use <code class="docutils literal notranslate"><span class="pre">tokenize="porter"</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">[</span><span class="s2">"articles"</span><span class="p">]</span><span class="o">.</span><span class="n">enable_fts</span><span class="p">([</span><span class="s2">"headline"</span><span class="p">,</span> <span class="s2">"body"</span><span class="p">],</span> <span class="n">tokenize</span><span class="o">=</span><span class="s2">"porter"</span><span class="p">)</span>
</pre></div>
</div>
<p>The SQLite documentation has more on <a class="reference external" href="https://www.sqlite.org/fts5.html#tokenizers">FTS5 tokenizers</a> and <a class="reference external" href="https://www.sqlite.org/fts3.html#tokenizer">FTS4 tokenizers</a>. <code class="docutils literal notranslate"><span class="pre">porter</span></code> is a valid option for both.</p>
<p>If you attempt to configure a FTS table where one already exists, a <code class="docutils literal notranslate"><span class="pre">sqlite3.OperationalError</span></code> exception will be raised.</p>
<p>You can replace the existing table with a new configuration using <code class="docutils literal notranslate"><span class="pre">replace=True</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">[</span><span class="s2">"articles"</span><span class="p">]</span><span class="o">.</span><span class="n">enable_fts</span><span class="p">([</span><span class="s2">"headline"</span><span class="p">],</span> <span class="n">tokenize</span><span class="o">=</span><span class="s2">"porter"</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>This will have no effect if the FTS table already exists, otherwise it will drop and recreate the table with the new settings. This takes into consideration the columns, the tokenizer, the FTS version used and whether or not the table has triggers.</p>
<p>To remove the FTS tables and triggers you created, use the <code class="docutils literal notranslate"><span class="pre">disable_fts()</span></code> table method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">[</span><span class="s2">"dogs"</span><span class="p">]</span><span class="o">.</span><span class="n">disable_fts</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="quoting-characters-for-use-in-search">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Quoting characters for use in search"></a><span id="python-api-quote-fts"></span><h3><a class="toc-backref" href="#id82" role="doc-backlink">Quoting characters for use in search</a><a class="headerlink" href="#quoting-characters-for-use-in-search" title="Link to this heading">#</a></h3>
<p>SQLite supports <a class="reference external" href="https://www.sqlite.org/fts3.html#full_text_index_queries">advanced search query syntax</a>. In some situations you may wish to disable this, since characters such as <code class="docutils literal notranslate"><span class="pre">.</span></code> may have special meaning that causes errors when searching for strings provided by your users.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">db.quote_fts(query)</span></code> method returns the query with SQLite full-text search quoting applied such that the query should be safe to use in a search:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>db.quote_fts("Search term.")
# Returns: '"Search" "term."'
</pre></div>
</div>
</section>
<section id="searching-with-table-search">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Searching with table.search()"></a><span id="python-api-fts-search"></span><h3><a class="toc-backref" href="#id83" role="doc-backlink">Searching with table.search()</a><a class="headerlink" href="#searching-with-table-search" title="Link to this heading">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">table.search(q)</span></code> method returns a generator over Python dictionaries representing rows that match the search phrase <code class="docutils literal notranslate"><span class="pre">q</span></code>, ordered by relevance with the most relevant results first.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">article</span> <span class="ow">in</span> <span class="n">db</span><span class="p">[</span><span class="s2">"articles"</span><span class="p">]</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">"jquery"</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">article</span><span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">.search()</span></code> method also accepts the following optional parameters:</p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">order_by</span></code> string</dt><dd><p>The column to sort by. Defaults to relevance score. Can optionally include a <code class="docutils literal notranslate"><span class="pre">desc</span></code>, e.g. <code class="docutils literal notranslate"><span class="pre">rowid</span> <span class="pre">desc</span></code>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">columns</span></code> array of strings</dt><dd><p>Columns to return. Defaults to all columns.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">limit</span></code> integer</dt><dd><p>Number of results to return. Defaults to all results.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">offset</span></code> integer</dt><dd><p>Offset to use along side the limit parameter.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">where</span></code> string</dt><dd><p>Extra SQL fragment for the WHERE clause</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">where_args</span></code> dictionary</dt><dd><p>Arguments to use for <code class="docutils literal notranslate"><span class="pre">:param</span></code> placeholders in the extra WHERE clause</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">quote</span></code> bool</dt><dd><p>Apply <a class="reference internal" href="#python-api-quote-fts"><span class="std std-ref">FTS quoting rules</span></a> to the search query, disabling advanced query syntax in a way that avoids surprising errors.</p>
</dd>
</dl>
<p>To return just the title and published columns for three matches for <code class="docutils literal notranslate"><span class="pre">"dog"</span></code> where the <code class="docutils literal notranslate"><span class="pre">id</span></code> is greater than 10 ordered by <code class="docutils literal notranslate"><span class="pre">published</span></code> with the most recent first, use the following:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">article</span> <span class="ow">in</span> <span class="n">db</span><span class="p">[</span><span class="s2">"articles"</span><span class="p">]</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
    <span class="s2">"dog"</span><span class="p">,</span>
    <span class="n">order_by</span><span class="o">=</span><span class="s2">"published desc"</span><span class="p">,</span>
    <span class="n">limit</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">where</span><span class="o">=</span><span class="s2">"id &gt; :min_id"</span><span class="p">,</span>
    <span class="n">where_args</span><span class="o">=</span><span class="p">{</span><span class="s2">"min_id"</span><span class="p">:</span> <span class="mi">10</span><span class="p">},</span>
    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">"title"</span><span class="p">,</span> <span class="s2">"published"</span><span class="p">]</span>
<span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">article</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="building-sql-queries-with-table-search-sql">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Building SQL queries with table.search_sql()"></a><span id="python-api-fts-search-sql"></span><h3><a class="toc-backref" href="#id84" role="doc-backlink">Building SQL queries with table.search_sql()</a><a class="headerlink" href="#building-sql-queries-with-table-search-sql" title="Link to this heading">#</a></h3>
<p>You can generate the SQL query that would be used for a search using the <code class="docutils literal notranslate"><span class="pre">table.search_sql()</span></code> method. It takes the same arguments as <code class="docutils literal notranslate"><span class="pre">table.search()</span></code>, with the exception of the search query and the <code class="docutils literal notranslate"><span class="pre">where_args</span></code> parameter, since those should be provided when the returned SQL is executed.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">db</span><span class="p">[</span><span class="s2">"articles"</span><span class="p">]</span><span class="o">.</span><span class="n">search_sql</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">"title"</span><span class="p">,</span> <span class="s2">"author"</span><span class="p">]))</span>
</pre></div>
</div>
<p>Outputs:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">with</span><span class="w"> </span><span class="n">original</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">select</span>
<span class="w">        </span><span class="n">rowid</span><span class="p">,</span>
<span class="w">        </span><span class="p">[</span><span class="n">title</span><span class="p">],</span>
<span class="w">        </span><span class="p">[</span><span class="n">author</span><span class="p">]</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="p">[</span><span class="n">articles</span><span class="p">]</span>
<span class="p">)</span>
<span class="k">select</span>
<span class="w">    </span><span class="p">[</span><span class="n">original</span><span class="p">].[</span><span class="n">title</span><span class="p">],</span>
<span class="w">    </span><span class="p">[</span><span class="n">original</span><span class="p">].[</span><span class="n">author</span><span class="p">]</span>
<span class="k">from</span>
<span class="w">    </span><span class="p">[</span><span class="n">original</span><span class="p">]</span>
<span class="w">    </span><span class="k">join</span><span class="w"> </span><span class="p">[</span><span class="n">articles_fts</span><span class="p">]</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="p">[</span><span class="n">original</span><span class="p">].</span><span class="n">rowid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">articles_fts</span><span class="p">].</span><span class="n">rowid</span>
<span class="k">where</span>
<span class="w">    </span><span class="p">[</span><span class="n">articles_fts</span><span class="p">]</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="p">:</span><span class="n">query</span>
<span class="k">order</span><span class="w"> </span><span class="k">by</span>
<span class="w">    </span><span class="p">[</span><span class="n">articles_fts</span><span class="p">].</span><span class="n">rank</span>
</pre></div>
</div>
<p>This method detects if a SQLite table uses FTS4 or FTS5, and outputs the correct SQL for ordering by relevance depending on the search type.</p>
<p>The FTS4 output looks something like this:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">with</span><span class="w"> </span><span class="n">original</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">select</span>
<span class="w">        </span><span class="n">rowid</span><span class="p">,</span>
<span class="w">        </span><span class="p">[</span><span class="n">title</span><span class="p">],</span>
<span class="w">        </span><span class="p">[</span><span class="n">author</span><span class="p">]</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="p">[</span><span class="n">articles</span><span class="p">]</span>
<span class="p">)</span>
<span class="k">select</span>
<span class="w">    </span><span class="p">[</span><span class="n">original</span><span class="p">].[</span><span class="n">title</span><span class="p">],</span>
<span class="w">    </span><span class="p">[</span><span class="n">original</span><span class="p">].[</span><span class="n">author</span><span class="p">]</span>
<span class="k">from</span>
<span class="w">    </span><span class="p">[</span><span class="n">original</span><span class="p">]</span>
<span class="w">    </span><span class="k">join</span><span class="w"> </span><span class="p">[</span><span class="n">articles_fts</span><span class="p">]</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="p">[</span><span class="n">original</span><span class="p">].</span><span class="n">rowid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">articles_fts</span><span class="p">].</span><span class="n">rowid</span>
<span class="k">where</span>
<span class="w">    </span><span class="p">[</span><span class="n">articles_fts</span><span class="p">]</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="p">:</span><span class="n">query</span>
<span class="k">order</span><span class="w"> </span><span class="k">by</span>
<span class="w">    </span><span class="n">rank_bm25</span><span class="p">(</span><span class="n">matchinfo</span><span class="p">([</span><span class="n">articles_fts</span><span class="p">],</span><span class="w"> </span><span class="s1">'pcnalx'</span><span class="p">))</span>
</pre></div>
</div>
<p>This uses the <code class="docutils literal notranslate"><span class="pre">rank_bm25()</span></code> custom SQL function from <a class="reference external" href="https://github.com/simonw/sqlite-fts4">sqlite-fts4</a>. You can register that custom function against a <code class="docutils literal notranslate"><span class="pre">Database</span></code> connection using this method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">register_fts4_bm25</span><span class="p">()</span>
</pre></div>
</div>
</section>
</section>
<section id="rebuilding-a-full-text-search-table">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Rebuilding a full-text search table"></a><span id="python-api-fts-rebuild"></span><h2><a class="toc-backref" href="#id85" role="doc-backlink">Rebuilding a full-text search table</a><a class="headerlink" href="#rebuilding-a-full-text-search-table" title="Link to this heading">#</a></h2>
<p>You can rebuild a table using the <code class="docutils literal notranslate"><span class="pre">table.rebuild_fts()</span></code> method. This is useful for if the table configuration changes or the indexed data has become corrupted in some way.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">[</span><span class="s2">"dogs"</span><span class="p">]</span><span class="o">.</span><span class="n">rebuild_fts</span><span class="p">()</span>
</pre></div>
</div>
<p>This method can be called on a table that has been configured for full-text search - <code class="docutils literal notranslate"><span class="pre">dogs</span></code> in this instance -  or directly on a <code class="docutils literal notranslate"><span class="pre">_fts</span></code> table:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">[</span><span class="s2">"dogs_fts"</span><span class="p">]</span><span class="o">.</span><span class="n">rebuild_fts</span><span class="p">()</span>
</pre></div>
</div>
<p>This runs the following SQL:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>INSERT INTO dogs_fts (dogs_fts) VALUES ("rebuild");
</pre></div>
</div>
</section>
<section id="optimizing-a-full-text-search-table">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Optimizing a full-text search table"></a><span id="python-api-fts-optimize"></span><h2><a class="toc-backref" href="#id86" role="doc-backlink">Optimizing a full-text search table</a><a class="headerlink" href="#optimizing-a-full-text-search-table" title="Link to this heading">#</a></h2>
<p>Once you have populated a FTS table you can optimize it to dramatically reduce its size like so:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">[</span><span class="s2">"dogs"</span><span class="p">]</span><span class="o">.</span><span class="n">optimize</span><span class="p">()</span>
</pre></div>
</div>
<p>This runs the following SQL:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>INSERT INTO dogs_fts (dogs_fts) VALUES ("optimize");
</pre></div>
</div>
</section>
<section id="cached-table-counts-using-triggers">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Cached table counts using triggers"></a><span id="python-api-cached-table-counts"></span><h2><a class="toc-backref" href="#id87" role="doc-backlink">Cached table counts using triggers</a><a class="headerlink" href="#cached-table-counts-using-triggers" title="Link to this heading">#</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">select</span> <span class="pre">count(*)</span></code> query in SQLite requires a full scan of the primary key index, and can take an increasingly long time as the table grows larger.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">table.enable_counts()</span></code> method can be used to configure triggers to continuously update a record in a <code class="docutils literal notranslate"><span class="pre">_counts</span></code> table. This value can then be used to quickly retrieve the count of rows in the associated table.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">[</span><span class="s2">"dogs"</span><span class="p">]</span><span class="o">.</span><span class="n">enable_counts</span><span class="p">()</span>
</pre></div>
</div>
<p>This will create the <code class="docutils literal notranslate"><span class="pre">_counts</span></code> table if it does not already exist, with the following schema:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="p">[</span><span class="n">_counts</span><span class="p">]</span><span class="w"> </span><span class="p">(</span>
<span class="w">   </span><span class="p">[</span><span class="k">table</span><span class="p">]</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">   </span><span class="p">[</span><span class="k">count</span><span class="p">]</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">0</span>
<span class="p">)</span>
</pre></div>
</div>
<p>You can enable cached counts for every table in a database (except for virtual tables and the <code class="docutils literal notranslate"><span class="pre">_counts</span></code> table itself) using the database <code class="docutils literal notranslate"><span class="pre">enable_counts()</span></code> method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">enable_counts</span><span class="p">()</span>
</pre></div>
</div>
<p>Once enabled, table counts will be stored in the <code class="docutils literal notranslate"><span class="pre">_counts</span></code> table. The count records will be automatically kept up-to-date by the triggers when rows are added or deleted to the table.</p>
<p>To access these counts you can query the <code class="docutils literal notranslate"><span class="pre">_counts</span></code> table directly or you can use the <code class="docutils literal notranslate"><span class="pre">db.cached_counts()</span></code> method. This method returns a dictionary mapping tables to their counts:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt; db.cached_counts()
{'global-power-plants': 33643,
 'global-power-plants_fts_data': 136,
 'global-power-plants_fts_idx': 199,
 'global-power-plants_fts_docsize': 33643,
 'global-power-plants_fts_config': 1}
</pre></div>
</div>
<p>You can pass a list of table names to this method to retrieve just those counts:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt; db.cached_counts(["global-power-plants"])
{'global-power-plants': 33643}
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">table.count</span></code> property executes a <code class="docutils literal notranslate"><span class="pre">select</span> <span class="pre">count(*)</span></code> query by default, unless the <code class="docutils literal notranslate"><span class="pre">db.use_counts_table</span></code> property is set to <code class="docutils literal notranslate"><span class="pre">True</span></code>.</p>
<p>You can set <code class="docutils literal notranslate"><span class="pre">use_counts_table</span></code> to <code class="docutils literal notranslate"><span class="pre">True</span></code> when you instantiate the database object:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">Database</span><span class="p">(</span><span class="s2">"global-power-plants.db"</span><span class="p">,</span> <span class="n">use_counts_table</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>If the property is <code class="docutils literal notranslate"><span class="pre">True</span></code> any calls to the <code class="docutils literal notranslate"><span class="pre">table.count</span></code> property will first attempt to find the cached count in the <code class="docutils literal notranslate"><span class="pre">_counts</span></code> table, and fall back on a <code class="docutils literal notranslate"><span class="pre">count(*)</span></code> query if the value is not available or the table is missing.</p>
<p>Calling the <code class="docutils literal notranslate"><span class="pre">.enable_counts()</span></code> method on a database or table object will set <code class="docutils literal notranslate"><span class="pre">use_counts_table</span></code> to <code class="docutils literal notranslate"><span class="pre">True</span></code> for the lifetime of that database object.</p>
<p>If the <code class="docutils literal notranslate"><span class="pre">_counts</span></code> table ever becomes out-of-sync with the actual table counts you can repair it using the <code class="docutils literal notranslate"><span class="pre">.reset_counts()</span></code> method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">reset_counts</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="creating-indexes">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Creating indexes"></a><span id="python-api-create-index"></span><h2><a class="toc-backref" href="#id88" role="doc-backlink">Creating indexes</a><a class="headerlink" href="#creating-indexes" title="Link to this heading">#</a></h2>
<p>You can create an index on a table using the <code class="docutils literal notranslate"><span class="pre">.create_index(columns)</span></code> method. The method takes a list of columns:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">[</span><span class="s2">"dogs"</span><span class="p">]</span><span class="o">.</span><span class="n">create_index</span><span class="p">([</span><span class="s2">"is_good_dog"</span><span class="p">])</span>
</pre></div>
</div>
<p>By default the index will be named <code class="docutils literal notranslate"><span class="pre">idx_{table-name}_{columns}</span></code>. If you pass <code class="docutils literal notranslate"><span class="pre">find_unique_name=True</span></code> and the automatically derived name already exists, an available name will be found by incrementing a suffix number, for example <code class="docutils literal notranslate"><span class="pre">idx_items_title_2</span></code>.</p>
<p>You can customize the name of the created index by passing the <code class="docutils literal notranslate"><span class="pre">index_name</span></code> parameter:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">[</span><span class="s2">"dogs"</span><span class="p">]</span><span class="o">.</span><span class="n">create_index</span><span class="p">(</span>
    <span class="p">[</span><span class="s2">"is_good_dog"</span><span class="p">,</span> <span class="s2">"age"</span><span class="p">],</span>
    <span class="n">index_name</span><span class="o">=</span><span class="s2">"good_dogs_by_age"</span>
<span class="p">)</span>
</pre></div>
</div>
<p>To create an index in descending order for a column, wrap the column name in <code class="docutils literal notranslate"><span class="pre">db.DescIndex()</span></code> like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlite_utils.db</span> <span class="kn">import</span> <span class="n">DescIndex</span>

<span class="n">db</span><span class="p">[</span><span class="s2">"dogs"</span><span class="p">]</span><span class="o">.</span><span class="n">create_index</span><span class="p">(</span>
    <span class="p">[</span><span class="s2">"is_good_dog"</span><span class="p">,</span> <span class="n">DescIndex</span><span class="p">(</span><span class="s2">"age"</span><span class="p">)],</span>
    <span class="n">index_name</span><span class="o">=</span><span class="s2">"good_dogs_by_age"</span>
<span class="p">)</span>
</pre></div>
</div>
<p>You can create a unique index by passing <code class="docutils literal notranslate"><span class="pre">unique=True</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">[</span><span class="s2">"dogs"</span><span class="p">]</span><span class="o">.</span><span class="n">create_index</span><span class="p">([</span><span class="s2">"name"</span><span class="p">],</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>Use <code class="docutils literal notranslate"><span class="pre">if_not_exists=True</span></code> to do nothing if an index with that name already exists.</p>
<p>Pass <code class="docutils literal notranslate"><span class="pre">analyze=True</span></code> to run <code class="docutils literal notranslate"><span class="pre">ANALYZE</span></code> against the new index after creating it.</p>
</section>
<section id="optimizing-index-usage-with-analyze">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Optimizing index usage with ANALYZE"></a><span id="python-api-analyze"></span><h2><a class="toc-backref" href="#id89" role="doc-backlink">Optimizing index usage with ANALYZE</a><a class="headerlink" href="#optimizing-index-usage-with-analyze" title="Link to this heading">#</a></h2>
<p>The <a class="reference external" href="https://www.sqlite.org/lang_analyze.html">SQLite ANALYZE command</a> builds a table of statistics which the query planner can use to make better decisions about which indexes to use for a given query.</p>
<p>You should run <code class="docutils literal notranslate"><span class="pre">ANALYZE</span></code> if your database is large and you do not think your indexes are being efficiently used.</p>
<p>To run <code class="docutils literal notranslate"><span class="pre">ANALYZE</span></code> against every index in a database, use this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">analyze</span><span class="p">()</span>
</pre></div>
</div>
<p>To run it just against a specific named index, pass the name of the index to that method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">analyze</span><span class="p">(</span><span class="s2">"idx_countries_country_name"</span><span class="p">)</span>
</pre></div>
</div>
<p>To run against all indexes attached to a specific table, you can either pass the table name to <code class="docutils literal notranslate"><span class="pre">db.analyze(...)</span></code> or you can call the method directly on the table, like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">[</span><span class="s2">"dogs"</span><span class="p">]</span><span class="o">.</span><span class="n">analyze</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="vacuum">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Vacuum"></a><span id="python-api-vacuum"></span><h2><a class="toc-backref" href="#id90" role="doc-backlink">Vacuum</a><a class="headerlink" href="#vacuum" title="Link to this heading">#</a></h2>
<p>You can optimize your database by running VACUUM against it like so:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Database</span><span class="p">(</span><span class="s2">"my_database.db"</span><span class="p">)</span><span class="o">.</span><span class="n">vacuum</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="wal-mode">
<a class="dashAnchor" name="//apple_ref/cpp/Section/WAL mode"></a><span id="python-api-wal"></span><h2><a class="toc-backref" href="#id91" role="doc-backlink">WAL mode</a><a class="headerlink" href="#wal-mode" title="Link to this heading">#</a></h2>
<p>You can enable <a class="reference external" href="https://www.sqlite.org/wal.html">Write-Ahead Logging</a> for a database with <code class="docutils literal notranslate"><span class="pre">.enable_wal()</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Database</span><span class="p">(</span><span class="s2">"my_database.db"</span><span class="p">)</span><span class="o">.</span><span class="n">enable_wal</span><span class="p">()</span>
</pre></div>
</div>
<p>You can disable WAL mode using <code class="docutils literal notranslate"><span class="pre">.disable_wal()</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Database</span><span class="p">(</span><span class="s2">"my_database.db"</span><span class="p">)</span><span class="o">.</span><span class="n">disable_wal</span><span class="p">()</span>
</pre></div>
</div>
<p>You can check the current journal mode for a database using the <code class="docutils literal notranslate"><span class="pre">journal_mode</span></code> property:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">journal_mode</span> <span class="o">=</span> <span class="n">Database</span><span class="p">(</span><span class="s2">"my_database.db"</span><span class="p">)</span><span class="o">.</span><span class="n">journal_mode</span>
</pre></div>
</div>
<p>This will usually be <code class="docutils literal notranslate"><span class="pre">wal</span></code> or <code class="docutils literal notranslate"><span class="pre">delete</span></code> (meaning WAL is disabled), but can have other values - see the <a class="reference external" href="https://www.sqlite.org/pragma.html#pragma_journal_mode">PRAGMA journal_mode</a> documentation.</p>
</section>
<section id="suggesting-column-types">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Suggesting column types"></a><span id="python-api-suggest-column-types"></span><h2><a class="toc-backref" href="#id92" role="doc-backlink">Suggesting column types</a><a class="headerlink" href="#suggesting-column-types" title="Link to this heading">#</a></h2>
<p>When you create a new table for a list of inserted or upserted Python dictionaries, those methods detect the correct types for the database columns based on the data you pass in.</p>
<p>In some situations you may need to intervene in this process, to customize the columns that are being created in some way - see <a class="reference internal" href="#python-api-explicit-create"><span class="std std-ref">Explicitly creating a table</span></a>.</p>
<p>That table <code class="docutils literal notranslate"><span class="pre">.create()</span></code> method takes a dictionary mapping column names to the Python type they should store:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">[</span><span class="s2">"cats"</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
    <span class="s2">"id"</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="s2">"name"</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s2">"weight"</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<span class="p">})</span>
</pre></div>
</div>
<p>You can use the <code class="docutils literal notranslate"><span class="pre">suggest_column_types()</span></code> helper function to derive a dictionary of column names and types from a list of records, suitable to be passed to <code class="docutils literal notranslate"><span class="pre">table.create()</span></code>.</p>
<p>For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlite_utils</span> <span class="kn">import</span> <span class="n">Database</span><span class="p">,</span> <span class="n">suggest_column_types</span>

<span class="n">cats</span> <span class="o">=</span> <span class="p">[{</span>
    <span class="s2">"id"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"Snowflake"</span>
<span class="p">},</span> <span class="p">{</span>
    <span class="s2">"id"</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"Crabtree"</span><span class="p">,</span>
    <span class="s2">"age"</span><span class="p">:</span> <span class="mi">4</span>
<span class="p">}]</span>
<span class="n">types</span> <span class="o">=</span> <span class="n">suggest_column_types</span><span class="p">(</span><span class="n">cats</span><span class="p">)</span>
<span class="c1"># types now looks like this:</span>
<span class="c1"># {"id": &lt;class 'int'&gt;,</span>
<span class="c1">#  "name": &lt;class 'str'&gt;,</span>
<span class="c1">#  "age": &lt;class 'int'&gt;}</span>

<span class="c1"># Manually add an extra field:</span>
<span class="n">types</span><span class="p">[</span><span class="s2">"thumbnail"</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bytes</span>
<span class="c1"># types now looks like this:</span>
<span class="c1"># {"id": &lt;class 'int'&gt;,</span>
<span class="c1">#  "name": &lt;class 'str'&gt;,</span>
<span class="c1">#  "age": &lt;class 'int'&gt;,</span>
<span class="c1">#  "thumbnail": &lt;class 'bytes'&gt;}</span>

<span class="c1"># Create the table</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">Database</span><span class="p">(</span><span class="s2">"cats.db"</span><span class="p">)</span>
<span class="n">db</span><span class="p">[</span><span class="s2">"cats"</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">types</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="s2">"id"</span><span class="p">)</span>
<span class="c1"># Insert the records</span>
<span class="n">db</span><span class="p">[</span><span class="s2">"cats"</span><span class="p">]</span><span class="o">.</span><span class="n">insert_all</span><span class="p">(</span><span class="n">cats</span><span class="p">)</span>

<span class="c1"># list(db["cats"].rows) now returns:</span>
<span class="c1"># [{"id": 1, "name": "Snowflake", "age": None, "thumbnail": None}</span>
<span class="c1">#  {"id": 2, "name": "Crabtree", "age": 4, "thumbnail": None}]</span>

<span class="c1"># The table schema looks like this:</span>
<span class="c1"># print(db["cats"].schema)</span>
<span class="c1"># CREATE TABLE [cats] (</span>
<span class="c1">#    [id] INTEGER PRIMARY KEY,</span>
<span class="c1">#    [name] TEXT,</span>
<span class="c1">#    [age] INTEGER,</span>
<span class="c1">#    [thumbnail] BLOB</span>
<span class="c1"># )</span>
</pre></div>
</div>
</section>
<section id="registering-custom-sql-functions">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Registering custom SQL functions"></a><span id="python-api-register-function"></span><h2><a class="toc-backref" href="#id93" role="doc-backlink">Registering custom SQL functions</a><a class="headerlink" href="#registering-custom-sql-functions" title="Link to this heading">#</a></h2>
<p>SQLite supports registering custom SQL functions written in Python. The <code class="docutils literal notranslate"><span class="pre">db.register_function()</span></code> method lets you register these functions, and keeps track of functions that have already been registered.</p>
<p>If you use it as a method it will automatically detect the name and number of arguments needed by the function:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlite_utils</span> <span class="kn">import</span> <span class="n">Database</span>

<span class="n">db</span> <span class="o">=</span> <span class="n">Database</span><span class="p">(</span><span class="n">memory</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">reverse_string</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">""</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>

<span class="n">db</span><span class="o">.</span><span class="n">register_function</span><span class="p">(</span><span class="n">reverse_string</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">'select reverse_string("hello")'</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
<span class="c1"># This prints "olleh"</span>
</pre></div>
</div>
<p>You can also use the method as a function decorator like so:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@db</span><span class="o">.</span><span class="n">register_function</span>
<span class="k">def</span> <span class="nf">reverse_string</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">""</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>

<span class="nb">print</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">'select reverse_string("hello")'</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
<p>By default, the name of the Python function will be used as the name of the SQL function. You can customize this with the <code class="docutils literal notranslate"><span class="pre">name=</span></code> keyword argument:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@db</span><span class="o">.</span><span class="n">register_function</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"rev"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">reverse_string</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">""</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>

<span class="nb">print</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">'select rev("hello")'</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
<p>Python 3.8 added the ability to register <a class="reference external" href="https://sqlite.org/deterministic.html">deterministic SQLite functions</a>, allowing you to indicate that a function will return the exact same result for any given inputs and hence allowing SQLite to apply some performance optimizations. You can mark a function as deterministic using <code class="docutils literal notranslate"><span class="pre">deterministic=True</span></code>, like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@db</span><span class="o">.</span><span class="n">register_function</span><span class="p">(</span><span class="n">deterministic</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">reverse_string</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">""</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>
</pre></div>
</div>
<p>If you run this on a version of Python prior to 3.8 your code will still work, but the <code class="docutils literal notranslate"><span class="pre">deterministic=True</span></code> parameter will be ignored.</p>
<p>By default registering a function with the same name and number of arguments will have no effect - the <code class="docutils literal notranslate"><span class="pre">Database</span></code> instance keeps track of functions that have already been registered and skips registering them if <code class="docutils literal notranslate"><span class="pre">@db.register_function</span></code> is called a second time.</p>
<p>If you want to deliberately replace the registered function with a new implementation, use the <code class="docutils literal notranslate"><span class="pre">replace=True</span></code> argument:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@db</span><span class="o">.</span><span class="n">register_function</span><span class="p">(</span><span class="n">deterministic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">reverse_string</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">s</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
<p>Exceptions that occur inside a user-defined function default to returning the following error:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Unexpected error: user-defined function raised exception
</pre></div>
</div>
<p>You can cause <code class="docutils literal notranslate"><span class="pre">sqlite3</span></code> to return more useful errors, including the traceback from the custom function, by executing the following before your custom functions are executed:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlite_utils.utils</span> <span class="kn">import</span> <span class="n">sqlite3</span>

<span class="n">sqlite3</span><span class="o">.</span><span class="n">enable_callback_tracebacks</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="quoting-strings-for-use-in-sql">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Quoting strings for use in SQL"></a><span id="python-api-quote"></span><h2><a class="toc-backref" href="#id94" role="doc-backlink">Quoting strings for use in SQL</a><a class="headerlink" href="#quoting-strings-for-use-in-sql" title="Link to this heading">#</a></h2>
<p>In almost all cases you should pass values to your SQL queries using the optional <code class="docutils literal notranslate"><span class="pre">parameters</span></code> argument to <code class="docutils literal notranslate"><span class="pre">db.query()</span></code>, as described in <a class="reference internal" href="#python-api-parameters"><span class="std std-ref">Passing parameters</span></a>.</p>
<p>If that option isn’t relevant to your use-case you can to quote a string for use with SQLite using the <code class="docutils literal notranslate"><span class="pre">db.quote()</span></code> method, like so:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt; db = Database(memory=True)
&gt;&gt;&gt; db.quote("hello")
"'hello'"
&gt;&gt;&gt; db.quote("hello'this'has'quotes")
"'hello''this''has''quotes'"
</pre></div>
</div>
</section>
<section id="reading-rows-from-a-file">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Reading rows from a file"></a><span id="python-api-rows-from-file"></span><h2><a class="toc-backref" href="#id95" role="doc-backlink">Reading rows from a file</a><a class="headerlink" href="#reading-rows-from-a-file" title="Link to this heading">#</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">sqlite_utils.utils.rows_from_file()</span></code> helper function can read rows (a sequence of dictionaries) from CSV, TSV, JSON or newline-delimited JSON files.</p>
<dl class="py function">
<dt class="sig sig-object py">
<span class="sig-prename descclassname"><span class="pre">sqlite_utils.utils.</span></span><span class="sig-name descname"><span class="pre">rows_from_file</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">fp</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">format</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">dialect</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">encoding</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">ignore_extras</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">extras_key</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="reference external" href="https://github.com/simonw/sqlite-utils/blob/88bd37220593f46ad2221601d6724dd0198400ad/sqlite_utils/utils.py#L235"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>Load a sequence of dictionaries from a file-like object containing one of four different formats.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlite_utils.utils</span> <span class="kn">import</span> <span class="n">rows_from_file</span>
<span class="kn">import</span> <span class="nn">io</span>

<span class="n">rows</span><span class="p">,</span> <span class="nb">format</span> <span class="o">=</span> <span class="n">rows_from_file</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="s2">"id,name</span><span class="se">\n</span><span class="s2">1,Cleo"</span><span class="p">)))</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">rows</span><span class="p">),</span> <span class="nb">format</span><span class="p">)</span>
<span class="c1"># Outputs [{'id': '1', 'name': 'Cleo'}] Format.CSV</span>
</pre></div>
</div>
<p>This defaults to attempting to automatically detect the format of the data, or you can pass in an
explicit format using the format= option.</p>
<p>Returns a tuple of <code class="docutils literal notranslate"><span class="pre">(rows_generator,</span> <span class="pre">format_used)</span></code> where <code class="docutils literal notranslate"><span class="pre">rows_generator</span></code> can be iterated over
to return dictionaries, while <code class="docutils literal notranslate"><span class="pre">format_used</span></code> is a value from the <code class="docutils literal notranslate"><span class="pre">sqlite_utils.utils.Format</span></code> enum:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Format</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">CSV</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">TSV</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">JSON</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">NL</span> <span class="o">=</span> <span class="mi">4</span>
</pre></div>
</div>
<p>If a CSV or TSV file includes rows with more fields than are declared in the header a
<code class="docutils literal notranslate"><span class="pre">sqlite_utils.utils.RowError</span></code> exception will be raised when you loop over the generator.</p>
<p>You can instead ignore the extra data by passing <code class="docutils literal notranslate"><span class="pre">ignore_extras=True</span></code>.</p>
<p>Or pass <code class="docutils literal notranslate"><span class="pre">extras_key="rest"</span></code> to put those additional values in a list in a key called <code class="docutils literal notranslate"><span class="pre">rest</span></code>.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>fp</strong> (<em>BinaryIO</em>) – a file-like object containing binary data</p></li>
<li><p><strong>format</strong> (<em>Format</em><em> | </em><em>None</em>) – the format to use - omit this to detect the format</p></li>
<li><p><strong>dialect</strong> (<em>Type</em><em>[</em><em>Dialect</em><em>] </em><em>| </em><em>None</em>) – the CSV dialect to use - omit this to detect the dialect</p></li>
<li><p><strong>encoding</strong> (<em>str</em><em> | </em><em>None</em>) – the character encoding to use when reading CSV/TSV data</p></li>
<li><p><strong>ignore_extras</strong> (<em>bool</em><em> | </em><em>None</em>) – ignore any extra fields on rows</p></li>
<li><p><strong>extras_key</strong> (<em>str</em><em> | </em><em>None</em>) – put any extra fields in a list with this key</p></li>
</ul>
</dd>
<dt class="field-even">Return type<span class="colon">:</span></dt>
<dd class="field-even"><p><em>Tuple</em>[<em>Iterable</em>[dict], <em>Format</em>]</p>
</dd>
</dl>
</dd></dl>
</section>
<section id="setting-the-maximum-csv-field-size-limit">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Setting the maximum CSV field size limit"></a><span id="python-api-maximize-csv-field-size-limit"></span><h2><a class="toc-backref" href="#id96" role="doc-backlink">Setting the maximum CSV field size limit</a><a class="headerlink" href="#setting-the-maximum-csv-field-size-limit" title="Link to this heading">#</a></h2>
<p>Sometimes when working with CSV files that include extremely long fields you may see an error that looks like this:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>_csv.Error: field larger than field limit (131072)
</pre></div>
</div>
<p>The Python standard library <code class="docutils literal notranslate"><span class="pre">csv</span></code> module enforces a field size limit. You can increase that limit using the <code class="docutils literal notranslate"><span class="pre">csv.field_size_limit(new_limit)</span></code> method (<a class="reference external" href="https://docs.python.org/3/library/csv.html#csv.field_size_limit">documented here</a>) but if you don’t want to pick a new level you may instead want to increase it to the maximum possible.</p>
<p>The maximum possible value for this is not documented, and varies between systems.</p>
<p>Calling <code class="docutils literal notranslate"><span class="pre">sqlite_utils.utils.maximize_csv_field_size_limit()</span></code> will set the value to the highest possible for the current system:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlite_utils.utils</span> <span class="kn">import</span> <span class="n">maximize_csv_field_size_limit</span>

<span class="n">maximize_csv_field_size_limit</span><span class="p">()</span>
</pre></div>
</div>
<p>If you need to reset to the original value after calling this function you can do so like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlite_utils.utils</span> <span class="kn">import</span> <span class="n">ORIGINAL_CSV_FIELD_SIZE_LIMIT</span>
<span class="kn">import</span> <span class="nn">csv</span>

<span class="n">csv</span><span class="o">.</span><span class="n">field_size_limit</span><span class="p">(</span><span class="n">ORIGINAL_CSV_FIELD_SIZE_LIMIT</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="detecting-column-types-using-typetracker">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Detecting column types using TypeTracker"></a><span id="python-api-typetracker"></span><h2><a class="toc-backref" href="#id97" role="doc-backlink">Detecting column types using TypeTracker</a><a class="headerlink" href="#detecting-column-types-using-typetracker" title="Link to this heading">#</a></h2>
<p>Sometimes you may find yourself working with data that lacks type information - data from a CSV file for example.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">TypeTracker</span></code> class can be used to try to automatically identify the most likely types for data that is initially represented as strings.</p>
<p>Consider this example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">csv</span><span class="o">,</span> <span class="nn">io</span>

<span class="n">csv_file</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="s2">"id,name</span><span class="se">\n</span><span class="s2">1,Cleo</span><span class="se">\n</span><span class="s2">2,Cardi"</span><span class="p">)</span>
<span class="n">rows</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">csv</span><span class="o">.</span><span class="n">DictReader</span><span class="p">(</span><span class="n">csv_file</span><span class="p">))</span>

<span class="c1"># rows is now this:</span>
<span class="c1"># [{'id': '1', 'name': 'Cleo'}, {'id': '2', 'name': 'Cardi'}]</span>
</pre></div>
</div>
<p>If we insert this data directly into a table we will get a schema that is entirely <code class="docutils literal notranslate"><span class="pre">TEXT</span></code> columns:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlite_utils</span> <span class="kn">import</span> <span class="n">Database</span>

<span class="n">db</span> <span class="o">=</span> <span class="n">Database</span><span class="p">(</span><span class="n">memory</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">db</span><span class="p">[</span><span class="s2">"creatures"</span><span class="p">]</span><span class="o">.</span><span class="n">insert_all</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">schema</span><span class="p">)</span>
<span class="c1"># Outputs:</span>
<span class="c1"># CREATE TABLE [creatures] (</span>
<span class="c1">#    [id] TEXT,</span>
<span class="c1">#    [name] TEXT</span>
<span class="c1"># );</span>
</pre></div>
</div>
<p>We can detect the best column types using a <code class="docutils literal notranslate"><span class="pre">TypeTracker</span></code> instance:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlite_utils.utils</span> <span class="kn">import</span> <span class="n">TypeTracker</span>

<span class="n">tracker</span> <span class="o">=</span> <span class="n">TypeTracker</span><span class="p">()</span>
<span class="n">db</span><span class="p">[</span><span class="s2">"creatures2"</span><span class="p">]</span><span class="o">.</span><span class="n">insert_all</span><span class="p">(</span><span class="n">tracker</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="n">rows</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tracker</span><span class="o">.</span><span class="n">types</span><span class="p">)</span>
<span class="c1"># Outputs {'id': 'integer', 'name': 'text'}</span>
</pre></div>
</div>
<p>We can then apply those types to our new table using the <a class="reference internal" href="#python-api-transform"><span class="std std-ref">table.transform()</span></a> method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">[</span><span class="s2">"creatures2"</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">types</span><span class="o">=</span><span class="n">tracker</span><span class="o">.</span><span class="n">types</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">db</span><span class="p">[</span><span class="s2">"creatures2"</span><span class="p">]</span><span class="o">.</span><span class="n">schema</span><span class="p">)</span>
<span class="c1"># Outputs:</span>
<span class="c1"># CREATE TABLE [creatures2] (</span>
<span class="c1">#    [id] INTEGER,</span>
<span class="c1">#    [name] TEXT</span>
<span class="c1"># );</span>
</pre></div>
</div>
</section>
<section id="spatialite-helpers">
<a class="dashAnchor" name="//apple_ref/cpp/Section/SpatiaLite helpers"></a><span id="python-api-gis"></span><h2><a class="toc-backref" href="#id98" role="doc-backlink">SpatiaLite helpers</a><a class="headerlink" href="#spatialite-helpers" title="Link to this heading">#</a></h2>
<p><a class="reference external" href="https://www.gaia-gis.it/fossil/libspatialite/index">SpatiaLite</a> is a geographic extension to SQLite (similar to PostgreSQL + PostGIS). Using requires finding, loading and initializing the extension, adding geometry columns to existing tables and optionally creating spatial indexes. The utilities here help streamline that setup.</p>
<section id="initialize-spatialite">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Initialize SpatiaLite"></a><span id="python-api-gis-init-spatialite"></span><h3><a class="toc-backref" href="#id99" role="doc-backlink">Initialize SpatiaLite</a><a class="headerlink" href="#initialize-spatialite" title="Link to this heading">#</a></h3>
<dl class="py method">
<dt class="sig sig-object py">
<span class="sig-prename descclassname"><span class="pre">Database.</span></span><span class="sig-name descname"><span class="pre">init_spatialite</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">path</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="reference external" href="https://github.com/simonw/sqlite-utils/blob/88bd37220593f46ad2221601d6724dd0198400ad/sqlite_utils/db.py#L1216"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>The <code class="docutils literal notranslate"><span class="pre">init_spatialite</span></code> method will load and initialize the SpatiaLite extension.
The <code class="docutils literal notranslate"><span class="pre">path</span></code> argument should be an absolute path to the compiled extension, which
can be found using <code class="docutils literal notranslate"><span class="pre">find_spatialite</span></code>.</p>
<p>Returns <code class="docutils literal notranslate"><span class="pre">True</span></code> if SpatiaLite was successfully initialized.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlite_utils.db</span> <span class="kn">import</span> <span class="n">Database</span>
<span class="kn">from</span> <span class="nn">sqlite_utils.utils</span> <span class="kn">import</span> <span class="n">find_spatialite</span>

<span class="n">db</span> <span class="o">=</span> <span class="n">Database</span><span class="p">(</span><span class="s2">"mydb.db"</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">init_spatialite</span><span class="p">(</span><span class="n">find_spatialite</span><span class="p">())</span>
</pre></div>
</div>
<p>If you’ve installed SpatiaLite somewhere unexpected (for testing an alternate version, for example)
you can pass in an absolute path:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlite_utils.db</span> <span class="kn">import</span> <span class="n">Database</span>
<span class="kn">from</span> <span class="nn">sqlite_utils.utils</span> <span class="kn">import</span> <span class="n">find_spatialite</span>

<span class="n">db</span> <span class="o">=</span> <span class="n">Database</span><span class="p">(</span><span class="s2">"mydb.db"</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">init_spatialite</span><span class="p">(</span><span class="s2">"./local/mod_spatialite.dylib"</span><span class="p">)</span>
</pre></div>
</div>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>path</strong> (<em>str</em><em> | </em><em>None</em>) – Path to SpatiaLite module on disk</p>
</dd>
<dt class="field-even">Return type<span class="colon">:</span></dt>
<dd class="field-even"><p>bool</p>
</dd>
</dl>
</dd></dl>
</section>
<section id="finding-spatialite">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Finding SpatiaLite"></a><span id="python-api-gis-find-spatialite"></span><h3><a class="toc-backref" href="#id100" role="doc-backlink">Finding SpatiaLite</a><a class="headerlink" href="#finding-spatialite" title="Link to this heading">#</a></h3>
<dl class="py function">
<dt class="sig sig-object py" id="sqlite_utils.utils.find_spatialite">
<span class="sig-prename descclassname"><span class="pre">sqlite_utils.utils.</span></span><span class="sig-name descname"><span class="pre">find_spatialite</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference external" href="https://github.com/simonw/sqlite-utils/blob/88bd37220593f46ad2221601d6724dd0198400ad/sqlite_utils/utils.py#L60"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="dashAnchor" name="//apple_ref/cpp/Function/sqlite_utils.utils.find_spatialite"></a><a class="headerlink" href="#sqlite_utils.utils.find_spatialite" title="Link to this definition">#</a></dt>
<dd><p>The <code class="docutils literal notranslate"><span class="pre">find_spatialite()</span></code> function searches for the <a class="reference external" href="https://www.gaia-gis.it/fossil/libspatialite/index">SpatiaLite</a>
SQLite extension in some common places. It returns a string path to the location, or <code class="docutils literal notranslate"><span class="pre">None</span></code> if SpatiaLite was not found.</p>
<p>You can use it in code like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlite_utils</span> <span class="kn">import</span> <span class="n">Database</span>
<span class="kn">from</span> <span class="nn">sqlite_utils.utils</span> <span class="kn">import</span> <span class="n">find_spatialite</span>

<span class="n">db</span> <span class="o">=</span> <span class="n">Database</span><span class="p">(</span><span class="s2">"mydb.db"</span><span class="p">)</span>
<span class="n">spatialite</span> <span class="o">=</span> <span class="n">find_spatialite</span><span class="p">()</span>
<span class="k">if</span> <span class="n">spatialite</span><span class="p">:</span>
    <span class="n">db</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">enable_load_extension</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">load_extension</span><span class="p">(</span><span class="n">spatialite</span><span class="p">)</span>

<span class="c1"># or use with db.init_spatialite like this</span>
<span class="n">db</span><span class="o">.</span><span class="n">init_spatialite</span><span class="p">(</span><span class="n">find_spatialite</span><span class="p">())</span>
</pre></div>
</div>
<dl class="field-list simple">
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>str | None</p>
</dd>
</dl>
</dd></dl>
</section>
<section id="adding-geometry-columns">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Adding geometry columns"></a><span id="python-api-gis-add-geometry-column"></span><h3><a class="toc-backref" href="#id101" role="doc-backlink">Adding geometry columns</a><a class="headerlink" href="#adding-geometry-columns" title="Link to this heading">#</a></h3>
<dl class="py method">
<dt class="sig sig-object py">
<span class="sig-prename descclassname"><span class="pre">Table.</span></span><span class="sig-name descname"><span class="pre">add_geometry_column</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">column_name</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">geometry_type</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">srid</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">4326</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">coord_dimension</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'XY'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">not_null</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span><a class="reference external" href="https://github.com/simonw/sqlite-utils/blob/88bd37220593f46ad2221601d6724dd0198400ad/sqlite_utils/db.py#L3640"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>In SpatiaLite, a geometry column can only be added to an existing table.
To do so, use <code class="docutils literal notranslate"><span class="pre">table.add_geometry_column</span></code>, passing in a geometry type.</p>
<p>By default, this will add a nullable column using
<a class="reference external" href="https://spatialreference.org/ref/epsg/wgs-84/">SRID 4326</a>. This can
be customized using the <code class="docutils literal notranslate"><span class="pre">column_name</span></code>, <code class="docutils literal notranslate"><span class="pre">srid</span></code> and <code class="docutils literal notranslate"><span class="pre">not_null</span></code> arguments.</p>
<p>Returns <code class="docutils literal notranslate"><span class="pre">True</span></code> if the column was successfully added, <code class="docutils literal notranslate"><span class="pre">False</span></code> if not.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlite_utils.db</span> <span class="kn">import</span> <span class="n">Database</span>
<span class="kn">from</span> <span class="nn">sqlite_utils.utils</span> <span class="kn">import</span> <span class="n">find_spatialite</span>

<span class="n">db</span> <span class="o">=</span> <span class="n">Database</span><span class="p">(</span><span class="s2">"mydb.db"</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">init_spatialite</span><span class="p">(</span><span class="n">find_spatialite</span><span class="p">())</span>

<span class="c1"># the table must exist before adding a geometry column</span>
<span class="n">table</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="s2">"locations"</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s2">"name"</span><span class="p">:</span> <span class="nb">str</span><span class="p">})</span>
<span class="n">table</span><span class="o">.</span><span class="n">add_geometry_column</span><span class="p">(</span><span class="s2">"geometry"</span><span class="p">,</span> <span class="s2">"POINT"</span><span class="p">)</span>
</pre></div>
</div>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>column_name</strong> (<em>str</em>) – Name of column to add</p></li>
<li><p><strong>geometry_type</strong> (<em>str</em>) – Type of geometry column, for example <code class="docutils literal notranslate"><span class="pre">"GEOMETRY"</span></code> or <code class="docutils literal notranslate"><span class="pre">"POINT"</span> <span class="pre">or</span> <span class="pre">``"POLYGON"</span></code></p></li>
<li><p><strong>srid</strong> (<em>int</em>) – Integer SRID, defaults to 4326 for WGS84</p></li>
<li><p><strong>coord_dimension</strong> (<em>str</em>) – Dimensions to use, defaults to <code class="docutils literal notranslate"><span class="pre">"XY"</span></code> - set to <code class="docutils literal notranslate"><span class="pre">"XYZ"</span></code> to work in three dimensions</p></li>
<li><p><strong>not_null</strong> (<em>bool</em>) – Should the column be <code class="docutils literal notranslate"><span class="pre">NOT</span> <span class="pre">NULL</span></code></p></li>
</ul>
</dd>
<dt class="field-even">Return type<span class="colon">:</span></dt>
<dd class="field-even"><p>bool</p>
</dd>
</dl>
</dd></dl>
</section>
<section id="creating-a-spatial-index">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Creating a spatial index"></a><span id="python-api-gis-create-spatial-index"></span><h3><a class="toc-backref" href="#id102" role="doc-backlink">Creating a spatial index</a><a class="headerlink" href="#creating-a-spatial-index" title="Link to this heading">#</a></h3>
<dl class="py method">
<dt class="sig sig-object py">
<span class="sig-prename descclassname"><span class="pre">Table.</span></span><span class="sig-name descname"><span class="pre">create_spatial_index</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">column_name</span></span></em><span class="sig-paren">)</span><a class="reference external" href="https://github.com/simonw/sqlite-utils/blob/88bd37220593f46ad2221601d6724dd0198400ad/sqlite_utils/db.py#L3691"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>A spatial index allows for significantly faster bounding box queries.
To create one, use <code class="docutils literal notranslate"><span class="pre">create_spatial_index</span></code> with the name of an existing geometry column.</p>
<p>Returns <code class="docutils literal notranslate"><span class="pre">True</span></code> if the index was successfully created, <code class="docutils literal notranslate"><span class="pre">False</span></code> if not. Calling this
function if an index already exists is a no-op.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># assuming SpatiaLite is loaded, create the table, add the column</span>
<span class="n">table</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="s2">"locations"</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s2">"name"</span><span class="p">:</span> <span class="nb">str</span><span class="p">})</span>
<span class="n">table</span><span class="o">.</span><span class="n">add_geometry_column</span><span class="p">(</span><span class="s2">"geometry"</span><span class="p">,</span> <span class="s2">"POINT"</span><span class="p">)</span>

<span class="c1"># now we can index it</span>
<span class="n">table</span><span class="o">.</span><span class="n">create_spatial_index</span><span class="p">(</span><span class="s2">"geometry"</span><span class="p">)</span>

<span class="c1"># the spatial index is a virtual table, which we can inspect</span>
<span class="nb">print</span><span class="p">(</span><span class="n">db</span><span class="p">[</span><span class="s2">"idx_locations_geometry"</span><span class="p">]</span><span class="o">.</span><span class="n">schema</span><span class="p">)</span>
<span class="c1"># outputs:</span>
<span class="c1"># CREATE VIRTUAL TABLE "idx_locations_geometry" USING rtree(pkid, xmin, xmax, ymin, ymax)</span>
</pre></div>
</div>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>column_name</strong> – Geometry column to create the spatial index against</p>
</dd>
<dt class="field-even">Return type<span class="colon">:</span></dt>
<dd class="field-even"><p>bool</p>
</dd>
</dl>
</dd></dl>
</section>
</section>
</section>
</article>
</div>
<footer>
<div class="related-pages">
<a class="next-page" href="plugins.html">
<div class="page-info">
<div class="context">
<span>Next</span>
</div>
<div class="title">Plugins</div>
</div>
<svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
</a>
<a class="prev-page" href="cli.html">
<svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
<div class="page-info">
<div class="context">
<span>Previous</span>
</div>
<div class="title">sqlite-utils command-line tool</div>
</div>
</a>
</div>
<div class="bottom-of-page">
<div class="left-details">
<div class="copyright">
                Copyright © 2018-2022, Simon Willison
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
</div>
<div class="right-details">
</div>
</div>
</footer>
</div>
<aside class="toc-drawer">
<div class="toc-sticky toc-scroll">
<div class="toc-title-container">
<span class="toc-title">
            On this page
          </span>
</div>
<div class="toc-tree-container">
<div class="toc-tree">
<ul>
<li><a class="reference internal" href="#">sqlite_utils Python library</a><ul>
<li><a class="reference internal" href="#getting-started">Getting started</a></li>
<li><a class="reference internal" href="#connecting-to-or-creating-a-database">Connecting to or creating a database</a><ul>
<li><a class="reference internal" href="#attaching-additional-databases">Attaching additional databases</a></li>
<li><a class="reference internal" href="#tracing-queries">Tracing queries</a></li>
</ul>
</li>
<li><a class="reference internal" href="#executing-queries">Executing queries</a><ul>
<li><a class="reference internal" href="#db-query-sql-params">db.query(sql, params)</a></li>
<li><a class="reference internal" href="#db-execute-sql-params">db.execute(sql, params)</a></li>
<li><a class="reference internal" href="#passing-parameters">Passing parameters</a></li>
</ul>
</li>
<li><a class="reference internal" href="#accessing-tables">Accessing tables</a></li>
<li><a class="reference internal" href="#listing-tables">Listing tables</a></li>
<li><a class="reference internal" href="#listing-views">Listing views</a></li>
<li><a class="reference internal" href="#listing-rows">Listing rows</a><ul>
<li><a class="reference internal" href="#counting-rows">Counting rows</a></li>
</ul>
</li>
<li><a class="reference internal" href="#listing-rows-with-their-primary-keys">Listing rows with their primary keys</a></li>
<li><a class="reference internal" href="#retrieving-a-specific-record">Retrieving a specific record</a></li>
<li><a class="reference internal" href="#showing-the-schema">Showing the schema</a></li>
<li><a class="reference internal" href="#creating-tables">Creating tables</a><ul>
<li><a class="reference internal" href="#custom-column-order-and-column-types">Custom column order and column types</a></li>
<li><a class="reference internal" href="#explicitly-creating-a-table">Explicitly creating a table</a></li>
<li><a class="reference internal" href="#compound-primary-keys">Compound primary keys</a></li>
<li><a class="reference internal" href="#specifying-foreign-keys">Specifying foreign keys</a></li>
<li><a class="reference internal" href="#table-configuration-options">Table configuration options</a></li>
<li><a class="reference internal" href="#setting-defaults-and-not-null-constraints">Setting defaults and not null constraints</a></li>
</ul>
</li>
<li><a class="reference internal" href="#renaming-a-table">Renaming a table</a></li>
<li><a class="reference internal" href="#duplicating-tables">Duplicating tables</a></li>
<li><a class="reference internal" href="#bulk-inserts">Bulk inserts</a></li>
<li><a class="reference internal" href="#insert-replacing-data">Insert-replacing data</a></li>
<li><a class="reference internal" href="#updating-a-specific-record">Updating a specific record</a></li>
<li><a class="reference internal" href="#deleting-a-specific-record">Deleting a specific record</a></li>
<li><a class="reference internal" href="#deleting-multiple-records">Deleting multiple records</a></li>
<li><a class="reference internal" href="#upserting-data">Upserting data</a></li>
<li><a class="reference internal" href="#converting-data-in-columns">Converting data in columns</a></li>
<li><a class="reference internal" href="#working-with-lookup-tables">Working with lookup tables</a><ul>
<li><a class="reference internal" href="#creating-lookup-tables-explicitly">Creating lookup tables explicitly</a></li>
<li><a class="reference internal" href="#populating-lookup-tables-automatically-during-insert-upsert">Populating lookup tables automatically during insert/upsert</a></li>
</ul>
</li>
<li><a class="reference internal" href="#working-with-many-to-many-relationships">Working with many-to-many relationships</a><ul>
<li><a class="reference internal" href="#using-m2m-and-lookup-tables-together">Using m2m and lookup tables together</a></li>
</ul>
</li>
<li><a class="reference internal" href="#analyzing-a-column">Analyzing a column</a></li>
<li><a class="reference internal" href="#adding-columns">Adding columns</a></li>
<li><a class="reference internal" href="#adding-columns-automatically-on-insert-update">Adding columns automatically on insert/update</a></li>
<li><a class="reference internal" href="#adding-foreign-key-constraints">Adding foreign key constraints</a><ul>
<li><a class="reference internal" href="#adding-multiple-foreign-key-constraints-at-once">Adding multiple foreign key constraints at once</a></li>
<li><a class="reference internal" href="#adding-indexes-for-all-foreign-keys">Adding indexes for all foreign keys</a></li>
</ul>
</li>
<li><a class="reference internal" href="#dropping-a-table-or-view">Dropping a table or view</a></li>
<li><a class="reference internal" href="#transforming-a-table">Transforming a table</a><ul>
<li><a class="reference internal" href="#altering-column-types">Altering column types</a></li>
<li><a class="reference internal" href="#renaming-columns">Renaming columns</a></li>
<li><a class="reference internal" href="#dropping-columns">Dropping columns</a></li>
<li><a class="reference internal" href="#changing-primary-keys">Changing primary keys</a></li>
<li><a class="reference internal" href="#changing-not-null-status">Changing not null status</a></li>
<li><a class="reference internal" href="#altering-column-defaults">Altering column defaults</a></li>
<li><a class="reference internal" href="#changing-column-order">Changing column order</a></li>
<li><a class="reference internal" href="#dropping-foreign-key-constraints">Dropping foreign key constraints</a></li>
<li><a class="reference internal" href="#custom-transformations-with-transform-sql">Custom transformations with .transform_sql()</a></li>
</ul>
</li>
<li><a class="reference internal" href="#extracting-columns-into-a-separate-table">Extracting columns into a separate table</a></li>
<li><a class="reference internal" href="#setting-an-id-based-on-the-hash-of-the-row-contents">Setting an ID based on the hash of the row contents</a></li>
<li><a class="reference internal" href="#creating-views">Creating views</a></li>
<li><a class="reference internal" href="#storing-json">Storing JSON</a></li>
<li><a class="reference internal" href="#converting-column-values-using-sql-functions">Converting column values using SQL functions</a></li>
<li><a class="reference internal" href="#checking-the-sqlite-version">Checking the SQLite version</a></li>
<li><a class="reference internal" href="#dumping-the-database-to-sql">Dumping the database to SQL</a></li>
<li><a class="reference internal" href="#introspecting-tables-and-views">Introspecting tables and views</a><ul>
<li><a class="reference internal" href="#exists">.exists()</a></li>
<li><a class="reference internal" href="#count">.count</a></li>
<li><a class="reference internal" href="#columns">.columns</a></li>
<li><a class="reference internal" href="#columns-dict">.columns_dict</a></li>
<li><a class="reference internal" href="#default-values">.default_values</a></li>
<li><a class="reference internal" href="#pks">.pks</a></li>
<li><a class="reference internal" href="#use-rowid">.use_rowid</a></li>
<li><a class="reference internal" href="#foreign-keys">.foreign_keys</a></li>
<li><a class="reference internal" href="#schema">.schema</a></li>
<li><a class="reference internal" href="#strict">.strict</a></li>
<li><a class="reference internal" href="#indexes">.indexes</a></li>
<li><a class="reference internal" href="#xindexes">.xindexes</a></li>
<li><a class="reference internal" href="#triggers">.triggers</a></li>
<li><a class="reference internal" href="#triggers-dict">.triggers_dict</a></li>
<li><a class="reference internal" href="#detect-fts">.detect_fts()</a></li>
<li><a class="reference internal" href="#virtual-table-using">.virtual_table_using</a></li>
<li><a class="reference internal" href="#has-counts-triggers">.has_counts_triggers</a></li>
</ul>
</li>
<li><a class="reference internal" href="#full-text-search">Full-text search</a><ul>
<li><a class="reference internal" href="#enabling-full-text-search-for-a-table">Enabling full-text search for a table</a></li>
<li><a class="reference internal" href="#quoting-characters-for-use-in-search">Quoting characters for use in search</a></li>
<li><a class="reference internal" href="#searching-with-table-search">Searching with table.search()</a></li>
<li><a class="reference internal" href="#building-sql-queries-with-table-search-sql">Building SQL queries with table.search_sql()</a></li>
</ul>
</li>
<li><a class="reference internal" href="#rebuilding-a-full-text-search-table">Rebuilding a full-text search table</a></li>
<li><a class="reference internal" href="#optimizing-a-full-text-search-table">Optimizing a full-text search table</a></li>
<li><a class="reference internal" href="#cached-table-counts-using-triggers">Cached table counts using triggers</a></li>
<li><a class="reference internal" href="#creating-indexes">Creating indexes</a></li>
<li><a class="reference internal" href="#optimizing-index-usage-with-analyze">Optimizing index usage with ANALYZE</a></li>
<li><a class="reference internal" href="#vacuum">Vacuum</a></li>
<li><a class="reference internal" href="#wal-mode">WAL mode</a></li>
<li><a class="reference internal" href="#suggesting-column-types">Suggesting column types</a></li>
<li><a class="reference internal" href="#registering-custom-sql-functions">Registering custom SQL functions</a></li>
<li><a class="reference internal" href="#quoting-strings-for-use-in-sql">Quoting strings for use in SQL</a></li>
<li><a class="reference internal" href="#reading-rows-from-a-file">Reading rows from a file</a></li>
<li><a class="reference internal" href="#setting-the-maximum-csv-field-size-limit">Setting the maximum CSV field size limit</a></li>
<li><a class="reference internal" href="#detecting-column-types-using-typetracker">Detecting column types using TypeTracker</a></li>
<li><a class="reference internal" href="#spatialite-helpers">SpatiaLite helpers</a><ul>
<li><a class="reference internal" href="#initialize-spatialite">Initialize SpatiaLite</a></li>
<li><a class="reference internal" href="#finding-spatialite">Finding SpatiaLite</a><ul>
<li><a class="reference internal" href="#sqlite_utils.utils.find_spatialite"><code class="docutils literal notranslate"><span class="pre">find_spatialite()</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#adding-geometry-columns">Adding geometry columns</a></li>
<li><a class="reference internal" href="#creating-a-spatial-index">Creating a spatial index</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
</div>
</aside>
</div>
</div>
<script src="_static/documentation_options.js?v=aeb06d4f"></script>
<script src="_static/doctools.js?v=888ff710"></script>
<script src="_static/sphinx_highlight.js?v=dc90522c"></script>
<script src="_static/scripts/furo.js?v=32e29ea5"></script>
<script src="_static/clipboard.min.js?v=a7894cd8"></script>
<script src="_static/copybutton.js?v=f281be69"></script>
<script src="_static/js/custom.js?v=6323a214"></script>
<style type="text/css">
.highlight-output .highlight {
  border-left: 9px solid #30c94f;
}
</style>
<script>
document.addEventListener("DOMContentLoaded", function() {
  // Show banner linking to /stable/ if this is a /latest/ page
  if (!/\/latest\//.test(location.pathname)) {
    return;
  }
  var stableUrl = location.pathname.replace("/latest/", "/stable/");
  // Check it's not a 404
  fetch(stableUrl, { method: "HEAD" }).then((response) => {
    if (response.status === 200) {
      var warning = document.createElement("div");
      warning.className = "admonition warning";
      warning.innerHTML = `
        <p class="first admonition-title">Note</p>
        <p class="last">
          This documentation covers the <strong>development version</strong> of Datasette.
        </p>
        <p>
          See <a href="${stableUrl}">this page</a> for the current stable release.
        </p>
      `;
      var mainArticle = document.querySelector("article[role=main]");
      mainArticle.insertBefore(warning, mainArticle.firstChild);
    }
  });
});
</script>
</body>
</html>